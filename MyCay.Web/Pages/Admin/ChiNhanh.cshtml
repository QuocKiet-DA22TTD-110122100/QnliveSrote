@page
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Chi nh√°nh";
    Layout = "_AdminLayout";
}

<div class="admin-header">
    <h1>üè™ Qu·∫£n l√Ω Chi nh√°nh</h1>
    <button class="btn btn-primary" onclick="showAddModal()">
        <i class="fas fa-plus"></i> Th√™m chi nh√°nh
    </button>
</div>

<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon" style="background: #10b981;">üè™</div>
        <div class="stat-info">
            <span class="stat-value" id="totalBranches">0</span>
            <span class="stat-label">T·ªïng chi nh√°nh</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #3b82f6;">üë•</div>
        <div class="stat-info">
            <span class="stat-value" id="totalStaff">0</span>
            <span class="stat-label">T·ªïng nh√¢n vi√™n</span>
        </div>
    </div>
</div>

<div class="data-table-container">
    <table class="data-table" id="branchTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n chi nh√°nh</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Qu·∫≠n/Huy·ªán</th>
                <th>SƒêT</th>
                <th>Gi·ªù m·ªü c·ª≠a</th>
                <th>Nh√¢n vi√™n</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="branchTableBody">
            <tr><td colspan="8" class="loading">ƒêang t·∫£i...</td></tr>
        </tbody>
    </table>
</div>

<!-- Modal Th√™m/S·ª≠a -->
<div class="modal-overlay" id="branchModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Th√™m chi nh√°nh</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="branchForm" onsubmit="saveBranch(event)">
            <input type="hidden" id="branchId">
            <div class="form-row">
                <div class="form-group">
                    <label>T√™n chi nh√°nh *</label>
                    <input type="text" id="tenChiNhanh" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="diaChi">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Qu·∫≠n/Huy·ªán</label>
                    <input type="text" id="quanHuyen">
                </div>
                <div class="form-group">
                    <label>Th√†nh ph·ªë</label>
                    <input type="text" id="thanhPho" value="TP.HCM">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" id="soDienThoai">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Gi·ªù m·ªü c·ª≠a</label>
                    <input type="text" id="gioMoCua" value="10:00">
                </div>
                <div class="form-group">
                    <label>Gi·ªù ƒë√≥ng c·ª≠a</label>
                    <input type="text" id="gioDongCua" value="22:00">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script>
let branches = [];

async function loadBranches() {
    try {
        const res = await fetch('/api/branch');
        branches = await res.json();
        renderTable();
        updateStats();
    } catch (e) {
        console.error('Error:', e);
    }
}

function renderTable() {
    const tbody = document.getElementById('branchTableBody');
    if (branches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">Ch∆∞a c√≥ chi nh√°nh n√†o</td></tr>';
        return;
    }
    
    tbody.innerHTML = branches.map(b => `
        <tr>
            <td>${b.maCN}</td>
            <td><strong>${b.tenChiNhanh}</strong></td>
            <td>${b.diaChi || '-'}</td>
            <td>${b.quanHuyen || '-'}</td>
            <td>${b.soDienThoai || '-'}</td>
            <td>${b.gioMoCua} - ${b.gioDongCua}</td>
            <td><span class="badge">${b.soNhanVien} ng∆∞·ªùi</span></td>
            <td>
                <button class="btn-icon" onclick="editBranch(${b.maCN})" title="S·ª≠a">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-danger" onclick="deleteBranch(${b.maCN})" title="X√≥a">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updateStats() {
    document.getElementById('totalBranches').textContent = branches.length;
    const totalStaff = branches.reduce((sum, b) => sum + b.soNhanVien, 0);
    document.getElementById('totalStaff').textContent = totalStaff;
}

function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Th√™m chi nh√°nh';
    document.getElementById('branchForm').reset();
    document.getElementById('branchId').value = '';
    document.getElementById('thanhPho').value = 'TP.HCM';
    document.getElementById('gioMoCua').value = '10:00';
    document.getElementById('gioDongCua').value = '22:00';
    document.getElementById('branchModal').classList.add('active');
}

async function editBranch(id) {
    const branch = branches.find(b => b.maCN === id);
    if (!branch) return;
    
    document.getElementById('modalTitle').textContent = 'S·ª≠a chi nh√°nh';
    document.getElementById('branchId').value = id;
    document.getElementById('tenChiNhanh').value = branch.tenChiNhanh;
    document.getElementById('diaChi').value = branch.diaChi || '';
    document.getElementById('quanHuyen').value = branch.quanHuyen || '';
    document.getElementById('thanhPho').value = branch.thanhPho || 'TP.HCM';
    document.getElementById('soDienThoai').value = branch.soDienThoai || '';
    document.getElementById('email').value = branch.email || '';
    document.getElementById('gioMoCua').value = branch.gioMoCua || '10:00';
    document.getElementById('gioDongCua').value = branch.gioDongCua || '22:00';
    document.getElementById('branchModal').classList.add('active');
}

async function saveBranch(e) {
    e.preventDefault();
    const id = document.getElementById('branchId').value;
    const data = {
        tenChiNhanh: document.getElementById('tenChiNhanh').value,
        diaChi: document.getElementById('diaChi').value,
        quanHuyen: document.getElementById('quanHuyen').value,
        thanhPho: document.getElementById('thanhPho').value,
        soDienThoai: document.getElementById('soDienThoai').value,
        email: document.getElementById('email').value,
        gioMoCua: document.getElementById('gioMoCua').value,
        gioDongCua: document.getElementById('gioDongCua').value,
        trangThai: true
    };
    
    const url = id ? `/api/branch/${id}` : '/api/branch';
    const method = id ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (res.ok) {
        closeModal();
        loadBranches();
        alert(id ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m chi nh√°nh th√†nh c√¥ng!');
    }
}

async function deleteBranch(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi nh√°nh n√†y?')) return;
    
    const res = await fetch(`/api/branch/${id}`, { method: 'DELETE' });
    if (res.ok) {
        loadBranches();
        alert('ƒê√£ x√≥a chi nh√°nh!');
    }
}

function closeModal() {
    document.getElementById('branchModal').classList.remove('active');
}

loadBranches();
</script>
}
