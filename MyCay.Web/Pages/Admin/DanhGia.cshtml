@page
@model AdminDanhGiaModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω ƒë√°nh gi√°";
    Layout = "_AdminLayout";
}

<div class="admin-header">
    <h1>‚≠ê Qu·∫£n l√Ω ƒë√°nh gi√°</h1>
    <p>Xem v√† ph·∫£n h·ªìi ƒë√°nh gi√° t·ª´ kh√°ch h√†ng</p>
</div>

<!-- Stats Cards -->
<div class="stats-row" id="statsRow">
    <div class="stat-card">
        <div class="stat-icon">üìù</div>
        <div class="stat-info">
            <span class="stat-value" id="statTotal">0</span>
            <span class="stat-label">T·ªïng ƒë√°nh gi√°</span>
        </div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-info">
            <span class="stat-value" id="statPending">0</span>
            <span class="stat-label">Ch·ªù duy·ªát</span>
        </div>
    </div>
    <div class="stat-card info">
        <div class="stat-icon">üí¨</div>
        <div class="stat-info">
            <span class="stat-value" id="statUnreplied">0</span>
            <span class="stat-label">Ch∆∞a ph·∫£n h·ªìi</span>
        </div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-info">
            <span class="stat-value" id="statToday">0</span>
            <span class="stat-label">H√¥m nay</span>
        </div>
    </div>
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
    <button class="tab-btn active" data-status="all">T·∫•t c·∫£</button>
    <button class="tab-btn" data-status="pending">Ch·ªù duy·ªát</button>
    <button class="tab-btn" data-status="unreplied">Ch∆∞a ph·∫£n h·ªìi</button>
    <button class="tab-btn" data-status="replied">ƒê√£ ph·∫£n h·ªìi</button>
</div>

<!-- Reviews Table -->
<div class="table-container">
    <table class="data-table" id="reviewsTable">
        <thead>
            <tr>
                <th>Kh√°ch h√†ng</th>
                <th>ƒê√°nh gi√°</th>
                <th>N·ªôi dung</th>
                <th>Ng√†y</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="reviewsBody">
            <tr><td colspan="6" class="loading">ƒêang t·∫£i...</td></tr>
        </tbody>
    </table>
</div>

<!-- Reply Modal -->
<div class="modal-overlay" id="replyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí¨ Ph·∫£n h·ªìi ƒë√°nh gi√°</h3>
            <button class="modal-close" onclick="closeReplyModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="review-preview" id="reviewPreview"></div>
            <div class="form-group">
                <label>N·ªôi dung ph·∫£n h·ªìi</label>
                <textarea id="replyContent" rows="4" placeholder="Nh·∫≠p ph·∫£n h·ªìi c·ªßa b·∫°n..."></textarea>
            </div>
            <div class="quick-replies">
                <span>M·∫´u nhanh:</span>
                <button onclick="useQuickReply('C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô M·ª≥ Cay Sasin! H·∫πn g·∫∑p l·∫°i b·∫°n l·∫ßn sau nh√©! üçú')">C·∫£m ∆°n</button>
                <button onclick="useQuickReply('C·∫£m ∆°n g√≥p √Ω c·ªßa b·∫°n! Ch√∫ng t√¥i s·∫Ω c·∫£i thi·ªán trong th·ªùi gian t·ªõi. üôè')">Ti·∫øp thu g√≥p √Ω</button>
                <button onclick="useQuickReply('Xin l·ªói v·ªÅ tr·∫£i nghi·ªám kh√¥ng t·ªët. Ch√∫ng t√¥i s·∫Ω li√™n h·ªá b·∫°n ƒë·ªÉ h·ªó tr·ª£! üìû')">Xin l·ªói</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReplyModal()">H·ªßy</button>
            <button class="btn btn-primary" onclick="submitReply()">G·ª≠i ph·∫£n h·ªìi</button>
        </div>
    </div>
</div>

<style>
.filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.filter-tabs .tab-btn {
    padding: 10px 20px; border: 2px solid #e5e7eb; background: white;
    border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.2s;
}
.filter-tabs .tab-btn:hover { border-color: #f97316; color: #f97316; }
.filter-tabs .tab-btn.active { background: #f97316; color: white; border-color: #f97316; }

.review-preview {
    background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;
}
.review-preview .customer { font-weight: 600; margin-bottom: 5px; }
.review-preview .stars { color: #fbbf24; margin-bottom: 10px; }
.review-preview .content { color: #4b5563; line-height: 1.6; }

.quick-replies { margin-top: 15px; }
.quick-replies span { font-size: 0.9rem; color: #6b7280; margin-right: 10px; }
.quick-replies button {
    padding: 6px 12px; background: #f3f4f6; border: none;
    border-radius: 15px; font-size: 0.85rem; cursor: pointer; margin: 3px;
}
.quick-replies button:hover { background: #e5e7eb; }

.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.badge-pending { background: #fef3c7; color: #d97706; }
.badge-approved { background: #d1fae5; color: #059669; }
.badge-replied { background: #dbeafe; color: #2563eb; }
.badge-hidden { background: #f3f4f6; color: #6b7280; }

.stars-display { color: #fbbf24; }
.review-text { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.reply-text { font-size: 0.85rem; color: #059669; margin-top: 5px; }
</style>

@section Scripts {
<script>
let currentStatus = 'all';
let currentReviewId = null;

document.addEventListener('DOMContentLoaded', loadReviews);

// Filter tabs
document.querySelectorAll('.filter-tabs .tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-tabs .tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentStatus = this.dataset.status;
        loadReviews();
    });
});

async function loadReviews() {
    try {
        const url = currentStatus === 'all' 
            ? '/api/reviews/admin' 
            : `/api/reviews/admin?status=${currentStatus}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
            renderStats(data.stats);
            renderReviews(data.data);
        }
    } catch (err) {
        console.error('Error loading reviews:', err);
    }
}

function renderStats(stats) {
    document.getElementById('statTotal').textContent = stats.Total || 0;
    document.getElementById('statPending').textContent = stats.Pending || 0;
    document.getElementById('statUnreplied').textContent = stats.Unreplied || 0;
    document.getElementById('statToday').textContent = stats.Today || 0;
}

function renderReviews(reviews) {
    const tbody = document.getElementById('reviewsBody');
    
    if (!reviews || reviews.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Kh√¥ng c√≥ ƒë√°nh gi√° n√†o</td></tr>';
        return;
    }
    
    tbody.innerHTML = reviews.map(r => `
        <tr>
            <td>
                <strong>${r.TenKhach}</strong>
                ${r.SDT ? `<br><small>${r.SDT}</small>` : ''}
                ${r.Email ? `<br><small>${r.Email}</small>` : ''}
            </td>
            <td>
                <span class="stars-display">${'‚≠ê'.repeat(r.SoSao)}</span>
                ${r.ProductName ? `<br><small>üçú ${r.ProductName}</small>` : ''}
            </td>
            <td>
                <div class="review-text" title="${r.NoiDung}">${r.NoiDung}</div>
                ${r.PhanHoi ? `<div class="reply-text">‚Ü≥ ${r.PhanHoi.substring(0, 50)}...</div>` : ''}
            </td>
            <td>${formatDate(r.NgayDanhGia)}</td>
            <td>
                ${!r.DaDuyet ? '<span class="badge badge-pending">Ch·ªù duy·ªát</span>' : 
                  r.PhanHoi ? '<span class="badge badge-replied">ƒê√£ ph·∫£n h·ªìi</span>' : 
                  '<span class="badge badge-approved">ƒê√£ duy·ªát</span>'}
                ${!r.HienThi ? '<span class="badge badge-hidden">·∫®n</span>' : ''}
            </td>
            <td>
                <div class="action-buttons">
                    ${!r.DaDuyet ? `<button class="btn-icon btn-success" onclick="approveReview(${r.MaDG})" title="Duy·ªát">‚úì</button>` : ''}
                    <button class="btn-icon btn-primary" onclick="openReplyModal(${r.MaDG}, '${escapeHtml(r.TenKhach)}', ${r.SoSao}, '${escapeHtml(r.NoiDung)}', '${escapeHtml(r.PhanHoi || '')}')" title="Ph·∫£n h·ªìi">üí¨</button>
                    <button class="btn-icon ${r.HienThi ? 'btn-warning' : 'btn-info'}" onclick="toggleReview(${r.MaDG})" title="${r.HienThi ? '·∫®n' : 'Hi·ªán'}">
                        ${r.HienThi ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                    </button>
                    <button class="btn-icon btn-danger" onclick="deleteReview(${r.MaDG})" title="X√≥a">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('vi-VN');
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ');
}

async function approveReview(id) {
    if (!confirm('Duy·ªát ƒë√°nh gi√° n√†y?')) return;
    
    try {
        const res = await fetch(`/api/reviews/${id}/approve`, { method: 'PUT' });
        const data = await res.json();
        if (data.success) {
            showToast('‚úì ƒê√£ duy·ªát ƒë√°nh gi√°');
            loadReviews();
        }
    } catch (err) {
        showToast('‚ùå C√≥ l·ªói x·∫£y ra');
    }
}

function openReplyModal(id, name, stars, content, existingReply) {
    currentReviewId = id;
    document.getElementById('reviewPreview').innerHTML = `
        <div class="customer">${name}</div>
        <div class="stars">${'‚≠ê'.repeat(stars)}</div>
        <div class="content">${content}</div>
    `;
    document.getElementById('replyContent').value = existingReply || '';
    document.getElementById('replyModal').classList.add('active');
}

function closeReplyModal() {
    document.getElementById('replyModal').classList.remove('active');
    currentReviewId = null;
}

function useQuickReply(text) {
    document.getElementById('replyContent').value = text;
}

async function submitReply() {
    const reply = document.getElementById('replyContent').value.trim();
    if (!reply) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi');
        return;
    }
    
    try {
        const res = await fetch(`/api/reviews/${currentReviewId}/reply`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reply })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('‚úì ƒê√£ g·ª≠i ph·∫£n h·ªìi');
            closeReplyModal();
            loadReviews();
        } else {
            showToast('‚ùå ' + data.message);
        }
    } catch (err) {
        showToast('‚ùå C√≥ l·ªói x·∫£y ra');
    }
}

async function toggleReview(id) {
    try {
        const res = await fetch(`/api/reviews/${id}/toggle`, { method: 'PUT' });
        const data = await res.json();
        if (data.success) {
            showToast('‚úì ' + data.message);
            loadReviews();
        }
    } catch (err) {
        showToast('‚ùå C√≥ l·ªói x·∫£y ra');
    }
}

async function deleteReview(id) {
    if (!confirm('X√≥a ƒë√°nh gi√° n√†y? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c!')) return;
    
    try {
        const res = await fetch(`/api/reviews/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            showToast('‚úì ƒê√£ x√≥a ƒë√°nh gi√°');
            loadReviews();
        }
    } catch (err) {
        showToast('‚ùå C√≥ l·ªói x·∫£y ra');
    }
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
}
