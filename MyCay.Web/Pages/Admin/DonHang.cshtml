@page
@model AdminDonHangModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω ƒë∆°n h√†ng";
    Layout = "_AdminLayout";
}

<div class="page-header">
    <h1 class="page-title">Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
    <div class="page-actions">
        <!-- N√∫t ph√¢n c√¥ng ƒë∆°n - ch·ªâ Admin/StoreManager -->
        <button class="btn btn-secondary btn-assign-order" onclick="openAssignModal()" style="display:none;">
            <i class="fas fa-user-plus"></i> Ph√¢n c√¥ng ƒë∆°n
        </button>
        <button class="btn btn-secondary" onclick="exportOrders()">
            <i class="fas fa-download"></i> Xu·∫•t Excel
        </button>
    </div>
</div>

<!-- Th√¥ng b√°o cho Staff -->
<div class="staff-notice" id="staffNotice" style="display:none;">
    <div class="alert alert-info" style="margin-bottom: 20px; padding: 15px 20px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px;">
        <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 10px;"></i>
        <strong>L∆∞u √Ω:</strong> B·∫°n ch·ªâ xem ƒë∆∞·ª£c c√°c ƒë∆°n h√†ng ƒë∆∞·ª£c ph√¢n c√¥ng cho m√¨nh. Li√™n h·ªá Qu·∫£n l√Ω n·∫øu c·∫ßn h·ªó tr·ª£.
    </div>
</div>

<!-- Order Stats -->
<div class="stats-grid" style="margin-bottom: 25px;">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-clock"></i></div>
        <div class="stat-info">
            <h3>Ch·ªù x√°c nh·∫≠n</h3>
            <p class="stat-number" id="pendingCount">0</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-utensils"></i></div>
        <div class="stat-info">
            <h3>ƒêang chu·∫©n b·ªã</h3>
            <p class="stat-number" id="preparingCount">0</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);"><i class="fas fa-truck"></i></div>
        <div class="stat-info">
            <h3>ƒêang giao</h3>
            <p class="stat-number" id="shippingCount">0</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-check-circle"></i></div>
        <div class="stat-info">
            <h3>Ho√†n th√†nh</h3>
            <p class="stat-number" id="completedCount">0</p>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="data-table-wrapper">
    <div class="table-header">
        <div class="table-search">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="T√¨m m√£ ƒë∆°n, t√™n kh√°ch..." onkeyup="filterOrders()" />
        </div>
        <div class="table-filters">
            <select id="statusFilter" onchange="filterOrders()">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="Ch·ªù x√°c nh·∫≠n">Ch·ªù x√°c nh·∫≠n</option>
                <option value="ƒêang chu·∫©n b·ªã">ƒêang chu·∫©n b·ªã</option>
                <option value="ƒêang giao">ƒêang giao</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
            </select>
            <select id="dateFilter" onchange="filterOrders()">
                <option value="">T·∫•t c·∫£ th·ªùi gian</option>
                <option value="today">H√¥m nay</option>
                <option value="week">Tu·∫ßn n√†y</option>
                <option value="month">Th√°ng n√†y</option>
            </select>
            <!-- Filter nh√¢n vi√™n - ch·ªâ Admin/StoreManager -->
            <select id="staffFilter" onchange="filterOrders()" class="staff-filter-select" style="display:none;">
                <option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>
            </select>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>M√£ ƒë∆°n</th>
                <th>Kh√°ch h√†ng</th>
                <th>ƒê·ªãa ch·ªâ giao</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th class="staff-column" style="display:none;">Nh√¢n vi√™n</th>
                <th>Ng√†y ƒë·∫∑t</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="ordersTableBody">
            <!-- Orders will be loaded here -->
        </tbody>
    </table>

    <div class="table-footer">
        <div class="table-info">Hi·ªÉn th·ªã <span id="showingCount">0</span> / <span id="totalCount">0</span> ƒë∆°n h√†ng</div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" id="orderModal">
    <div class="modal" style="max-width: 700px; overflow: visible;">
        <div class="modal-header">
            <h3>Chi ti·∫øt ƒë∆°n h√†ng <span id="modalOrderId"></span></h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y: auto; max-height: 65vh;">
            <div class="order-detail-grid">
                <div class="order-info-section">
                    <h4>Th√¥ng tin kh√°ch h√†ng</h4>
                    <p><strong>T√™n:</strong> <span id="modalCustomer"></span></p>
                    <p><strong>SƒêT:</strong> <span id="modalPhone"></span></p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="modalAddress"></span></p>
                </div>
                <div class="order-info-section">
                    <h4>Th√¥ng tin ƒë∆°n h√†ng</h4>
                    <p><strong>Ng√†y ƒë·∫∑t:</strong> <span id="modalDate"></span></p>
                    <p><strong>Thanh to√°n:</strong> <span id="modalPayment"></span></p>
                    <p><strong>Ghi ch√∫:</strong> <span id="modalNote"></span></p>
                    <p class="assign-info" style="display:none;"><strong>Nh√¢n vi√™n x·ª≠ l√Ω:</strong> <span id="modalAssignedTo"></span></p>
                    <p class="assign-info" style="display:none;"><strong>C·ª≠a h√†ng:</strong> <span id="modalStore"></span></p>
                </div>
            </div>
            <h4 style="margin: 20px 0 10px;">S·∫£n ph·∫©m</h4>
            <table class="data-table" style="font-size: 0.9rem;">
                <thead>
                    <tr>
                        <th>S·∫£n ph·∫©m</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>SL</th>
                        <th>Th√†nh ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody id="modalProducts"></tbody>
                <tfoot>
                    <tr><td colspan="3">T·∫°m t√≠nh</td><td id="modalSubtotal"></td></tr>
                    <tr><td colspan="3">Ph√≠ giao h√†ng</td><td id="modalShipping"></td></tr>
                    <tr><td colspan="3">Gi·∫£m gi√°</td><td id="modalDiscount"></td></tr>
                    <tr style="font-weight: bold;"><td colspan="3">T·ªïng c·ªông</td><td id="modalTotal"></td></tr>
                </tfoot>
            </table>
            
            <!-- Status Update Section - T√°ch ri√™ng ƒë·ªÉ d·ªÖ click -->
            <div class="status-update-section" style="margin-top: 25px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                <label style="display: block; margin-bottom: 12px; font-weight: 700; color: #1f2937; font-size: 1rem;">
                    <i class="fas fa-edit" style="color: #f97316; margin-right: 8px;"></i>C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
                </label>
                <select id="modalStatus" name="modalStatus" style="width: 100%; padding: 14px 18px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 1rem; font-weight: 500; background-color: #ffffff; color: #1f2937; cursor: pointer; -webkit-appearance: menulist; -moz-appearance: menulist; appearance: menulist;">
                    <option value="Ch·ªù x√°c nh·∫≠n">üïê Ch·ªù x√°c nh·∫≠n</option>
                    <option value="ƒêang chu·∫©n b·ªã">üë®‚Äçüç≥ ƒêang chu·∫©n b·ªã</option>
                    <option value="ƒêang giao">üöö ƒêang giao</option>
                    <option value="Ho√†n th√†nh">‚úÖ Ho√†n th√†nh</option>
                    <option value="ƒê√£ h·ªßy">‚ùå ƒê√£ h·ªßy</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
            <button class="btn btn-primary" onclick="updateOrderStatus()">
                <i class="fas fa-save"></i> C·∫≠p nh·∫≠t tr·∫°ng th√°i
            </button>
        </div>
    </div>
</div>

<style>
.order-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.order-info-section { background: var(--admin-light); padding: 15px; border-radius: var(--radius); }
.order-info-section h4 { margin-bottom: 10px; color: var(--admin-primary); }
.order-info-section p { margin: 5px 0; font-size: 0.9rem; }
.data-table tfoot td { padding: 10px 20px; text-align: right; }
.data-table tfoot tr:last-child { background: var(--admin-light); }

/* Status Update Section */
.status-update-section select {
    transition: all 0.3s ease;
}
.status-update-section select:hover {
    border-color: #f97316 !important;
    background-color: #fff7ed !important;
}
.status-update-section select:focus {
    outline: none;
    border-color: #f97316 !important;
    box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15);
}

@@media (max-width: 768px) {
    .order-detail-grid { grid-template-columns: 1fr; }
}
</style>

@section Scripts {
<script>
let orders = [];
let currentOrder = null;
let currentPage = 1;
let totalOrders = 0;
let staffList = [];

// =====================================================
// KH·ªûI T·∫†O PH√ÇN QUY·ªÄN
// =====================================================
function initPermissions() {
    const role = window.userRole;
    
    // Hi·ªÉn th·ªã th√¥ng b√°o cho Staff
    if (role === 'staff') {
        document.getElementById('staffNotice').style.display = 'block';
    }
    
    // Hi·ªÉn th·ªã n√∫t ph√¢n c√¥ng v√† c·ªôt nh√¢n vi√™n cho Admin/StoreManager
    if (role === 'admin' || role === 'storemanager') {
        document.querySelector('.btn-assign-order')?.style.setProperty('display', 'inline-flex');
        document.querySelector('.staff-filter-select')?.style.setProperty('display', 'block');
        document.querySelectorAll('.staff-column').forEach(el => el.style.display = 'table-cell');
        loadStaffList();
    }
    
    // ·∫®n n√∫t h·ªßy ƒë∆°n n·∫øu Staff kh√¥ng c√≥ quy·ªÅn
    if (!checkPermission('canCancelOrder')) {
        // S·∫Ω x·ª≠ l√Ω trong renderOrders
    }
}

// Load danh s√°ch nh√¢n vi√™n (cho Admin/StoreManager)
async function loadStaffList() {
    try {
        let url = '/api/orders/staff';
        // StoreManager ch·ªâ xem nh√¢n vi√™n c·ª≠a h√†ng m√¨nh
        if (window.userRole === 'storemanager' && window.userStoreId) {
            url += `?storeId=${window.userStoreId}`;
        }
        
        const res = await fetch(url);
        const data = await res.json();
        if (data.success) {
            staffList = data.data;
            const select = document.getElementById('staffFilter');
            select.innerHTML = '<option value="">T·∫•t c·∫£ nh√¢n vi√™n</option><option value="unassigned">Ch∆∞a ph√¢n c√¥ng</option>';
            staffList.forEach(s => {
                select.innerHTML += `<option value="${s.id}">${s.name} (${s.position})</option>`;
            });
        }
    } catch (e) {
        console.error('Error loading staff:', e);
    }
}

// Load danh s√°ch c·ª≠a h√†ng (cho Admin)
async function loadStoreList() {
    if (window.userRole !== 'admin') return;
    
    try {
        const res = await fetch('/api/orders/stores');
        const data = await res.json();
        if (data.success && data.data.length > 0) {
            // Th√™m filter c·ª≠a h√†ng
            const filterContainer = document.querySelector('.table-filters');
            const storeSelect = document.createElement('select');
            storeSelect.id = 'storeFilter';
            storeSelect.onchange = filterOrders;
            storeSelect.innerHTML = '<option value="">T·∫•t c·∫£ c·ª≠a h√†ng</option>';
            data.data.forEach(s => {
                storeSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            filterContainer.appendChild(storeSelect);
        }
    } catch (e) {
        console.error('Error loading stores:', e);
    }
}

// Load ƒë∆°n h√†ng t·ª´ API (c√≥ ph√¢n quy·ªÅn)
async function loadOrders(page = 1) {
    const status = document.getElementById('statusFilter').value;
    const staffId = document.getElementById('staffFilter')?.value || '';
    const storeId = document.getElementById('storeFilter')?.value || '';
    const role = window.userRole;
    
    try {
        let url = `/api/orders?page=${page}&pageSize=20`;
        if (status) url += `&status=${encodeURIComponent(status)}`;
        
        // Staff ch·ªâ xem ƒë∆°n ƒë∆∞·ª£c ph√¢n c√¥ng
        if (role === 'staff') {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.staffId) {
                url += `&assignedTo=${user.staffId}`;
            }
        }
        
        // Filter theo nh√¢n vi√™n (Admin/StoreManager)
        if (staffId && (role === 'admin' || role === 'storemanager')) {
            if (staffId === 'unassigned') {
                url += `&unassigned=true`;
            } else {
                url += `&assignedTo=${staffId}`;
            }
        }
        
        // Filter theo c·ª≠a h√†ng
        if (storeId && role === 'admin') {
            url += `&storeId=${storeId}`;
        } else if (role === 'storemanager' && window.userStoreId) {
            url += `&storeId=${window.userStoreId}`;
        }
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
            orders = data.data.map(o => ({
                id: o.id,
                code: o.code,
                customer: o.customerName,
                phone: o.phone,
                address: o.address || '',
                subtotal: o.subtotal,
                shipping: o.shippingFee,
                discount: o.discount,
                total: o.total,
                status: o.status,
                date: formatDate(o.createdAt),
                payment: o.paymentMethod,
                paymentStatus: o.paymentStatus,
                note: o.note,
                assignedToId: o.assignedToId,
                assignedToName: o.assignedToName,
                storeId: o.storeId,
                storeName: o.storeName,
                assignedAt: o.assignedAt
            }));
            totalOrders = data.pagination?.total || data.data.length;
            currentPage = page;
            renderOrders(orders);
            loadStats();
        }
    } catch (err) {
        console.error('L·ªói load ƒë∆°n h√†ng:', err);
        showToast('Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng!', 'error');
    }
}

// Load th·ªëng k√™
async function loadStats() {
    try {
        let url = '/api/orders/stats';
        const role = window.userRole;
        
        // Staff ch·ªâ xem stats ƒë∆°n c·ªßa m√¨nh
        if (role === 'staff') {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.staffId) url += `?assignedTo=${user.staffId}`;
        }
        
        // StoreManager xem stats c·ª≠a h√†ng
        if (role === 'storemanager' && window.userStoreId) {
            url += `?storeId=${window.userStoreId}`;
        }
        
        const res = await fetch(url);
        const data = await res.json();
        if (data.success) {
            document.getElementById('pendingCount').textContent = data.data.pending || 0;
            document.getElementById('preparingCount').textContent = data.data.preparing || 0;
            document.getElementById('shippingCount').textContent = data.data.shipping || 0;
            document.getElementById('completedCount').textContent = data.data.completed || 0;
        }
    } catch (err) {
        console.error('L·ªói load stats:', err);
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('vi-VN') + ' ' + d.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
}

function renderOrders(data) {
    const tbody = document.getElementById('ordersTableBody');
    const role = window.userRole;
    const showStaffColumn = role === 'admin' || role === 'storemanager';
    const canCancel = checkPermission('canCancelOrder');
    const canAssign = checkPermission('canAssignOrderToStaff');
    
    if (data.length === 0) {
        const colspan = showStaffColumn ? 8 : 7;
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;padding:40px;color:#6b7280;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>`;
        document.getElementById('showingCount').textContent = 0;
        document.getElementById('totalCount').textContent = 0;
        return;
    }
    
    tbody.innerHTML = data.map(order => {
        const assignedInfo = order.assignedToName 
            ? `<span style="color:#059669;font-weight:500;">${order.assignedToName}</span>` 
            : '<span style="color:#9ca3af;font-style:italic;">Ch∆∞a ph√¢n c√¥ng</span>';
        
        const assignedTime = order.assignedAt ? `<br><small style="color:#6b7280;">${formatDate(order.assignedAt)}</small>` : '';
        
        return `
            <tr>
                <td><strong>${order.code}</strong></td>
                <td>
                    <div>${order.customer}</div>
                    <small style="color: var(--admin-gray);">${order.phone}</small>
                </td>
                <td style="max-width: 200px;">${order.address || 'N/A'}</td>
                <td class="price">${Math.round(order.total).toLocaleString()}ƒë</td>
                <td><span class="order-status ${getStatusClass(order.status)}">${order.status}</span></td>
                ${showStaffColumn ? `<td>${assignedInfo}${assignedTime}</td>` : ''}
                <td>${order.date}</td>
                <td class="actions">
                    <button class="action-btn edit" onclick="viewOrder(${order.id})" title="Xem chi ti·∫øt"><i class="fas fa-eye"></i></button>
                    ${canAssign ? `<button class="action-btn warning" onclick="assignOrder(${order.id}, '${order.assignedToName || ''}')" title="Ph√¢n c√¥ng"><i class="fas fa-user-plus"></i></button>` : ''}
                    ${canCancel && order.status !== 'Ho√†n th√†nh' && order.status !== 'ƒê√£ h·ªßy' ? `<button class="action-btn delete" onclick="cancelOrder(${order.id})" title="H·ªßy ƒë∆°n"><i class="fas fa-times"></i></button>` : ''}
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('showingCount').textContent = data.length;
    document.getElementById('totalCount').textContent = totalOrders;
}

function getStatusClass(status) {
    const classes = {
        'Ch·ªù x√°c nh·∫≠n': 'pending',
        'ƒêang chu·∫©n b·ªã': 'preparing',
        'ƒêang giao': 'shipping',
        'Ho√†n th√†nh': 'completed',
        'ƒê√£ h·ªßy': 'cancelled'
    };
    return classes[status] || '';
}

function filterOrders() {
    loadOrders(1);
}

async function viewOrder(id) {
    try {
        const res = await fetch(`/api/orders/${id}`);
        const data = await res.json();
        
        if (!data.success) {
            showToast('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!', 'error');
            return;
        }
        
        currentOrder = data.data;
        
        document.getElementById('modalOrderId').textContent = currentOrder.code;
        document.getElementById('modalCustomer').textContent = currentOrder.customerName;
        document.getElementById('modalPhone').textContent = currentOrder.phone;
        document.getElementById('modalAddress').textContent = currentOrder.address || 'N/A';
        document.getElementById('modalDate').textContent = formatDate(currentOrder.createdAt);
        document.getElementById('modalPayment').textContent = currentOrder.paymentMethod;
        document.getElementById('modalNote').textContent = currentOrder.note || 'Kh√¥ng c√≥';
        document.getElementById('modalStatus').value = currentOrder.status;
        
        // Hi·ªÉn th·ªã th√¥ng tin ph√¢n c√¥ng (Admin/StoreManager)
        const role = window.userRole;
        if (role === 'admin' || role === 'storemanager') {
            document.querySelectorAll('.assign-info').forEach(el => el.style.display = 'block');
            document.getElementById('modalAssignedTo').textContent = currentOrder.assignedToName || 'Ch∆∞a ph√¢n c√¥ng';
            document.getElementById('modalStore').textContent = currentOrder.storeName || 'Ch∆∞a x√°c ƒë·ªãnh';
        }
        
        // Gi·ªõi h·∫°n tr·∫°ng th√°i cho Staff
        const statusSelect = document.getElementById('modalStatus');
        if (window.userRole === 'staff') {
            // Staff ch·ªâ ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo flow: Ch·ªù x√°c nh·∫≠n -> ƒêang chu·∫©n b·ªã -> ƒêang giao -> Ho√†n th√†nh
            // Kh√¥ng ƒë∆∞·ª£c ch·ªçn ƒê√£ h·ªßy
            const cancelOption = statusSelect.querySelector('option[value="ƒê√£ h·ªßy"]');
            if (cancelOption) cancelOption.disabled = true;
        }
        
        const items = currentOrder.items || [];
        document.getElementById('modalProducts').innerHTML = items.length > 0 ? items.map(p => `
            <tr>
                <td>${p.name}</td>
                <td>${p.price.toLocaleString()}ƒë</td>
                <td>${p.quantity}</td>
                <td>${(p.price * p.quantity).toLocaleString()}ƒë</td>
            </tr>
        `).join('') : '<tr><td colspan="4" style="text-align:center;">Kh√¥ng c√≥ chi ti·∫øt</td></tr>';
        
        document.getElementById('modalSubtotal').textContent = Math.round(currentOrder.subtotal).toLocaleString() + 'ƒë';
        document.getElementById('modalShipping').textContent = Math.round(currentOrder.shippingFee).toLocaleString() + 'ƒë';
        document.getElementById('modalDiscount').textContent = '-' + Math.round(currentOrder.discount).toLocaleString() + 'ƒë';
        document.getElementById('modalTotal').textContent = Math.round(currentOrder.total).toLocaleString() + 'ƒë';
        
        document.getElementById('orderModal').classList.add('show');
    } catch (err) {
        console.error('L·ªói load chi ti·∫øt:', err);
        showToast('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng!', 'error');
    }
}

function closeModal() {
    document.getElementById('orderModal').classList.remove('show');
}

async function updateOrderStatus() {
    if (!currentOrder) return;
    
    const newStatus = document.getElementById('modalStatus').value;
    
    // Ki·ªÉm tra quy·ªÅn h·ªßy ƒë∆°n
    if (newStatus === 'ƒê√£ h·ªßy' && !checkPermission('canCancelOrder')) {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy ƒë∆°n h√†ng!', 'error');
        return;
    }
    
    try {
        const res = await fetch(`/api/orders/${currentOrder.id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!', 'success');
            closeModal();
            loadOrders(currentPage);
        } else {
            showToast(data.message || 'L·ªói c·∫≠p nh·∫≠t!', 'error');
        }
    } catch (err) {
        console.error('L·ªói c·∫≠p nh·∫≠t:', err);
        showToast('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'error');
    }
}

// Ph√¢n c√¥ng ƒë∆°n h√†ng cho nh√¢n vi√™n (Admin/StoreManager)
async function assignOrder(orderId, currentStaffName) {
    if (!checkPermission('canAssignOrderToStaff')) {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn ph√¢n c√¥ng ƒë∆°n h√†ng!', 'error');
        return;
    }
    
    // T·∫°o modal ch·ªçn nh√¢n vi√™n
    const staffOptions = staffList.map(s => `<option value="${s.id}">${s.name} - ${s.position}</option>`).join('');
    const currentInfo = currentStaffName ? `<p style="margin-bottom:15px;color:#6b7280;">Hi·ªán t·∫°i: <strong>${currentStaffName}</strong></p>` : '';
    
    const html = `
        <div class="modal-overlay show" id="assignModal">
            <div class="modal" style="max-width: 450px;">
                <div class="modal-header">
                    <h3><i class="fas fa-user-plus" style="color:#f97316;margin-right:10px;"></i>Ph√¢n c√¥ng ƒë∆°n h√†ng</h3>
                    <button class="modal-close" onclick="closeAssignModal()">&times;</button>
                </div>
                <div class="modal-body">
                    ${currentInfo}
                    <div class="form-group">
                        <label style="font-weight:600;margin-bottom:8px;display:block;">Ch·ªçn nh√¢n vi√™n x·ª≠ l√Ω</label>
                        <select id="assignStaffId" class="form-control" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;">
                            <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                            <option value="0">‚ùå H·ªßy ph√¢n c√¥ng</option>
                            ${staffOptions}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAssignModal()">H·ªßy</button>
                    <button class="btn btn-primary" onclick="confirmAssign(${orderId})">
                        <i class="fas fa-check"></i> X√°c nh·∫≠n
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}

function closeAssignModal() {
    document.getElementById('assignModal')?.remove();
}

async function confirmAssign(orderId) {
    const staffIdValue = document.getElementById('assignStaffId').value;
    
    if (staffIdValue === '') {
        showToast('Vui l√≤ng ch·ªçn nh√¢n vi√™n!', 'error');
        return;
    }
    
    // staffId = 0 nghƒ©a l√† h·ªßy ph√¢n c√¥ng
    const staffId = staffIdValue === '0' ? null : parseInt(staffIdValue);
    
    try {
        const res = await fetch(`/api/orders/${orderId}/assign`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ staffId: staffId })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(staffId ? 'Ph√¢n c√¥ng th√†nh c√¥ng!' : 'ƒê√£ h·ªßy ph√¢n c√¥ng!', 'success');
            closeAssignModal();
            loadOrders(currentPage);
        } else {
            showToast(data.message || 'L·ªói ph√¢n c√¥ng!', 'error');
        }
    } catch (err) {
        showToast('Kh√¥ng th·ªÉ ph√¢n c√¥ng ƒë∆°n h√†ng!', 'error');
    }
}

async function cancelOrder(id) {
    if (!checkPermission('canCancelOrder')) {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy ƒë∆°n h√†ng!', 'error');
        return;
    }
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) return;
    
    try {
        const res = await fetch(`/api/orders/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
            showToast('ƒê√£ h·ªßy ƒë∆°n h√†ng!', 'warning');
            loadOrders(currentPage);
        } else {
            showToast(data.message || 'L·ªói h·ªßy ƒë∆°n!', 'error');
        }
    } catch (err) {
        console.error('L·ªói h·ªßy ƒë∆°n:', err);
        showToast('Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng!', 'error');
    }
}

function exportOrders() {
    showToast('ƒêang xu·∫•t file Excel...', 'success');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Init - Kh·ªüi t·∫°o ph√¢n quy·ªÅn v√† load ƒë∆°n h√†ng
initPermissions();
loadStoreList();
loadOrders();
</script>
}
