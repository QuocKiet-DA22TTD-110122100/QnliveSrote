@page
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Kho";
    Layout = "_AdminLayout";
}

<div class="admin-header">
    <h1>üì¶ Qu·∫£n l√Ω Kho & Nguy√™n v·∫≠t li·ªáu</h1>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" onclick="showTab('stock')">üìä T·ªìn kho</button>
    <button class="tab-btn" onclick="showTab('materials')">ü•¨ Nguy√™n v·∫≠t li·ªáu</button>
    <button class="tab-btn" onclick="showTab('alerts')">‚ö†Ô∏è C·∫£nh b√°o</button>
</div>

<!-- Tab T·ªìn kho -->
<div class="tab-content active" id="stockTab">
    <div class="filter-bar">
        <select id="branchFilter" onchange="loadStock()">
            <option value="">T·∫•t c·∫£ chi nh√°nh</option>
        </select>
    </div>
    
    <div class="data-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Chi nh√°nh</th>
                    <th>Nguy√™n v·∫≠t li·ªáu</th>
                    <th>Nh√≥m</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n v·ªã</th>
                    <th>T·ªëi thi·ªÉu</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>C·∫≠p nh·∫≠t</th>
                </tr>
            </thead>
            <tbody id="stockTableBody">
                <tr><td colspan="8" class="loading">ƒêang t·∫£i...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Tab Nguy√™n v·∫≠t li·ªáu -->
<div class="tab-content" id="materialsTab">
    <div class="admin-header" style="margin-top: 0;">
        <span></span>
        <button class="btn btn-primary" onclick="showAddMaterial()">
            <i class="fas fa-plus"></i> Th√™m NVL
        </button>
    </div>
    
    <div class="data-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n NVL</th>
                    <th>Nh√≥m</th>
                    <th>ƒê∆°n v·ªã</th>
                    <th>Gi√° nh·∫≠p</th>
                    <th>SL t·ªëi thi·ªÉu</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="materialsTableBody">
                <tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Tab C·∫£nh b√°o -->
<div class="tab-content" id="alertsTab">
    <div class="alert-list" id="alertsList">
        <p class="loading">ƒêang t·∫£i...</p>
    </div>
</div>

<!-- Modal Th√™m NVL -->
<div class="modal-overlay" id="materialModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Th√™m nguy√™n v·∫≠t li·ªáu</h3>
            <button class="modal-close" onclick="closeMaterialModal()">&times;</button>
        </div>
        <form id="materialForm" onsubmit="saveMaterial(event)">
            <input type="hidden" id="materialId">
            <div class="form-group">
                <label>T√™n NVL *</label>
                <input type="text" id="tenNVL" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Nh√≥m</label>
                    <select id="nhomNVL">
                        <option value="M√¨">M√¨</option>
                        <option value="Th·ªãt">Th·ªãt</option>
                        <option value="H·∫£i s·∫£n">H·∫£i s·∫£n</option>
                        <option value="Rau c·ªß">Rau c·ªß</option>
                        <option value="Gia v·ªã">Gia v·ªã</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ƒê∆°n v·ªã t√≠nh</label>
                    <input type="text" id="donViTinh" placeholder="kg, g, l√≠t...">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Gi√° nh·∫≠p</label>
                    <input type="number" id="giaNhap" value="0">
                </div>
                <div class="form-group">
                    <label>SL t·ªëi thi·ªÉu</label>
                    <input type="number" id="soLuongToiThieu" value="10">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeMaterialModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
        </form>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 10px;
}
.tab-btn {
    padding: 10px 20px;
    border: none;
    background: #f3f4f6;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}
.tab-btn.active {
    background: #f97316;
    color: white;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.filter-bar {
    margin-bottom: 20px;
}
.filter-bar select {
    padding: 10px 15px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    min-width: 200px;
}
.alert-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.alert-item {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 12px;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.alert-item .info strong {
    color: #dc2626;
}
.status-ok {
    background: #dcfce7;
    color: #16a34a;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}
.status-low {
    background: #fef2f2;
    color: #dc2626;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}
</style>

@section Scripts {
<script>
let branches = [];
let materials = [];
let stock = [];
let alerts = [];

async function init() {
    await loadBranches();
    await loadMaterials();
    await loadStock();
    await loadAlerts();
}

async function loadBranches() {
    const res = await fetch('/api/branch');
    branches = await res.json();
    
    const select = document.getElementById('branchFilter');
    branches.forEach(b => {
        select.innerHTML += `<option value="${b.maCN}">${b.tenChiNhanh}</option>`;
    });
}

async function loadMaterials() {
    const res = await fetch('/api/inventory/materials');
    materials = await res.json();
    renderMaterials();
}

async function loadStock() {
    const branchId = document.getElementById('branchFilter').value;
    const url = branchId ? `/api/inventory/stock?branchId=${branchId}` : '/api/inventory/stock';
    const res = await fetch(url);
    stock = await res.json();
    renderStock();
}

async function loadAlerts() {
    const res = await fetch('/api/inventory/alerts');
    const data = await res.json();
    alerts = data.alerts;
    renderAlerts();
}

function renderStock() {
    const tbody = document.getElementById('stockTableBody');
    if (stock.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho</td></tr>';
        return;
    }
    
    tbody.innerHTML = stock.map(s => `
        <tr>
            <td>${s.tenChiNhanh}</td>
            <td><strong>${s.tenNVL}</strong></td>
            <td>${s.nhomNVL || '-'}</td>
            <td>${s.soLuong}</td>
            <td>${s.donViTinh || '-'}</td>
            <td>${s.soLuongToiThieu}</td>
            <td>
                <span class="${s.canhBao ? 'status-low' : 'status-ok'}">
                    ${s.canhBao ? '‚ö†Ô∏è S·∫Øp h·∫øt' : '‚úì ƒê·ªß'}
                </span>
            </td>
            <td>${new Date(s.ngayCapNhat).toLocaleDateString('vi-VN')}</td>
        </tr>
    `).join('');
}

function renderMaterials() {
    const tbody = document.getElementById('materialsTableBody');
    if (materials.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Ch∆∞a c√≥ nguy√™n v·∫≠t li·ªáu</td></tr>';
        return;
    }
    
    tbody.innerHTML = materials.map(m => `
        <tr>
            <td>${m.maNVL}</td>
            <td><strong>${m.tenNVL}</strong></td>
            <td>${m.nhomNVL || '-'}</td>
            <td>${m.donViTinh || '-'}</td>
            <td>${m.giaNhap?.toLocaleString()}ƒë</td>
            <td>${m.soLuongToiThieu}</td>
            <td>
                <button class="btn-icon" onclick="editMaterial(${m.maNVL})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderAlerts() {
    const container = document.getElementById('alertsList');
    if (alerts.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#16a34a;">‚úì T·∫•t c·∫£ nguy√™n v·∫≠t li·ªáu ƒë·ªÅu ƒë·ªß s·ªë l∆∞·ª£ng!</p>';
        return;
    }
    
    container.innerHTML = alerts.map(a => `
        <div class="alert-item">
            <div class="info">
                <strong>‚ö†Ô∏è ${a.tenNVL}</strong> t·∫°i <strong>${a.tenChiNhanh}</strong>
                <br>
                <small>C√≤n ${a.soLuong} ${a.donViTinh} (t·ªëi thi·ªÉu: ${a.soLuongToiThieu})</small>
            </div>
            <span class="status-low">Thi·∫øu ${a.thieuHut} ${a.donViTinh}</span>
        </div>
    `).join('');
}

function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
}

function showAddMaterial() {
    document.getElementById('materialForm').reset();
    document.getElementById('materialId').value = '';
    document.getElementById('materialModal').classList.add('active');
}

function editMaterial(id) {
    const m = materials.find(x => x.maNVL === id);
    if (!m) return;
    
    document.getElementById('materialId').value = id;
    document.getElementById('tenNVL').value = m.tenNVL;
    document.getElementById('nhomNVL').value = m.nhomNVL || 'Kh√°c';
    document.getElementById('donViTinh').value = m.donViTinh || '';
    document.getElementById('giaNhap').value = m.giaNhap || 0;
    document.getElementById('soLuongToiThieu').value = m.soLuongToiThieu || 10;
    document.getElementById('materialModal').classList.add('active');
}

async function saveMaterial(e) {
    e.preventDefault();
    const id = document.getElementById('materialId').value;
    const data = {
        tenNVL: document.getElementById('tenNVL').value,
        nhomNVL: document.getElementById('nhomNVL').value,
        donViTinh: document.getElementById('donViTinh').value,
        giaNhap: parseFloat(document.getElementById('giaNhap').value) || 0,
        soLuongToiThieu: parseInt(document.getElementById('soLuongToiThieu').value) || 10,
        trangThai: true
    };
    
    const url = id ? `/api/inventory/materials/${id}` : '/api/inventory/materials';
    const method = id ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (res.ok) {
        closeMaterialModal();
        loadMaterials();
        alert('L∆∞u th√†nh c√¥ng!');
    }
}

function closeMaterialModal() {
    document.getElementById('materialModal').classList.remove('active');
}

init();
</script>
}
