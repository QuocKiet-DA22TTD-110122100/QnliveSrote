@page
@{
    ViewData["Title"] = "Qu·∫£n l√Ω M√£ gi·∫£m gi√°";
    Layout = "_AdminLayout";
}

<div class="admin-header">
    <h1>üé´ Qu·∫£n l√Ω M√£ gi·∫£m gi√°</h1>
    <button class="btn btn-primary" onclick="showAddModal()">
        <i class="fas fa-plus"></i> Th√™m m√£
    </button>
</div>

<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon" style="background: #10b981;">üé´</div>
        <div class="stat-info">
            <span class="stat-value" id="totalCoupons">0</span>
            <span class="stat-label">T·ªïng m√£</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #3b82f6;">‚úì</div>
        <div class="stat-info">
            <span class="stat-value" id="activeCoupons">0</span>
            <span class="stat-label">ƒêang ho·∫°t ƒë·ªông</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: #f97316;">üìä</div>
        <div class="stat-info">
            <span class="stat-value" id="totalUsed">0</span>
            <span class="stat-label">ƒê√£ s·ª≠ d·ª•ng</span>
        </div>
    </div>
</div>

<div class="data-table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>M√£ code</th>
                <th>M√¥ t·∫£</th>
                <th>Lo·∫°i</th>
                <th>Gi√° tr·ªã</th>
                <th>ƒê∆°n t·ªëi thi·ªÉu</th>
                <th>ƒê√£ d√πng</th>
                <th>Th·ªùi h·∫°n</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="couponTableBody">
            <tr><td colspan="9" class="loading">ƒêang t·∫£i...</td></tr>
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal-overlay" id="couponModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Th√™m m√£ gi·∫£m gi√°</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="couponForm" onsubmit="saveCoupon(event)">
            <input type="hidden" id="couponId">
            <div class="form-row">
                <div class="form-group">
                    <label>M√£ code *</label>
                    <input type="text" id="maCode" required placeholder="VD: SASIN10" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Lo·∫°i gi·∫£m</label>
                    <select id="loaiGiam" onchange="updateValueLabel()">
                        <option value="percent">Ph·∫ßn trƒÉm (%)</option>
                        <option value="fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh</option>
                        <option value="freeship">Mi·ªÖn ph√≠ ship</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>M√¥ t·∫£</label>
                <input type="text" id="moTa" placeholder="VD: Gi·∫£m 10% cho ƒë∆°n t·ª´ 100k">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label id="valueLabel">Gi√° tr·ªã (%)</label>
                    <input type="number" id="giaTri" value="10" min="0">
                </div>
                <div class="form-group">
                    <label>Gi·∫£m t·ªëi ƒëa (ƒë)</label>
                    <input type="number" id="giamToiDa" placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ƒê∆°n t·ªëi thi·ªÉu (ƒë)</label>
                    <input type="number" id="donToiThieu" value="0">
                </div>
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng m√£</label>
                    <input type="number" id="soLuong" value="100">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="ngayBatDau">
                </div>
                <div class="form-group">
                    <label>Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="ngayKetThuc">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
        </form>
    </div>
</div>

<style>
.coupon-code {
    background: #fef3c7;
    color: #92400e;
    padding: 4px 10px;
    border-radius: 6px;
    font-family: monospace;
    font-weight: 700;
}
.status-active {
    background: #dcfce7;
    color: #16a34a;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}
.status-expired {
    background: #fef2f2;
    color: #dc2626;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}
.status-inactive {
    background: #f3f4f6;
    color: #6b7280;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}
</style>

@section Scripts {
<script>
let coupons = [];

async function loadCoupons() {
    const res = await fetch('/api/coupon');
    coupons = await res.json();
    renderTable();
    updateStats();
}

function renderTable() {
    const tbody = document.getElementById('couponTableBody');
    if (coupons.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty">Ch∆∞a c√≥ m√£ gi·∫£m gi√°</td></tr>';
        return;
    }
    
    tbody.innerHTML = coupons.map(c => {
        let loaiText = c.loaiGiam === 'percent' ? `${c.giaTri}%` : 
                       c.loaiGiam === 'freeship' ? 'Free ship' : 
                       `${c.giaTri?.toLocaleString()}ƒë`;
        
        let statusClass = !c.trangThai ? 'status-inactive' : 
                          c.hetHan ? 'status-expired' : 'status-active';
        let statusText = !c.trangThai ? 'V√¥ hi·ªáu' : 
                         c.hetHan ? 'H·∫øt h·∫°n' : 'Ho·∫°t ƒë·ªông';
        
        return `
            <tr>
                <td><span class="coupon-code">${c.maCode}</span></td>
                <td>${c.moTa || '-'}</td>
                <td>${c.loaiGiam}</td>
                <td><strong>${loaiText}</strong></td>
                <td>${c.donToiThieu?.toLocaleString()}ƒë</td>
                <td>${c.daSuDung}/${c.soLuong}</td>
                <td>
                    ${c.ngayBatDau ? new Date(c.ngayBatDau).toLocaleDateString('vi-VN') : '-'}
                    -
                    ${c.ngayKetThuc ? new Date(c.ngayKetThuc).toLocaleDateString('vi-VN') : '-'}
                </td>
                <td><span class="${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn-icon" onclick="editCoupon(${c.maMGG})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-danger" onclick="deleteCoupon(${c.maMGG})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateStats() {
    document.getElementById('totalCoupons').textContent = coupons.length;
    document.getElementById('activeCoupons').textContent = coupons.filter(c => c.trangThai && !c.hetHan).length;
    document.getElementById('totalUsed').textContent = coupons.reduce((sum, c) => sum + c.daSuDung, 0);
}

function updateValueLabel() {
    const loai = document.getElementById('loaiGiam').value;
    const label = document.getElementById('valueLabel');
    if (loai === 'percent') {
        label.textContent = 'Gi√° tr·ªã (%)';
    } else {
        label.textContent = 'Gi√° tr·ªã (ƒë)';
    }
}

function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Th√™m m√£ gi·∫£m gi√°';
    document.getElementById('couponForm').reset();
    document.getElementById('couponId').value = '';
    document.getElementById('couponModal').classList.add('active');
}

function editCoupon(id) {
    const c = coupons.find(x => x.maMGG === id);
    if (!c) return;
    
    document.getElementById('modalTitle').textContent = 'S·ª≠a m√£ gi·∫£m gi√°';
    document.getElementById('couponId').value = id;
    document.getElementById('maCode').value = c.maCode;
    document.getElementById('loaiGiam').value = c.loaiGiam;
    document.getElementById('moTa').value = c.moTa || '';
    document.getElementById('giaTri').value = c.giaTri;
    document.getElementById('giamToiDa').value = c.giamToiDa || '';
    document.getElementById('donToiThieu').value = c.donToiThieu;
    document.getElementById('soLuong').value = c.soLuong;
    document.getElementById('ngayBatDau').value = c.ngayBatDau ? c.ngayBatDau.split('T')[0] : '';
    document.getElementById('ngayKetThuc').value = c.ngayKetThuc ? c.ngayKetThuc.split('T')[0] : '';
    updateValueLabel();
    document.getElementById('couponModal').classList.add('active');
}

async function saveCoupon(e) {
    e.preventDefault();
    const id = document.getElementById('couponId').value;
    const data = {
        maCode: document.getElementById('maCode').value.toUpperCase(),
        loaiGiam: document.getElementById('loaiGiam').value,
        moTa: document.getElementById('moTa').value,
        giaTri: parseFloat(document.getElementById('giaTri').value) || 0,
        giamToiDa: parseFloat(document.getElementById('giamToiDa').value) || null,
        donToiThieu: parseFloat(document.getElementById('donToiThieu').value) || 0,
        soLuong: parseInt(document.getElementById('soLuong').value) || 100,
        ngayBatDau: document.getElementById('ngayBatDau').value || null,
        ngayKetThuc: document.getElementById('ngayKetThuc').value || null,
        trangThai: true
    };
    
    const url = id ? `/api/coupon/${id}` : '/api/coupon';
    const method = id ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    const result = await res.json();
    if (res.ok) {
        closeModal();
        loadCoupons();
        alert('L∆∞u th√†nh c√¥ng!');
    } else {
        alert(result.message || 'C√≥ l·ªói x·∫£y ra');
    }
}

async function deleteCoupon(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën v√¥ hi·ªáu h√≥a m√£ n√†y?')) return;
    
    const res = await fetch(`/api/coupon/${id}`, { method: 'DELETE' });
    if (res.ok) {
        loadCoupons();
        alert('ƒê√£ v√¥ hi·ªáu h√≥a!');
    }
}

function closeModal() {
    document.getElementById('couponModal').classList.remove('active');
}

loadCoupons();
</script>
}
