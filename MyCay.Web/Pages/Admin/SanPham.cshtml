@page
@model AdminSanPhamModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω s·∫£n ph·∫©m";
    Layout = "_AdminLayout";
}

<div class="page-header">
    <h1 class="page-title">Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m
        </button>
    </div>
</div>

<!-- Products Table -->
<div class="data-table-wrapper">
    <div class="table-header">
        <div class="table-search">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="T√¨m t√™n s·∫£n ph·∫©m, m√£..." onkeyup="filterProducts()" />
        </div>
        <div class="table-filters">
            <select id="categoryFilter" onchange="filterProducts()">
                <option value="">T·∫•t c·∫£ danh m·ª•c</option>
            </select>
            <select id="statusFilter" onchange="filterProducts()">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="1">ƒêang b√°n</option>
                <option value="0">Ng·ª´ng b√°n</option>
            </select>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>Danh m·ª•c</th>
                <th>Gi√°</th>
                <th>C·∫•p ƒë·ªô cay</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="productsTableBody">
            <!-- Products will be loaded here -->
        </tbody>
    </table>

    <div class="table-footer">
        <div class="table-info">Hi·ªÉn th·ªã <span id="showingCount">0</span> / <span id="totalCount">0</span> s·∫£n ph·∫©m</div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal-overlay" id="productModal">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="modalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="productForm">
                <input type="hidden" id="productId" />
                <div class="form-grid">
                    <div class="form-group">
                        <label>M√£ s·∫£n ph·∫©m</label>
                        <input type="text" id="productCode" placeholder="VD: M00012" />
                    </div>
                    <div class="form-group">
                        <label>Danh m·ª•c *</label>
                        <select id="productCategory" required>
                            <option value="">Ch·ªçn danh m·ª•c</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>T√™n s·∫£n ph·∫©m *</label>
                        <input type="text" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" required />
                    </div>
                    <div class="form-group full-width">
                        <label>M√¥ t·∫£</label>
                        <textarea id="productDesc" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Gi√° b√°n *</label>
                        <input type="number" id="productPrice" placeholder="VD: 69000" required />
                    </div>
                    <div class="form-group">
                        <label>Gi√° khuy·∫øn m√£i</label>
                        <input type="number" id="productSalePrice" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng KM" />
                    </div>
                    <div class="form-group">
                        <label>C·∫•p ƒë·ªô cay (0-7)</label>
                        <select id="productSpicy">
                            <option value="0">0 - Kh√¥ng cay</option>
                            <option value="1">1 - √çt cay</option>
                            <option value="2">2</option>
                            <option value="3">3 - Cay v·ª´a</option>
                            <option value="4">4</option>
                            <option value="5">5 - Cay nhi·ªÅu</option>
                            <option value="6">6</option>
                            <option value="7">7 - Si√™u cay</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select id="productStatus">
                            <option value="1">ƒêang b√°n</option>
                            <option value="0">Ng·ª´ng b√°n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>H√¨nh ·∫£nh</label>
                        <input type="text" id="productImage" placeholder="T√™n file ·∫£nh" />
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productFeatured" /> S·∫£n ph·∫©m n·ªïi b·∫≠t
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
            <button class="btn btn-primary" onclick="saveProduct()">L∆∞u s·∫£n ph·∫©m</button>
        </div>
    </div>
</div>

@section Scripts {
<script>
const categories = [
    { id: 1, name: 'M√¨ Cay' },
    { id: 2, name: 'M√¨ T∆∞∆°ng ƒêen' },
    { id: 3, name: 'M√¨ X√†o' },
    { id: 4, name: 'M√≥n Kh√°c' },
    { id: 5, name: 'M√≥n Th√™m M√¨' },
    { id: 6, name: 'Combo' },
    { id: 7, name: 'L·∫©u H√†n Qu·ªëc' },
    { id: 8, name: 'M√≥n Th√™m L·∫©u' },
    { id: 9, name: 'Khai V·ªã' },
    { id: 10, name: 'Gi·∫£i Kh√°t' }
];

let products = [];
let currentPage = 1;
const itemsPerPage = 10;

// Load products from API
async function loadProducts() {
    try {
        // Admin c·∫ßn xem t·∫•t c·∫£ s·∫£n ph·∫©m, k·ªÉ c·∫£ ng·ª´ng b√°n
        // Th√™m timestamp ƒë·ªÉ tr√°nh cache
        const response = await fetch('/api/products?includeInactive=true&pageSize=1000&_t=' + Date.now());
        const result = await response.json();
        console.log('API response:', result);
        
        // X·ª≠ l√Ω nhi·ªÅu format response c√≥ th·ªÉ c√≥
        let items = [];
        if (Array.isArray(result)) {
            items = result;
        } else if (result && Array.isArray(result.data)) {
            items = result.data;
        }
        
        products = items.map((p, i) => ({
            id: p.id || p.maSP,
            code: p.code || p.maSPCode || `SP${String(i+1).padStart(4, '0')}`,
            name: p.name || p.tenSP,
            desc: p.description || p.moTa,
            price: p.price || p.donGia,
            salePrice: p.salePrice || p.giaKhuyenMai,
            image: p.image || p.hinhAnh,
            categoryId: p.categoryId || p.maDM,
            spicy: p.spicyLevel || p.capDoCay || 0,
            status: p.isActive !== undefined ? (p.isActive ? 1 : 0) : 1,
            featured: p.isFeatured || p.noiBat
        }));
        renderProducts();
        loadCategories();
    } catch (e) {
        console.error('Error loading products:', e);
        showToast('L·ªói t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m!', 'error');
    }
}

// Load categories from API
async function loadCategories() {
    try {
        const response = await fetch('/api/products/categories');
        const result = await response.json();
        // API tr·∫£ v·ªÅ { success, data } - l·∫•y array t·ª´ result.data
        const data = result.data || result || [];
        categoriesData = Array.isArray(data) ? data : [];
        
        const select = document.getElementById('categoryFilter');
        const formSelect = document.getElementById('productCategory');
        
        // Clear existing options except first
        select.innerHTML = '<option value="">T·∫•t c·∫£ danh m·ª•c</option>';
        formSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';
        
        categoriesData.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            formSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    } catch (e) {
        console.error('Error loading categories:', e);
        // Fallback to static categories
        renderCategoryFilters();
    }
}

function getCategoryId(name) {
    if (name.includes('L·∫©u')) return 7;
    if (name.includes('Combo')) return 6;
    if (name.includes('Tr·ªôn T∆∞∆°ng ƒêen')) return 2;
    if (name.includes('X√†o')) return 3;
    if (name.includes('C∆°m') || name.includes('Tokbok') || name.includes('Mi·∫øn')) return 4;
    if (name.includes('Th√™m') && name.includes('L·∫©u')) return 8;
    if (name.includes('Th√™m') || name.includes('Tr·ª©ng') || name.includes('B√≤ Th√™m')) return 5;
    if (name.includes('Khoai') || name.includes('Ph√¥ Mai') || name.includes('Kimbap') || name.includes('G√† Vi√™n') || name.includes('Mandu') || name.includes('Salad')) return 9;
    if (name.includes('N∆∞·ªõc') || name.includes('Soda') || name.includes('Tr√†') || name.includes('Coca') || name.includes('Sprite') || name.includes('Sting')) return 10;
    return 1; // Default: M√¨ Cay
}

function getSpicyLevel(name) {
    if (name.includes('Sincay') || name.includes('Kim Chi') || name.includes('Cay')) return 3;
    return 0;
}

let categoriesData = [];

function renderCategoryFilters() {
    const select = document.getElementById('categoryFilter');
    const formSelect = document.getElementById('productCategory');
    categories.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        formSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
}

function getCategoryName(categoryId) {
    // Try from API data first
    const cat = categoriesData.find(c => c.id === categoryId);
    if (cat) return cat.name;
    
    // Fallback to static
    const staticCat = categories.find(c => c.id === categoryId);
    return staticCat?.name || '-';
}

function renderProducts() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const categoryId = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    let filtered = products.filter(p => {
        const matchSearch = p.name.toLowerCase().includes(search) || (p.code && p.code.toLowerCase().includes(search));
        const matchCategory = !categoryId || p.categoryId == categoryId;
        const matchStatus = status === '' || p.status == status;
        return matchSearch && matchCategory && matchStatus;
    });
    
    const start = (currentPage - 1) * itemsPerPage;
    const paged = filtered.slice(start, start + itemsPerPage);
    
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = paged.map(p => {
        // X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n h√¨nh ·∫£nh
        let imgSrc = '/images/products/MenuItem_M00012.webp'; // Default
        if (p.image) {
            if (p.image.startsWith('http')) {
                imgSrc = p.image;
            } else if (p.image.startsWith('/')) {
                imgSrc = p.image;
            } else {
                imgSrc = '/images/products/' + p.image;
            }
        }
        
        return `
        <tr>
            <td>
                <div class="product-cell">
                    <img src="${imgSrc}" class="product-img" onerror="this.src='/images/products/MenuItem_M00012.webp'" />
                    <div>
                        <div class="product-name">${p.name}</div>
                        <div class="product-code">${p.code || ''}</div>
                    </div>
                </div>
            </td>
            <td>${getCategoryName(p.categoryId)}</td>
            <td class="price">${p.price.toLocaleString()}ƒë</td>
            <td>${p.spicy > 0 ? 'üå∂Ô∏è'.repeat(Math.min(p.spicy, 7)) : '-'}</td>
            <td><span class="status-badge ${p.status ? 'active' : 'inactive'}">${p.status ? 'ƒêang b√°n' : 'Ng·ª´ng b√°n'}</span></td>
            <td class="actions">
                <button class="action-btn edit" onclick="editProduct(${p.id})" title="S·ª≠a"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete" onclick="deleteProduct(${p.id})" title="X√≥a"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `}).join('');
    
    document.getElementById('showingCount').textContent = paged.length;
    document.getElementById('totalCount').textContent = filtered.length;
    
    renderPagination(filtered.length);
}

function renderPagination(total) {
    const pages = Math.ceil(total / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    for (let i = 1; i <= Math.min(pages, 5); i++) {
        pagination.innerHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
}

function goToPage(page) {
    currentPage = page;
    renderProducts();
}

function filterProducts() {
    currentPage = 1;
    renderProducts();
}

function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productModal').classList.add('show');
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    document.getElementById('modalTitle').textContent = 'S·ª≠a s·∫£n ph·∫©m';
    document.getElementById('productId').value = product.id;
    document.getElementById('productCode').value = product.code || '';
    document.getElementById('productName').value = product.name;
    document.getElementById('productDesc').value = product.desc || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productSalePrice').value = product.salePrice || '';
    document.getElementById('productCategory').value = product.categoryId;
    document.getElementById('productSpicy').value = product.spicy;
    document.getElementById('productStatus').value = product.status;
    document.getElementById('productImage').value = product.image || '';
    document.getElementById('productFeatured').checked = product.featured;
    
    document.getElementById('productModal').classList.add('show');
}

function closeModal() {
    document.getElementById('productModal').classList.remove('show');
}

function saveProduct() {
    const id = document.getElementById('productId').value;
    const data = {
        code: document.getElementById('productCode').value,
        name: document.getElementById('productName').value,
        desc: document.getElementById('productDesc').value,
        price: parseInt(document.getElementById('productPrice').value),
        salePrice: document.getElementById('productSalePrice').value ? parseInt(document.getElementById('productSalePrice').value) : null,
        categoryId: parseInt(document.getElementById('productCategory').value),
        spicy: parseInt(document.getElementById('productSpicy').value),
        status: parseInt(document.getElementById('productStatus').value),
        image: document.getElementById('productImage').value,
        featured: document.getElementById('productFeatured').checked
    };
    
    if (!data.name || !data.price || !data.categoryId) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
        return;
    }
    
    if (id) {
        const index = products.findIndex(p => p.id == id);
        if (index > -1) {
            products[index] = { ...products[index], ...data };
        }
        showToast('C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
    } else {
        data.id = products.length + 1;
        products.unshift(data);
        showToast('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
    }
    
    closeModal();
    renderProducts();
}

function deleteProduct(id) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
        products = products.filter(p => p.id !== id);
        renderProducts();
        showToast('ƒê√£ x√≥a s·∫£n ph·∫©m!', 'warning');
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Init
loadProducts();
</script>
}
