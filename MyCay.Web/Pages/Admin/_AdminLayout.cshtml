<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Admin M·ª≥ Cay Sasin</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/Admin" class="admin-logo">
                    <span class="logo-icon">üå∂Ô∏è</span>
                    <span class="logo-text">M·ª≥ Cay Sasin</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">T·ªîNG QUAN</span>
                    <a href="/Admin" class="nav-item active">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">QU·∫¢N L√ù</span>
                    <a href="/Admin/DonHang" class="nav-item">
                        <i class="fas fa-shopping-bag"></i>
                        <span>ƒê∆°n h√†ng</span>
                        <span class="badge">3</span>
                    </a>
                    <a href="/Admin/SanPham" class="nav-item">
                        <i class="fas fa-utensils"></i>
                        <span>S·∫£n ph·∫©m</span>
                    </a>
                    <a href="/Admin/DanhMuc" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span>Danh m·ª•c</span>
                    </a>
                    <a href="/Admin/KhachHang" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Kh√°ch h√†ng</span>
                    </a>
                    <a href="/Admin/MaGiamGia" class="nav-item">
                        <i class="fas fa-ticket-alt"></i>
                        <span>M√£ gi·∫£m gi√°</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <span class="nav-section-title">V·∫¨N H√ÄNH</span>
                    <a href="/Admin/ChiNhanh" class="nav-item">
                        <i class="fas fa-store-alt"></i>
                        <span>Chi nh√°nh</span>
                    </a>
                    <a href="/Admin/Kho" class="nav-item">
                        <i class="fas fa-warehouse"></i>
                        <span>Kho & NVL</span>
                    </a>
                </div>

                <div class="nav-section admin-only">
                    <span class="nav-section-title">H·ªÜ TH·ªêNG</span>
                    <a href="/Admin/NhanVien" class="nav-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Nh√¢n vi√™n</span>
                    </a>
                    <a href="/Admin/CuaHang" class="nav-item">
                        <i class="fas fa-store"></i>
                        <span>C·ª≠a h√†ng</span>
                    </a>
                    <a href="/Admin/TaiKhoan" class="nav-item">
                        <i class="fas fa-user-cog"></i>
                        <span>T√†i kho·∫£n</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">B√ÅO C√ÅO</span>
                    <a href="/Admin/BaoCao" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>B√°o c√°o doanh thu</span>
                    </a>
                    <a href="/Admin/ThongKe" class="nav-item">
                        <i class="fas fa-chart-pie"></i>
                        <span>Th·ªëng k√™</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <a href="/" class="nav-item">
                    <i class="fas fa-globe"></i>
                    <span>Xem website</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="admin-main">
            <!-- Top Header -->
            <header class="admin-header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="header-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="T√¨m ki·∫øm..." />
                </div>

                <div class="header-actions">
                    <button class="header-btn notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </button>
                    
                    <div class="user-dropdown">
                        <button class="user-btn">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="user-name" id="headerUserName">Admin</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/Admin/Profile"><i class="fas fa-user-circle"></i> H·ªì s∆°</a>
                            <a href="/Admin/CaiDat"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a>
                            <hr />
                            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="admin-content">
                @RenderBody()
            </main>
        </div>
    </div>

    <script>
        // =====================================================
        // H·ªÜ TH·ªêNG PH√ÇN QUY·ªÄN
        // =====================================================
        
        // Chu·∫©n h√≥a role mapping (Database -> Frontend)
        const ROLE_MAP = {
            'quantrivien': 'admin',
            'quanly': 'manager', 
            'nhanvien': 'staff',
            'khachhang': 'customer',
            // Fallback cho c√°c role ƒë√£ chu·∫©n h√≥a
            'admin': 'admin',
            'manager': 'manager',
            'staff': 'staff',
            'customer': 'customer'
        };
        
        // Quy·ªÅn truy c·∫≠p theo role
        const PERMISSIONS = {
            admin: {
                pages: ['*'], // T·∫•t c·∫£ trang
                canManageStaff: true,
                canManageStore: true,
                canViewReports: true,
                canManageProducts: true,
                canManageOrders: true,
                canManageCustomers: true,
                canManageCoupons: true,
                canManageInventory: true
            },
            manager: {
                pages: ['/Admin', '/Admin/DonHang', '/Admin/SanPham', '/Admin/DanhMuc', '/Admin/KhachHang', 
                        '/Admin/MaGiamGia', '/Admin/ChiNhanh', '/Admin/Kho', '/Admin/BaoCao', '/Admin/ThongKe'],
                canManageStaff: false,
                canManageStore: false,
                canViewReports: true,
                canManageProducts: true,
                canManageOrders: true,
                canManageCustomers: true,
                canManageCoupons: true,
                canManageInventory: true
            },
            staff: {
                pages: ['/Admin', '/Admin/DonHang', '/Admin/SanPham', '/Admin/KhachHang'],
                canManageStaff: false,
                canManageStore: false,
                canViewReports: false,
                canManageProducts: false, // Ch·ªâ xem
                canManageOrders: true,    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                canManageCustomers: false,
                canManageCoupons: false,
                canManageInventory: false
            }
        };
        
        // L·∫•y th√¥ng tin user
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const rawRole = (user.role || '').toLowerCase();
        const normalizedRole = ROLE_MAP[rawRole] || 'customer';
        
        // C·∫≠p nh·∫≠t role ƒë√£ chu·∫©n h√≥a v√†o localStorage
        if (user.email && rawRole !== normalizedRole) {
            user.role = normalizedRole;
            localStorage.setItem('user', JSON.stringify(user));
        }
        
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† quy·ªÅn truy c·∫≠p
        const allowedRoles = ['admin', 'manager', 'staff'];
        if (!user.email || !allowedRoles.includes(normalizedRole)) {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!');
            window.location.href = '/DangNhap?returnUrl=' + encodeURIComponent(window.location.pathname);
        }
        
        // Ki·ªÉm tra quy·ªÅn truy c·∫≠p trang hi·ªán t·∫°i
        const currentPath = window.location.pathname;
        const userPermissions = PERMISSIONS[normalizedRole];
        
        if (userPermissions && !userPermissions.pages.includes('*')) {
            const hasAccess = userPermissions.pages.some(p => 
                currentPath === p || currentPath.startsWith(p + '/')
            );
            if (!hasAccess) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
                window.location.href = '/Admin';
            }
        }
        
        // L∆∞u permissions v√†o window ƒë·ªÉ c√°c trang con s·ª≠ d·ª•ng
        window.userPermissions = userPermissions;
        window.userRole = normalizedRole;

        // Update user name v√† role badge
        if (user.name) {
            document.getElementById('headerUserName').textContent = user.name;
        }
        
        // Th√™m role badge
        const roleBadges = {
            admin: '<span class="role-badge admin">Qu·∫£n tr·ªã vi√™n</span>',
            manager: '<span class="role-badge manager">Qu·∫£n l√Ω</span>',
            staff: '<span class="role-badge staff">Nh√¢n vi√™n</span>'
        };
        const userNameEl = document.getElementById('headerUserName');
        if (userNameEl && roleBadges[normalizedRole]) {
            userNameEl.insertAdjacentHTML('afterend', roleBadges[normalizedRole]);
        }

        // ·∫®n menu theo quy·ªÅn
        document.querySelectorAll('.admin-only').forEach(el => {
            if (normalizedRole !== 'admin') el.style.display = 'none';
        });
        
        // ·∫®n menu b√°o c√°o n·∫øu kh√¥ng c√≥ quy·ªÅn
        if (!userPermissions?.canViewReports) {
            document.querySelectorAll('a[href*="BaoCao"], a[href*="ThongKe"]').forEach(el => {
                el.closest('.nav-item')?.remove();
            });
        }

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // User dropdown
        document.querySelector('.user-btn').addEventListener('click', function() {
            document.querySelector('.dropdown-menu').classList.toggle('show');
        });

        // Active nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.getAttribute('href') === currentPath) {
                item.classList.add('active');
            } else if (currentPath !== '/Admin' && item.getAttribute('href') !== '/Admin') {
                item.classList.remove('active');
            }
        });

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/DangNhap';
        }
        
        // Helper function ƒë·ªÉ ki·ªÉm tra quy·ªÅn (d√πng trong c√°c trang con)
        window.checkPermission = function(permission) {
            return window.userPermissions?.[permission] === true;
        };
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
