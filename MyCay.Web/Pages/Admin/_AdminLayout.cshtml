<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Admin M·ª≥ Cay Sasin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∂Ô∏è</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/Admin" class="admin-logo">
                    <span class="logo-icon">üå∂Ô∏è</span>
                    <span class="logo-text">M·ª≥ Cay Sasin</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">T·ªîNG QUAN</span>
                    <a href="/Admin" class="nav-item active">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">QU·∫¢N L√ù</span>
                    <a href="/Admin/DonHang" class="nav-item">
                        <i class="fas fa-shopping-bag"></i>
                        <span>ƒê∆°n h√†ng</span>
                        <span class="badge">3</span>
                    </a>
                    <a href="/Admin/SanPham" class="nav-item">
                        <i class="fas fa-utensils"></i>
                        <span>S·∫£n ph·∫©m</span>
                    </a>
                    <a href="/Admin/DanhMuc" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span>Danh m·ª•c</span>
                    </a>
                    <a href="/Admin/KhachHang" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Kh√°ch h√†ng</span>
                    </a>
                    <a href="/Admin/MaGiamGia" class="nav-item">
                        <i class="fas fa-ticket-alt"></i>
                        <span>M√£ gi·∫£m gi√°</span>
                    </a>
                    <a href="/Admin/DanhGia" class="nav-item">
                        <i class="fas fa-star"></i>
                        <span>ƒê√°nh gi√°</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <span class="nav-section-title">V·∫¨N H√ÄNH</span>
                    <a href="/Admin/ChiNhanh" class="nav-item">
                        <i class="fas fa-store-alt"></i>
                        <span>Chi nh√°nh</span>
                    </a>
                    <a href="/Admin/Kho" class="nav-item">
                        <i class="fas fa-warehouse"></i>
                        <span>Kho & NVL</span>
                    </a>
                </div>

                <div class="nav-section admin-only">
                    <span class="nav-section-title">H·ªÜ TH·ªêNG</span>
                    <a href="/Admin/NhanVien" class="nav-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Nh√¢n vi√™n</span>
                    </a>
                    <a href="/Admin/CuaHang" class="nav-item">
                        <i class="fas fa-store"></i>
                        <span>C·ª≠a h√†ng</span>
                    </a>
                    <a href="/Admin/TaiKhoan" class="nav-item">
                        <i class="fas fa-user-cog"></i>
                        <span>T√†i kho·∫£n</span>
                    </a>
                </div>

                <div class="nav-section">
                    <span class="nav-section-title">B√ÅO C√ÅO</span>
                    <a href="/Admin/BaoCao" class="nav-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>B√°o c√°o doanh thu</span>
                    </a>
                    <a href="/Admin/ThongKe" class="nav-item">
                        <i class="fas fa-chart-pie"></i>
                        <span>Th·ªëng k√™</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <a href="/" class="nav-item">
                    <i class="fas fa-globe"></i>
                    <span>Xem website</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="admin-main">
            <!-- Top Header -->
            <header class="admin-header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="header-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="T√¨m ki·∫øm..." />
                </div>

                <div class="header-actions">
                    <button class="header-btn notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </button>
                    
                    <div class="user-dropdown">
                        <button class="user-btn">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="user-name" id="headerUserName">Admin</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/Admin/Profile"><i class="fas fa-user-circle"></i> H·ªì s∆°</a>
                            <a href="/Admin/CaiDat"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a>
                            <hr />
                            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="admin-content">
                @RenderBody()
            </main>
        </div>
    </div>

    <script>
        // =====================================================
        // H·ªÜ TH·ªêNG PH√ÇN QUY·ªÄN - N√ÇNG C·∫§P ƒê·∫¶Y ƒê·ª¶
        // =====================================================
        
        // Chu·∫©n h√≥a role mapping (Database -> Frontend)
        const ROLE_MAP = {
            'quantrivien': 'admin',
            'quanlycuahang': 'storemanager',
            'quanly': 'storemanager', 
            'nhanvien': 'staff',
            'khachhang': 'customer',
            // Fallback cho c√°c role ƒë√£ chu·∫©n h√≥a
            'admin': 'admin',
            'storemanager': 'storemanager',
            'manager': 'storemanager',
            'staff': 'staff',
            'customer': 'customer'
        };
        
        // T√™n hi·ªÉn th·ªã vai tr√≤
        const ROLE_NAMES = {
            admin: 'Qu·∫£n tr·ªã h·ªá th·ªëng',
            storemanager: 'Qu·∫£n l√Ω c·ª≠a h√†ng',
            staff: 'Nh√¢n vi√™n x·ª≠ l√Ω ƒë∆°n',
            customer: 'Kh√°ch h√†ng'
        };
        
        // =====================================================
        // ƒê·ªäNH NGHƒ®A QUY·ªÄN CHI TI·∫æT THEO VAI TR√í
        // =====================================================
        const PERMISSIONS = {
            // ===== ADMIN - To√†n quy·ªÅn h·ªá th·ªëng =====
            admin: {
                pages: ['*'], // T·∫•t c·∫£ trang
                // Qu·∫£n l√Ω t√†i kho·∫£n
                canCreateAccount: true,
                canEditAccount: true,
                canDeleteAccount: true,
                canLockAccount: true,
                canAssignRole: true,
                // Qu·∫£n l√Ω ph√¢n quy·ªÅn
                canManageRoles: true,
                canViewActivityLog: true,
                // C·∫•u h√¨nh h·ªá th·ªëng
                canConfigSystem: true,
                canConfigEmail: true,
                canConfigShipping: true,
                // B√°o c√°o t·ªïng h·ª£p
                canViewAllReports: true,
                canViewSystemStats: true,
                // Qu·∫£n l√Ω c·ª≠a h√†ng
                canManageAllStores: true,
                canCreateStore: true,
                canDeleteStore: true,
                // Qu·∫£n l√Ω s·∫£n ph·∫©m
                canManageProducts: true,
                canCreateProduct: true,
                canEditProduct: true,
                canDeleteProduct: true,
                // Qu·∫£n l√Ω ƒë∆°n h√†ng
                canManageAllOrders: true,
                canAssignOrderToStaff: true,
                canCancelOrder: true,
                // Qu·∫£n l√Ω kh√°ch h√†ng
                canManageCustomers: true,
                canViewCustomerDetails: true,
                // Qu·∫£n l√Ω nh√¢n vi√™n
                canManageStaff: true,
                canCreateStaff: true,
                canDeleteStaff: true,
                // Kh√°c
                canManageCoupons: true,
                canManageInventory: true,
                canManageCategories: true,
                canManageReviews: true
            },
            
            // ===== STORE MANAGER - Qu·∫£n l√Ω c·ª≠a h√†ng =====
            storemanager: {
                pages: ['/Admin', '/Admin/DonHang', '/Admin/SanPham', '/Admin/DanhMuc', '/Admin/KhachHang', 
                        '/Admin/MaGiamGia', '/Admin/DanhGia', '/Admin/ChiNhanh', '/Admin/Kho', 
                        '/Admin/NhanVien', '/Admin/BaoCao', '/Admin/ThongKe'],
                // Qu·∫£n l√Ω t√†i kho·∫£n (ch·ªâ nh√¢n vi√™n c·ª≠a h√†ng m√¨nh)
                canCreateAccount: true,  // Ch·ªâ t·∫°o t√†i kho·∫£n nh√¢n vi√™n
                canEditAccount: true,    // Ch·ªâ s·ª≠a nh√¢n vi√™n c·ª≠a h√†ng m√¨nh
                canDeleteAccount: false,
                canLockAccount: true,    // Kh√≥a nh√¢n vi√™n c·ª≠a h√†ng m√¨nh
                canAssignRole: false,    // Kh√¥ng ƒë∆∞·ª£c g√°n role admin
                // Qu·∫£n l√Ω ph√¢n quy·ªÅn
                canManageRoles: false,
                canViewActivityLog: true, // Xem log c·ª≠a h√†ng m√¨nh
                // C·∫•u h√¨nh h·ªá th·ªëng
                canConfigSystem: false,
                canConfigEmail: false,
                canConfigShipping: false,
                // B√°o c√°o
                canViewAllReports: false,
                canViewStoreReports: true, // Ch·ªâ xem b√°o c√°o c·ª≠a h√†ng m√¨nh
                canViewSystemStats: false,
                // Qu·∫£n l√Ω c·ª≠a h√†ng
                canManageAllStores: false,
                canManageOwnStore: true,  // Qu·∫£n l√Ω c·ª≠a h√†ng ƒë∆∞·ª£c g√°n
                canCreateStore: false,
                canDeleteStore: false,
                // Qu·∫£n l√Ω s·∫£n ph·∫©m (c·ª≠a h√†ng m√¨nh)
                canManageProducts: true,
                canCreateProduct: true,
                canEditProduct: true,
                canDeleteProduct: true,   // X√≥a/·∫©n s·∫£n ph·∫©m c·ª≠a h√†ng m√¨nh
                // Qu·∫£n l√Ω ƒë∆°n h√†ng (c·ª≠a h√†ng m√¨nh)
                canManageStoreOrders: true,
                canAssignOrderToStaff: true, // Ph√¢n c√¥ng ƒë∆°n cho nh√¢n vi√™n
                canApproveOrder: true,       // Duy·ªát/x√°c nh·∫≠n ƒë∆°n
                canCancelOrder: true,        // H·ªßy ƒë∆°n c√≥ v·∫•n ƒë·ªÅ
                canManageAllOrders: false,
                // Qu·∫£n l√Ω kh√°ch h√†ng
                canManageCustomers: true,
                canViewCustomerDetails: true,
                // Qu·∫£n l√Ω nh√¢n vi√™n (c·ª≠a h√†ng m√¨nh)
                canManageStaff: true,
                canCreateStaff: true,
                canDeleteStaff: true,
                canAssignStaffToOrder: true,
                // Kh√°c
                canManageCoupons: true,
                canManageInventory: true,
                canManageCategories: true,  // Danh m·ª•c con c·ª≠a h√†ng
                canManageReviews: true,
                canViewStaffPerformance: true // Xem hi·ªáu su·∫•t nh√¢n vi√™n
            },
            
            // ===== STAFF - Nh√¢n vi√™n x·ª≠ l√Ω ƒë∆°n =====
            staff: {
                pages: ['/Admin', '/Admin/DonHang', '/Admin/SanPham', '/Admin/KhachHang'],
                // Qu·∫£n l√Ω t√†i kho·∫£n
                canCreateAccount: false,
                canEditAccount: false,
                canDeleteAccount: false,
                canLockAccount: false,
                canAssignRole: false,
                // Qu·∫£n l√Ω ph√¢n quy·ªÅn
                canManageRoles: false,
                canViewActivityLog: false,
                // C·∫•u h√¨nh h·ªá th·ªëng
                canConfigSystem: false,
                canConfigEmail: false,
                canConfigShipping: false,
                // B√°o c√°o
                canViewAllReports: false,
                canViewStoreReports: false,
                canViewSystemStats: false,
                // Qu·∫£n l√Ω c·ª≠a h√†ng
                canManageAllStores: false,
                canManageOwnStore: false,
                canCreateStore: false,
                canDeleteStore: false,
                // Qu·∫£n l√Ω s·∫£n ph·∫©m
                canManageProducts: false,
                canCreateProduct: false,
                canEditProduct: false,
                canDeleteProduct: false,
                canViewProducts: true,      // Ch·ªâ xem s·∫£n ph·∫©m
                // Qu·∫£n l√Ω ƒë∆°n h√†ng (ch·ªâ ƒë∆°n ƒë∆∞·ª£c ph√¢n c√¥ng)
                canManageAssignedOrders: true, // X·ª≠ l√Ω ƒë∆°n ƒë∆∞·ª£c giao
                canConfirmOrder: true,         // X√°c nh·∫≠n ƒë∆°n
                canPrepareOrder: true,         // Chu·∫©n b·ªã h√†ng
                canUpdateOrderStatus: true,    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                canAddOrderNote: true,         // Ghi ch√∫ s·ª± c·ªë
                canCancelOrder: false,         // Kh√¥ng ƒë∆∞·ª£c h·ªßy ƒë∆°n
                canManageAllOrders: false,
                canAssignOrderToStaff: false,
                // Qu·∫£n l√Ω kh√°ch h√†ng
                canManageCustomers: false,
                canViewCustomerDetails: true, // Xem th√¥ng tin ƒë·ªÉ li√™n h·ªá
                // Qu·∫£n l√Ω nh√¢n vi√™n
                canManageStaff: false,
                canCreateStaff: false,
                canDeleteStaff: false,
                // Kh√°c
                canManageCoupons: false,
                canManageInventory: false,
                canUpdateInventory: true,     // Tr·ª´ t·ªìn kho khi chu·∫©n b·ªã
                canManageCategories: false,
                canManageReviews: false,
                canPrintPackingSlip: true     // In phi·∫øu g√≥i h√†ng
            },
            
            // ===== CUSTOMER - Kh√°ch h√†ng (kh√¥ng v√†o Admin) =====
            customer: {
                pages: [], // Kh√¥ng ƒë∆∞·ª£c v√†o Admin
                // T·∫•t c·∫£ quy·ªÅn admin ƒë·ªÅu false
                canCreateAccount: false,
                canEditAccount: false,
                canManageProducts: false,
                canManageOrders: false,
                canManageCustomers: false,
                canManageStaff: false,
                canViewReports: false
            }
        };
        
        // L·∫•y th√¥ng tin user
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const rawRole = (user.role || '').toLowerCase();
        const normalizedRole = ROLE_MAP[rawRole] || 'customer';
        const userStoreId = user.storeId || null; // ID c·ª≠a h√†ng ƒë∆∞·ª£c g√°n
        
        // C·∫≠p nh·∫≠t role ƒë√£ chu·∫©n h√≥a v√†o localStorage
        if (user.email && rawRole !== normalizedRole) {
            user.role = normalizedRole;
            localStorage.setItem('user', JSON.stringify(user));
        }
        
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† quy·ªÅn truy c·∫≠p
        const allowedRoles = ['admin', 'storemanager', 'staff'];
        if (!user.email || !allowedRoles.includes(normalizedRole)) {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!');
            window.location.href = '/DangNhap?returnUrl=' + encodeURIComponent(window.location.pathname);
        }
        
        // Ki·ªÉm tra quy·ªÅn truy c·∫≠p trang hi·ªán t·∫°i
        const currentPath = window.location.pathname;
        const userPermissions = PERMISSIONS[normalizedRole];
        
        if (userPermissions && !userPermissions.pages.includes('*')) {
            const hasAccess = userPermissions.pages.some(p => 
                currentPath === p || currentPath.startsWith(p + '/')
            );
            if (!hasAccess) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
                window.location.href = '/Admin';
            }
        }
        
        // L∆∞u permissions v√†o window ƒë·ªÉ c√°c trang con s·ª≠ d·ª•ng
        window.userPermissions = userPermissions;
        window.userRole = normalizedRole;
        window.userStoreId = userStoreId;
        window.ROLE_NAMES = ROLE_NAMES;

        // Update user name v√† role badge
        if (user.name) {
            document.getElementById('headerUserName').textContent = user.name;
        }
        
        // Th√™m role badge v·ªõi t√™n ƒë·∫ßy ƒë·ªß
        const roleBadges = {
            admin: '<span class="role-badge admin">Qu·∫£n tr·ªã vi√™n</span>',
            storemanager: '<span class="role-badge manager">Qu·∫£n l√Ω c·ª≠a h√†ng</span>',
            staff: '<span class="role-badge staff">Nh√¢n vi√™n</span>'
        };
        const userNameEl = document.getElementById('headerUserName');
        if (userNameEl && roleBadges[normalizedRole]) {
            userNameEl.insertAdjacentHTML('afterend', roleBadges[normalizedRole]);
        }

        // ·∫®n menu theo quy·ªÅn chi ti·∫øt
        // Menu H·ªÜ TH·ªêNG - ch·ªâ Admin
        document.querySelectorAll('.admin-only').forEach(el => {
            if (normalizedRole !== 'admin') el.style.display = 'none';
        });
        
        // ·∫®n menu b√°o c√°o n·∫øu kh√¥ng c√≥ quy·ªÅn
        if (!userPermissions?.canViewAllReports && !userPermissions?.canViewStoreReports) {
            document.querySelectorAll('a[href*="BaoCao"], a[href*="ThongKe"]').forEach(el => {
                el.closest('.nav-item')?.classList.add('permission-hidden');
            });
        }
        
        // ·∫®n menu Kho n·∫øu kh√¥ng c√≥ quy·ªÅn
        if (!userPermissions?.canManageInventory && !userPermissions?.canUpdateInventory) {
            document.querySelector('a[href*="Kho"]')?.classList.add('permission-hidden');
        }
        
        // ·∫®n menu M√£ gi·∫£m gi√° n·∫øu kh√¥ng c√≥ quy·ªÅn
        if (!userPermissions?.canManageCoupons) {
            document.querySelector('a[href*="MaGiamGia"]')?.classList.add('permission-hidden');
        }
        
        // ·∫®n menu Danh m·ª•c n·∫øu kh√¥ng c√≥ quy·ªÅn
        if (!userPermissions?.canManageCategories) {
            document.querySelector('a[href*="DanhMuc"]')?.classList.add('permission-hidden');
        }
        
        // ·∫®n menu ƒê√°nh gi√° n·∫øu kh√¥ng c√≥ quy·ªÅn
        if (!userPermissions?.canManageReviews) {
            document.querySelector('a[href*="DanhGia"]')?.classList.add('permission-hidden');
        }

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // User dropdown
        document.querySelector('.user-btn').addEventListener('click', function() {
            document.querySelector('.dropdown-menu').classList.toggle('show');
        });

        // Active nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.getAttribute('href') === currentPath) {
                item.classList.add('active');
            } else if (currentPath !== '/Admin' && item.getAttribute('href') !== '/Admin') {
                item.classList.remove('active');
            }
        });

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = '/DangNhap';
        }
        
        // =====================================================
        // HELPER FUNCTIONS CHO PH√ÇN QUY·ªÄN
        // =====================================================
        
        // Ki·ªÉm tra quy·ªÅn c·ª• th·ªÉ
        window.checkPermission = function(permission) {
            return window.userPermissions?.[permission] === true;
        };
        
        // Ki·ªÉm tra c√≥ ph·∫£i Admin kh√¥ng
        window.isAdmin = function() {
            return window.userRole === 'admin';
        };
        
        // Ki·ªÉm tra c√≥ ph·∫£i Store Manager kh√¥ng
        window.isStoreManager = function() {
            return window.userRole === 'storemanager';
        };
        
        // Ki·ªÉm tra c√≥ ph·∫£i Staff kh√¥ng
        window.isStaff = function() {
            return window.userRole === 'staff';
        };
        
        // L·∫•y ID c·ª≠a h√†ng c·ªßa user (d√πng ƒë·ªÉ filter d·ªØ li·ªáu)
        window.getUserStoreId = function() {
            return window.userStoreId;
        };
        
        // ·∫®n element n·∫øu kh√¥ng c√≥ quy·ªÅn
        window.hideIfNoPermission = function(elementSelector, permission) {
            if (!checkPermission(permission)) {
                document.querySelectorAll(elementSelector).forEach(el => {
                    el.style.display = 'none';
                });
            }
        };
        
        // Disable element n·∫øu kh√¥ng c√≥ quy·ªÅn
        window.disableIfNoPermission = function(elementSelector, permission) {
            if (!checkPermission(permission)) {
                document.querySelectorAll(elementSelector).forEach(el => {
                    el.disabled = true;
                    el.classList.add('btn-disabled');
                    el.title = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y';
                });
            }
        };
        
        // L·∫•y t√™n vai tr√≤
        window.getRoleName = function(role) {
            return ROLE_NAMES[role] || role;
        };
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
