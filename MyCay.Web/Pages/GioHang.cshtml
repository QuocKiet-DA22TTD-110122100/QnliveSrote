@page
@model GioHangModel
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<!-- Promo Banner -->
<div class="cart-promo-banner">
    <div class="promo-content">
        <span>üöö Mi·ªÖn ph√≠ ship t·ª´ <strong>200k</strong></span>
        <span class="divider">|</span>
        <span>‚ö° Giao ch·ªâ <strong>30 ph√∫t</strong></span>
    </div>
</div>

<!-- Checkout Progress -->
<div class="checkout-progress">
    <div class="progress-step active">
        <div class="step-num">1</div>
        <span>Gi·ªè h√†ng</span>
    </div>
    <div class="progress-line"></div>
    <div class="progress-step">
        <div class="step-num">2</div>
        <span>Thanh to√°n</span>
    </div>
    <div class="progress-line"></div>
    <div class="progress-step">
        <div class="step-num">3</div>
        <span>Ho√†n t·∫•t</span>
    </div>
</div>

<section class="cart-section">
    <div class="container">
        <!-- Cart Header -->
        <div class="cart-title">
            <h1>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>
            <p id="cartPageCount">0 s·∫£n ph·∫©m</p>
        </div>

        <!-- Cart Content -->
        <div class="cart-wrapper" id="cartWrapper">
            <!-- Cart Items -->
            <div class="cart-items-box">
                <div class="items-header">
                    <label class="select-all">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" />
                        <span>Ch·ªçn t·∫•t c·∫£</span>
                    </label>
                    <button class="btn-delete-selected" onclick="deleteSelected()" id="btnDeleteSelected" style="display:none;">
                        <i class="fas fa-trash"></i> X√≥a ƒë√£ ch·ªçn
                    </button>
                </div>
                
                <div class="cart-items-list" id="cartItemsList">
                    <!-- Items loaded by JS -->
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary-box">
                <h3>üìã T√≥m t·∫Øt</h3>
                <div class="summary-info">
                    <div class="summary-line">
                        <span>ƒê√£ ch·ªçn</span>
                        <span><strong id="selectedCount">0</strong> s·∫£n ph·∫©m</span>
                    </div>
                    <div class="summary-line">
                        <span>T·∫°m t√≠nh</span>
                        <span id="subtotal">0ƒë</span>
                    </div>
                    <div class="summary-line shipping">
                        <span>Ph√≠ ship d·ª± ki·∫øn</span>
                        <span id="shippingFee">25.000ƒë</span>
                    </div>
                </div>
                <div class="summary-total">
                    <span>T·ªïng c·ªông</span>
                    <span id="totalAmount">0ƒë</span>
                </div>
                
                <div class="freeship-progress" id="freeshipProgress">
                    <p id="freeshipText">C√≤n <strong>200.000ƒë</strong> ƒë·ªÉ mi·ªÖn ph√≠ ship</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                </div>
                
                <button class="btn-checkout" onclick="goToCheckout()" id="btnCheckout" disabled>
                    <i class="fas fa-credit-card"></i>
                    Mua h√†ng (<span id="btnSelectedCount">0</span>)
                </button>
                
                <a href="/ThucDon" class="btn-continue">
                    <i class="fas fa-plus"></i> Th√™m m√≥n kh√°c
                </a>
            </div>
        </div>

        <!-- Empty Cart -->
        <div class="empty-cart" id="emptyCart" style="display:none;">
            <div class="empty-icon">üõí</div>
            <h2>Gi·ªè h√†ng tr·ªëng</h2>
            <p>H√£y th√™m m√≥n ngon v√†o gi·ªè h√†ng nh√©!</p>
            <a href="/ThucDon" class="btn-shop">
                <i class="fas fa-utensils"></i> Xem th·ª±c ƒë∆°n
            </a>
        </div>
    </div>
</section>

<style>
/* Promo Banner */
.cart-promo-banner {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    padding: 12px 20px;
    text-align: center;
}
.promo-content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    font-size: 0.95rem;
}
.promo-content .divider { opacity: 0.5; }

/* Progress Steps */
.checkout-progress {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}
.progress-step {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #9ca3af;
    font-weight: 500;
}
.progress-step.active { color: #f97316; }
.step-num {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
}
.progress-step.active .step-num {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}
.progress-line {
    width: 50px;
    height: 3px;
    background: #e5e7eb;
    margin: 0 12px;
}

/* Cart Section */
.cart-section {
    background: #f8fafc;
    min-height: calc(100vh - 200px);
    padding: 25px 15px 50px;
}
.cart-title {
    text-align: center;
    margin-bottom: 25px;
}
.cart-title h1 {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 5px;
}
.cart-title p { color: #6b7280; }

/* Cart Wrapper */
.cart-wrapper {
    display: flex;
    gap: 25px;
    max-width: 1000px;
    margin: 0 auto;
}

/* Cart Items Box */
.cart-items-box {
    flex: 1;
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.items-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 2px solid #f3f4f6;
    margin-bottom: 15px;
}
.select-all {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 600;
    color: #374151;
}
.select-all input {
    width: 20px;
    height: 20px;
    accent-color: #f97316;
}
.btn-delete-selected {
    background: #fef2f2;
    color: #ef4444;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}
.btn-delete-selected:hover { background: #ef4444; color: white; }

/* Cart Item */
.cart-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f3f4f6;
}
.cart-item:last-child { border-bottom: none; }
.item-checkbox {
    width: 22px;
    height: 22px;
    accent-color: #f97316;
    cursor: pointer;
}
.item-image {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    overflow: hidden;
    flex-shrink: 0;
}
.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.item-details {
    flex: 1;
    min-width: 0;
}
.item-name {
    font-size: 1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.item-options {
    display: inline-block;
    font-size: 0.8rem;
    color: #f97316;
    background: #fff7ed;
    padding: 3px 10px;
    border-radius: 12px;
    margin-bottom: 4px;
}
.item-unit-price {
    font-size: 0.85rem;
    color: #6b7280;
}
.item-quantity {
    display: flex;
    align-items: center;
    gap: 0;
    background: #f3f4f6;
    border-radius: 10px;
    overflow: hidden;
}
.qty-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    font-size: 1.1rem;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
}
.qty-btn:hover { background: #f97316; color: white; }
.qty-value {
    width: 40px;
    text-align: center;
    font-weight: 700;
    font-size: 1rem;
}
.item-total {
    min-width: 90px;
    text-align: right;
    font-size: 1.05rem;
    font-weight: 700;
    color: #f97316;
}
.item-remove {
    width: 36px;
    height: 36px;
    border: none;
    background: #fef2f2;
    color: #ef4444;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1rem;
}
.item-remove:hover { background: #ef4444; color: white; }

/* Cart Summary Box */
.cart-summary-box {
    width: 320px;
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    height: fit-content;
    position: sticky;
    top: 100px;
}
.cart-summary-box h3 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f3f4f6;
}
.summary-info { margin-bottom: 15px; }
.summary-line {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 0.95rem;
    color: #4b5563;
}
.summary-line.shipping { color: #6b7280; font-size: 0.9rem; }
.summary-total {
    display: flex;
    justify-content: space-between;
    padding: 15px 0;
    border-top: 2px solid #1f2937;
    font-weight: 700;
}
.summary-total span:first-child { font-size: 1rem; color: #1f2937; }
.summary-total span:last-child { font-size: 1.3rem; color: #f97316; }

/* Freeship Progress */
.freeship-progress {
    background: #ecfdf5;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 15px;
}
.freeship-progress p {
    font-size: 0.85rem;
    color: #065f46;
    margin-bottom: 8px;
}
.freeship-progress.achieved {
    background: #d1fae5;
}
.freeship-progress.achieved p {
    color: #059669;
    font-weight: 600;
}
.progress-bar {
    height: 8px;
    background: #a7f3d0;
    border-radius: 4px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    border-radius: 4px;
    transition: width 0.5s ease;
}

/* Buttons */
.btn-checkout {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
    box-shadow: 0 6px 20px rgba(249,115,22,0.4);
    margin-bottom: 12px;
}
.btn-checkout:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(249,115,22,0.5);
}
.btn-checkout:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    box-shadow: none;
}
.btn-continue {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 12px;
    background: #f3f4f6;
    color: #374151;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}
.btn-continue:hover { background: #e5e7eb; }

/* Empty Cart */
.empty-cart {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 20px;
    max-width: 400px;
    margin: 0 auto;
}
.empty-icon { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }
.empty-cart h2 { font-size: 1.3rem; color: #1f2937; margin-bottom: 8px; }
.empty-cart p { color: #6b7280; margin-bottom: 20px; }
.btn-shop {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
}
.btn-shop:hover { transform: translateY(-2px); }

/* Responsive */
@@media (max-width: 768px) {
    .cart-wrapper { flex-direction: column; }
    .cart-summary-box { width: 100%; position: static; }
    .cart-item { flex-wrap: wrap; }
    .item-details { width: calc(100% - 120px); }
    .item-quantity { margin-left: auto; }
    .item-total { width: 100%; text-align: left; margin-top: 10px; padding-left: 37px; }
    .progress-step span { display: none; }
}
</style>

@section Scripts {
<script>
    const FREE_SHIP_THRESHOLD = 200000;
    const SHIPPING_FEE = 25000;

    function loadCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const container = document.getElementById('cartItemsList');
        const emptyCart = document.getElementById('emptyCart');
        const cartWrapper = document.getElementById('cartWrapper');

        if (cart.length === 0) {
            cartWrapper.style.display = 'none';
            emptyCart.style.display = 'block';
            document.getElementById('cartPageCount').textContent = '0 s·∫£n ph·∫©m';
            return;
        }

        cartWrapper.style.display = 'flex';
        emptyCart.style.display = 'none';
        
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartPageCount').textContent = `${totalItems} s·∫£n ph·∫©m`;

        container.innerHTML = cart.map((item, index) => `
            <div class="cart-item" data-index="${index}">
                <input type="checkbox" class="item-checkbox" data-index="${index}" onchange="updateSelection()" />
                <div class="item-image">
                    <img src="/images/products/${item.image || 'MenuItem_MI0001.webp'}" alt="${item.name}" 
                         onerror="this.src='/images/products/MenuItem_MI0001.webp'" />
                </div>
                <div class="item-details">
                    <h4 class="item-name">${item.name}</h4>
                    ${item.broth ? `<span class="item-options">üçú ${item.broth} | üå∂Ô∏è C·∫•p ${item.spicyLevel}</span>` : ''}
                    <div class="item-unit-price">${formatPrice(item.price)}ƒë / ph·∫ßn</div>
                </div>
                <div class="item-quantity">
                    <button class="qty-btn" onclick="updateQty(${index}, -1)">‚àí</button>
                    <span class="qty-value">${item.quantity}</span>
                    <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                </div>
                <div class="item-total">${formatPrice(item.price * item.quantity)}ƒë</div>
                <button class="item-remove" onclick="removeItem(${index})" title="X√≥a">üóëÔ∏è</button>
            </div>
        `).join('');

        updateSelection();
    }

    function updateQty(index, delta) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart[index]) {
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            updateCartBadge();
        }
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartBadge();
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = selectAll);
        updateSelection();
    }

    function updateSelection() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const checkboxes = document.querySelectorAll('.item-checkbox');
        const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
        
        // Update select all checkbox
        document.getElementById('selectAll').checked = checkboxes.length > 0 && checkedBoxes.length === checkboxes.length;
        
        // Show/hide delete button
        document.getElementById('btnDeleteSelected').style.display = checkedBoxes.length > 0 ? 'flex' : 'none';
        
        // Calculate selected items
        let selectedItems = [];
        let subtotal = 0;
        
        checkedBoxes.forEach(cb => {
            const index = parseInt(cb.dataset.index);
            if (cart[index]) {
                selectedItems.push(cart[index]);
                subtotal += cart[index].price * cart[index].quantity;
            }
        });
        
        const selectedCount = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
        const shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : (subtotal > 0 ? SHIPPING_FEE : 0);
        const total = subtotal + shipping;
        
        // Update UI
        document.getElementById('selectedCount').textContent = selectedCount;
        document.getElementById('btnSelectedCount').textContent = selectedCount;
        document.getElementById('subtotal').textContent = formatPrice(subtotal) + 'ƒë';
        document.getElementById('shippingFee').textContent = shipping === 0 && subtotal > 0 ? 'Mi·ªÖn ph√≠ üéâ' : formatPrice(shipping) + 'ƒë';
        document.getElementById('totalAmount').textContent = formatPrice(total) + 'ƒë';
        
        // Update freeship progress
        const progress = Math.min(100, (subtotal / FREE_SHIP_THRESHOLD) * 100);
        document.getElementById('progressFill').style.width = progress + '%';
        
        const freeshipEl = document.getElementById('freeshipProgress');
        const freeshipText = document.getElementById('freeshipText');
        
        if (subtotal >= FREE_SHIP_THRESHOLD) {
            freeshipEl.classList.add('achieved');
            freeshipText.innerHTML = 'üéâ <strong>Ch√∫c m·ª´ng!</strong> B·∫°n ƒë∆∞·ª£c mi·ªÖn ph√≠ ship!';
        } else {
            freeshipEl.classList.remove('achieved');
            const remaining = FREE_SHIP_THRESHOLD - subtotal;
            freeshipText.innerHTML = `C√≤n <strong>${formatPrice(remaining)}ƒë</strong> ƒë·ªÉ mi·ªÖn ph√≠ ship`;
        }
        
        // Enable/disable checkout button
        document.getElementById('btnCheckout').disabled = selectedCount === 0;
        
        // Store selected items for checkout
        localStorage.setItem('checkoutItems', JSON.stringify(selectedItems));
    }

    function deleteSelected() {
        const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
        if (checkedBoxes.length === 0) return;
        
        if (!confirm(`X√≥a ${checkedBoxes.length} s·∫£n ph·∫©m ƒë√£ ch·ªçn?`)) return;
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const indicesToRemove = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
        
        indicesToRemove.forEach(index => cart.splice(index, 1));
        
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartBadge();
    }

    function goToCheckout() {
        const checkoutItems = JSON.parse(localStorage.getItem('checkoutItems') || '[]');
        if (checkoutItems.length === 0) {
            alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ mua');
            return;
        }
        
        // Check login
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.username) {
            if (confirm('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng. ƒêƒÉng nh·∫≠p ngay?')) {
                window.location.href = '/DangNhap?returnUrl=/ThanhToan';
            }
            return;
        }
        
        window.location.href = '/ThanhToan';
    }

    function formatPrice(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateCartBadge() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        
        // Update page count
        const pageCount = document.getElementById('cartPageCount');
        if (pageCount) pageCount.textContent = count + ' s·∫£n ph·∫©m';
        
        // Update header badge (only number)
        const headerBadge = document.getElementById('cartCount');
        if (headerBadge) headerBadge.textContent = count;
        
        const mobileBadge = document.getElementById('cartCountMobile');
        if (mobileBadge) mobileBadge.textContent = count;
    }

    // Init
    loadCart();
</script>
}
