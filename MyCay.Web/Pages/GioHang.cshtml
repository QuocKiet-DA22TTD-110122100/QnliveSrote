@page
@model GioHangModel
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<!-- Sticky Promo Banner -->
<div class="promo-banner-sticky" id="promoBanner">
    <div class="promo-banner-content">
        <div class="promo-left">
            <span class="promo-icon">üöö</span>
            <span class="promo-text">Mi·ªÖn ph√≠ ship t·ª´ <strong>200k</strong></span>
            <span class="promo-divider">|</span>
            <span class="promo-icon">‚ö°</span>
            <span class="promo-text">Giao ch·ªâ <strong>30 ph√∫t</strong></span>
        </div>
        <div class="promo-progress-wrapper" id="promoProgressWrapper">
            <div class="promo-progress-bar">
                <div class="promo-progress-fill" id="promoProgressFill" style="width: 0%"></div>
            </div>
            <span class="promo-progress-text" id="promoProgressText">C√≤n 200k ƒë·ªÉ mi·ªÖn ph√≠ ship!</span>
        </div>
    </div>
</div>

<!-- Checkout Progress Steps -->
<div class="checkout-steps">
    <div class="step active">
        <div class="step-number">1</div>
        <span>Gi·ªè h√†ng</span>
    </div>
    <div class="step-line"></div>
    <div class="step">
        <div class="step-number">2</div>
        <span>ƒê·ªãa ch·ªâ</span>
    </div>
    <div class="step-line"></div>
    <div class="step">
        <div class="step-number">3</div>
        <span>Thanh to√°n</span>
    </div>
</div>

<section class="cart-page">
    <div class="container">
        <div class="cart-header">
            <h1 class="page-title">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>
            <p class="page-subtitle" id="cartSummary">ƒêang t·∫£i...</p>
        </div>

        <div class="cart-content" id="cartContent">
            <!-- Cart Items -->
            <div class="cart-main">
                <div class="cart-items-wrapper">
                    <div class="cart-items-header">
                        <h3>üçú M√≥n ƒë√£ ch·ªçn</h3>
                        <button class="btn-clear-cart" onclick="clearCart()" id="btnClearCart">
                            <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                        </button>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <!-- Items will be loaded by JavaScript -->
                    </div>
                </div>

                <!-- Upsell Section -->
                <div class="upsell-section" id="upsellSection">
                    <div class="upsell-header">
                        <h3>‚ú® G·ª£i √Ω th√™m ƒë·ªÉ mi·ªÖn ph√≠ ship</h3>
                        <span class="upsell-hint" id="upsellHint">Th√™m 120k n·ªØa ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ giao h√†ng!</span>
                    </div>
                    <div class="upsell-carousel" id="upsellCarousel">
                        <!-- Upsell items loaded by JS -->
                    </div>
                </div>
            </div>

            <!-- Cart Sidebar -->
            <div class="cart-sidebar">
                <!-- Order Summary -->
                <div class="cart-summary-card">
                    <h3>üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    
                    <div class="summary-accordion">
                        <div class="summary-row" onclick="toggleSummaryDetail()">
                            <span><i class="fas fa-receipt"></i> T·∫°m t√≠nh</span>
                            <span id="subtotal">0ƒë</span>
                        </div>
                        <div class="summary-row shipping-row" id="shippingRow">
                            <span><i class="fas fa-truck"></i> Ph√≠ giao h√†ng</span>
                            <span id="shippingFee">25.000ƒë</span>
                        </div>
                        <div class="summary-row discount" id="discountRow" style="display:none;">
                            <span><i class="fas fa-tag"></i> Gi·∫£m gi√° (<span id="promoCodeApplied"></span>)</span>
                            <span id="discount" class="discount-value">-0ƒë</span>
                        </div>
                    </div>
                    
                    <div class="summary-total">
                        <span>T·ªïng c·ªông</span>
                        <span id="total" class="total-value">0ƒë</span>
                    </div>

                    <!-- Promo Code Input -->
                    <div class="promo-code-section">
                        <label><i class="fas fa-ticket-alt"></i> M√£ gi·∫£m gi√°</label>
                        <div class="promo-input-group">
                            <input type="text" id="promoInput" placeholder="Nh·∫≠p m√£ ∆∞u ƒë√£i (VD: NEWUSER15)" />
                            <button onclick="applyPromo()" class="btn-apply-promo">√Åp d·ª•ng</button>
                        </div>
                        <div class="promo-applied" id="promoApplied" style="display:none;">
                            <span class="promo-applied-badge">
                                <i class="fas fa-check-circle"></i> <span id="promoAppliedText"></span>
                            </span>
                            <button onclick="removePromo()" class="btn-remove-promo">√ó</button>
                        </div>
                    </div>
                    
                    <div class="promo-suggestions">
                        <small>üéÅ M√£ g·ª£i √Ω: </small>
                        <div class="promo-tags">
                            <span class="promo-tag" onclick="usePromo('NEWUSER15')">NEWUSER15 <small>-15%</small></span>
                            <span class="promo-tag" onclick="usePromo('FREESHIP')">FREESHIP</span>
                            <span class="promo-tag" onclick="usePromo('SASIN30K')">SASIN30K</span>
                        </div>
                    </div>

                    <div class="free-ship-status" id="freeShipStatus">
                        <div class="free-ship-icon">üöö</div>
                        <div class="free-ship-info">
                            <span id="freeShipText">C√≤n <strong>200.000ƒë</strong> ƒë·ªÉ mi·ªÖn ph√≠ ship</span>
                            <div class="free-ship-bar">
                                <div class="free-ship-fill" id="freeShipFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="customer-info-card">
                    <h3>üìç Th√¥ng tin giao h√†ng</h3>
                    <p class="saved-info-note" id="savedInfoNote" style="display:none;">
                        <i class="fas fa-check-circle"></i> Th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞u t·ª´ l·∫ßn ƒë·∫∑t tr∆∞·ªõc
                    </p>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> H·ªç t√™n *</label>
                        <input type="text" id="customerName" placeholder="Nguy·ªÖn VƒÉn A" required />
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" id="customerPhone" placeholder="0901234567" required />
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ giao h√†ng *</label>
                        <textarea id="customerAddress" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán" required></textarea>
                        <div class="address-suggestions" id="addressSuggestions"></div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Ghi ch√∫</label>
                        <textarea id="orderNote" placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh, kh√¥ng h√†nh, th√™m ·ªõt..."></textarea>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="payment-methods-card">
                    <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <p class="payment-secure"><i class="fas fa-shield-alt"></i> An to√†n & B·∫£o m·∫≠t 100%</p>
                    
                    <div class="payment-tabs">
                        <button class="payment-tab active" data-method="cod" onclick="selectPaymentTab('cod')">
                            <span class="tab-icon">üíµ</span>
                            <span>COD</span>
                        </button>
                        <button class="payment-tab" data-method="momo" onclick="selectPaymentTab('momo')">
                            <span class="tab-icon"><img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="MoMo" /></span>
                            <span>MoMo</span>
                        </button>
                        <button class="payment-tab" data-method="zalopay" onclick="selectPaymentTab('zalopay')">
                            <span class="tab-icon"><img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-ZaloPay-Square.png" alt="ZaloPay" /></span>
                            <span>ZaloPay</span>
                        </button>
                        <button class="payment-tab" data-method="bank" onclick="selectPaymentTab('bank')">
                            <span class="tab-icon">üè¶</span>
                            <span>Chuy·ªÉn kho·∫£n</span>
                        </button>
                    </div>
                    
                    <input type="hidden" id="selectedPaymentMethod" value="cod" />
                    
                    <div class="payment-detail" id="paymentDetailCod">
                        <div class="payment-detail-content">
                            <i class="fas fa-hand-holding-usd"></i>
                            <p>Thanh to√°n ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</p>
                        </div>
                    </div>
                    
                    <div class="payment-detail" id="paymentDetailMomo" style="display:none;">
                        <div class="payment-detail-content">
                            <p>Qu√©t m√£ QR ho·∫∑c chuy·ªÉn qua v√≠ MoMo</p>
                            <small>B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn MoMo sau khi ƒë·∫∑t h√†ng</small>
                        </div>
                    </div>
                    
                    <div class="payment-detail" id="paymentDetailZalopay" style="display:none;">
                        <div class="payment-detail-content">
                            <p>Thanh to√°n qua v√≠ ZaloPay</p>
                            <small>B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn ZaloPay sau khi ƒë·∫∑t h√†ng</small>
                        </div>
                    </div>
                    
                    <div class="payment-detail" id="paymentDetailBank" style="display:none;">
                        <div class="bank-info-box">
                            <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                            <div class="bank-row"><span>Ng√¢n h√†ng:</span><strong>Vietcombank</strong></div>
                            <div class="bank-row"><span>S·ªë TK:</span><strong>1234567890</strong> <button onclick="copyToClipboard('1234567890')" class="btn-copy"><i class="fas fa-copy"></i></button></div>
                            <div class="bank-row"><span>Ch·ªß TK:</span><strong>CONG TY TNHH MY CAY SASIN</strong></div>
                            <div class="bank-row"><span>N·ªôi dung:</span><strong id="transferContent">T√™n + SƒêT</strong></div>
                        </div>
                    </div>
                    
                    <!-- Checkout Button -->
                    <button class="btn-checkout" onclick="checkout()" id="btnCheckout">
                        <span class="checkout-text">
                            <i class="fas fa-shopping-bag"></i> Ho√†n t·∫•t ƒë∆°n h√†ng
                        </span>
                        <span class="checkout-total" id="checkoutTotal">0ƒë</span>
                    </button>
                    
                    <div class="checkout-note" id="freeShipNote" style="display:none;">
                        <span class="free-ship-badge">üéâ Mi·ªÖn ph√≠ giao h√†ng!</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty Cart -->
        <div class="empty-cart" id="emptyCart" style="display:none;">
            <div class="empty-icon">üõí</div>
            <h2>Gi·ªè h√†ng tr·ªëng</h2>
            <p>B·∫°n ch∆∞a c√≥ m√≥n n√†o trong gi·ªè h√†ng</p>
            <a href="/ThucDon" class="btn btn-primary">
                <i class="fas fa-utensils"></i> Kh√°m ph√° th·ª±c ƒë∆°n
            </a>
        </div>
    </div>
</section>

<!-- Login Required Modal -->
<div class="login-modal-overlay" id="loginModal">
    <div class="login-modal">
        <button class="modal-close" onclick="closeLoginModal()">√ó</button>
        <div class="login-modal-icon">üîê</div>
        <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng. N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, h√£y ƒëƒÉng k√Ω ngay!</p>
        <div class="login-modal-buttons">
            <a href="/DangNhap?returnUrl=/GioHang" class="btn-login">
                <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
            </a>
            <a href="/DangKy?returnUrl=/GioHang" class="btn-register">
                <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
            </a>
        </div>
    </div>
</div>


<style>
/* ===== Promo Banner Sticky ===== */
.promo-banner-sticky {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: white;
    padding: 12px 20px;
    position: sticky;
    top: 70px;
    z-index: 100;
    box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
}
.promo-banner-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}
.promo-left {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}
.promo-icon { font-size: 1.2rem; }
.promo-divider { opacity: 0.5; }
.promo-progress-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 30px;
}
.promo-progress-bar {
    width: 120px;
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    overflow: hidden;
}
.promo-progress-fill {
    height: 100%;
    background: #10b981;
    border-radius: 4px;
    transition: width 0.5s ease;
}
.promo-progress-text {
    font-size: 0.85rem;
    font-weight: 600;
}

/* ===== Checkout Steps ===== */
.checkout-steps {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 25px 20px;
    background: white;
    border-bottom: 1px solid #e5e7eb;
    gap: 0;
}
.step {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #9ca3af;
    font-weight: 500;
}
.step.active { color: #f97316; }
.step.completed { color: #10b981; }
.step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
}
.step.active .step-number {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}
.step.completed .step-number {
    background: #10b981;
    color: white;
}
.step-line {
    width: 60px;
    height: 3px;
    background: #e5e7eb;
    margin: 0 15px;
}

/* ===== Cart Page ===== */
.cart-page {
    padding: 20px 15px 50px;
    background: #f8fafc;
    min-height: calc(100vh - 200px);
}
.cart-header {
    text-align: center;
    margin-bottom: 25px;
}
.page-title {
    font-size: 1.6rem;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 6px;
}
.page-subtitle {
    color: #6b7280;
    font-size: 0.95rem;
}

/* ===== Cart Content Grid ===== */
.cart-content {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 25px;
    max-width: 1100px;
    margin: 0 auto;
}
.cart-main { display: flex; flex-direction: column; gap: 25px; }

/* ===== Cart Items ===== */
.cart-items-wrapper {
    background: white;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.cart-items-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f3f4f6;
}
.cart-items-header h3 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
}
.btn-clear-cart {
    background: none;
    border: none;
    color: #ef4444;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 10px;
    border-radius: 6px;
    transition: all 0.2s;
}
.btn-clear-cart:hover {
    background: #fef2f2;
}

/* Cart Item */
.cart-item {
    display: grid;
    grid-template-columns: 70px 1fr auto auto auto;
    gap: 12px;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f3f4f6;
    animation: fadeInUp 0.3s ease;
}
.cart-item:last-child { border-bottom: none; }

@@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.item-image {
    width: 70px;
    height: 70px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.item-details { flex: 1; }
.item-name {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 4px;
}
.item-rating {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    color: #f59e0b;
    margin-bottom: 4px;
}
.item-options {
    display: inline-block;
    font-size: 0.75rem;
    color: #f97316;
    background: #fff7ed;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 500;
}
.item-price {
    display: block;
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 4px;
}

/* Quantity Selector */
.item-quantity {
    display: flex;
    align-items: center;
    gap: 0;
    background: #f3f4f6;
    border-radius: 8px;
    overflow: hidden;
}
.qty-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
}
.qty-btn:hover {
    background: #f97316;
    color: white;
}
.qty-value {
    width: 32px;
    text-align: center;
    font-weight: 700;
    font-size: 0.9rem;
    color: #1f2937;
}

.item-total {
    font-size: 0.95rem;
    font-weight: 700;
    color: #f97316;
    min-width: 80px;
    text-align: right;
}

.item-remove {
    width: 32px;
    height: 32px;
    border: none;
    background: #fef2f2;
    color: #ef4444;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}
.item-remove:hover {
    background: #ef4444;
    color: white;
    transform: scale(1.1);
}

/* ===== Upsell Section ===== */
.upsell-section {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 14px;
    padding: 18px;
    border: 2px dashed #f59e0b;
}
.upsell-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 8px;
}
.upsell-header h3 {
    font-size: 1rem;
    font-weight: 700;
    color: #92400e;
}
.upsell-hint {
    font-size: 0.85rem;
    color: #b45309;
    font-weight: 500;
}
.upsell-carousel {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 8px;
    scroll-snap-type: x mandatory;
}
.upsell-carousel::-webkit-scrollbar { height: 5px; }
.upsell-carousel::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 3px; }

.upsell-item {
    flex: 0 0 140px;
    background: white;
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    scroll-snap-align: start;
    transition: transform 0.2s;
}
.upsell-item:hover { transform: translateY(-3px); }
.upsell-item img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    margin-bottom: 8px;
}
.upsell-item h4 {
    font-size: 0.8rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.upsell-item .upsell-price {
    font-size: 0.85rem;
    font-weight: 700;
    color: #f97316;
    margin-bottom: 8px;
}
.upsell-item .btn-add-upsell {
    width: 100%;
    padding: 6px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}
.upsell-item .btn-add-upsell:hover {
    transform: scale(1.05);
    box-shadow: 0 3px 10px rgba(249, 115, 22, 0.4);
}

/* ===== Cart Sidebar ===== */
.cart-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Summary Card */
.cart-summary-card {
    background: white;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.cart-summary-card h3 {
    font-size: 1.05rem;
    font-weight: 700;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f3f4f6;
    color: #1f2937;
}
.summary-accordion { margin-bottom: 12px; }
.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 0.9rem;
    color: #4b5563;
    border-bottom: 1px dashed #e5e7eb;
}
.summary-row i { margin-right: 6px; color: #9ca3af; }
.summary-row.discount { color: #10b981; }
.discount-value { font-weight: 600; }
.summary-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-top: 2px solid #1f2937;
    margin-top: 8px;
}
.summary-total span:first-child {
    font-size: 1rem;
    font-weight: 700;
    color: #1f2937;
}
.total-value {
    font-size: 1.3rem;
    font-weight: 800;
    color: #f97316;
}

/* Promo Code */
.promo-code-section {
    margin: 15px 0;
    padding: 15px;
    background: #f9fafb;
    border-radius: 10px;
}
.promo-code-section label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.9rem;
}
.promo-code-section label i { margin-right: 6px; color: #f97316; }
.promo-input-group {
    display: flex;
    gap: 8px;
}
.promo-input-group input {
    flex: 1;
    padding: 10px 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.2s;
}
.promo-input-group input:focus {
    outline: none;
    border-color: #f97316;
}
.btn-apply-promo {
    padding: 10px 16px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-apply-promo:hover {
    transform: scale(1.05);
}
.promo-applied {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding: 8px 12px;
    background: #d1fae5;
    border-radius: 8px;
}
.promo-applied-badge {
    color: #059669;
    font-weight: 600;
    font-size: 0.85rem;
}
.promo-applied-badge i { margin-right: 5px; }
.btn-remove-promo {
    width: 22px;
    height: 22px;
    border: none;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9rem;
}

.promo-suggestions {
    margin-top: 12px;
}
.promo-suggestions small {
    color: #6b7280;
    font-size: 0.8rem;
}
.promo-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
}
.promo-tag {
    padding: 5px 10px;
    background: #fef3c7;
    color: #b45309;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
}
.promo-tag:hover {
    background: #f97316;
    color: white;
}
.promo-tag small {
    opacity: 0.8;
}

/* Free Ship Status */
.free-ship-status {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #ecfdf5;
    border-radius: 10px;
    margin-top: 12px;
}
.free-ship-status.achieved {
    background: #d1fae5;
    border: 2px solid #10b981;
}
.free-ship-icon { font-size: 1.5rem; }
.free-ship-info { flex: 1; }
.free-ship-info span {
    font-size: 0.85rem;
    color: #065f46;
}
.free-ship-bar {
    height: 6px;
    background: #a7f3d0;
    border-radius: 3px;
    margin-top: 6px;
    overflow: hidden;
}
.free-ship-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    border-radius: 3px;
    transition: width 0.5s ease;
}
</style>

<style>
/* ===== Customer Info Card ===== */
.customer-info-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.customer-info-card h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f3f4f6;
    color: #1f2937;
}
.saved-info-note {
    background: #d1fae5;
    color: #059669;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 0.9rem;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.form-group {
    margin-bottom: 18px;
}
.form-group label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.95rem;
}
.form-group label i {
    margin-right: 8px;
    color: #f97316;
}
.form-group input,
.form-group textarea {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.2s;
    background: #f9fafb;
}
.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #f97316;
    background: white;
    box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
}
.form-group textarea {
    min-height: 80px;
    resize: vertical;
}

/* ===== Payment Methods Card ===== */
.payment-methods-card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.payment-methods-card h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: #1f2937;
}
.payment-secure {
    color: #10b981;
    font-size: 0.85rem;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Payment Tabs */
.payment-tabs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}
.payment-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 15px 10px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b7280;
}
.payment-tab:hover {
    border-color: #f97316;
    background: #fff7ed;
}
.payment-tab.active {
    border-color: #f97316;
    background: #fff7ed;
    color: #f97316;
}
.tab-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}
.tab-icon img {
    width: 30px;
    height: 30px;
    object-fit: contain;
}

/* Payment Detail */
.payment-detail {
    padding: 20px;
    background: #f9fafb;
    border-radius: 12px;
    margin-bottom: 20px;
}
.payment-detail-content {
    text-align: center;
    color: #4b5563;
}
.payment-detail-content i {
    font-size: 2rem;
    color: #f97316;
    margin-bottom: 10px;
}
.payment-detail-content p {
    font-weight: 500;
    margin-bottom: 5px;
}
.payment-detail-content small {
    color: #9ca3af;
}

/* Bank Info */
.bank-info-box {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
}
.bank-info-box h4 {
    font-size: 1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 15px;
}
.bank-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed #e5e7eb;
    font-size: 0.9rem;
}
.bank-row:last-child { border-bottom: none; }
.bank-row span { color: #6b7280; }
.bank-row strong { color: #1f2937; }
.btn-copy {
    width: 28px;
    height: 28px;
    border: none;
    background: #f3f4f6;
    color: #6b7280;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 8px;
    transition: all 0.2s;
}
.btn-copy:hover {
    background: #f97316;
    color: white;
}

/* Checkout Button */
.btn-checkout {
    width: 100%;
    padding: 18px 24px;
    background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 14px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
    box-shadow: 0 8px 25px rgba(249, 115, 22, 0.4);
}
.btn-checkout:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(249, 115, 22, 0.5);
}
.btn-checkout:active {
    transform: translateY(0);
}
.checkout-text {
    display: flex;
    align-items: center;
    gap: 10px;
}
.checkout-total {
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 1rem;
}
.checkout-note {
    text-align: center;
    margin-top: 15px;
}
.free-ship-badge {
    display: inline-block;
    padding: 8px 20px;
    background: #d1fae5;
    color: #059669;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    animation: pulse 2s infinite;
}
@@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* ===== Empty Cart ===== */
.empty-cart {
    text-align: center;
    padding: 80px 20px;
    background: white;
    border-radius: 20px;
    max-width: 500px;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.empty-icon {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.5;
}
.empty-cart h2 {
    font-size: 1.5rem;
    color: #1f2937;
    margin-bottom: 10px;
}
.empty-cart p {
    color: #6b7280;
    margin-bottom: 25px;
}
.empty-cart .btn {
    padding: 14px 30px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s;
}
.empty-cart .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(249, 115, 22, 0.4);
}

/* ===== Login Modal ===== */
.login-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    padding: 20px;
}
.login-modal-overlay.active { display: flex; }
.login-modal {
    background: white;
    border-radius: 24px;
    padding: 45px;
    text-align: center;
    max-width: 420px;
    width: 100%;
    position: relative;
    animation: modalPop 0.3s ease;
    box-shadow: 0 25px 60px rgba(0,0,0,0.3);
}
@@keyframes modalPop {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.login-modal .modal-close {
    position: absolute;
    top: 18px;
    right: 18px;
    width: 40px;
    height: 40px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
}
.login-modal .modal-close:hover {
    background: #ef4444;
    color: white;
}
.login-modal-icon { font-size: 4rem; margin-bottom: 20px; }
.login-modal h2 {
    font-size: 1.5rem;
    color: #1f2937;
    margin-bottom: 15px;
}
.login-modal p {
    color: #6b7280;
    margin-bottom: 30px;
    line-height: 1.6;
}
.login-modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}
.login-modal-buttons a {
    padding: 14px 28px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.btn-login {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}
.btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249,115,22,0.4);
}
.btn-register {
    background: #f3f4f6;
    color: #374151;
}
.btn-register:hover { background: #e5e7eb; }

/* ===== Toast ===== */
.toast-message {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 16px 28px;
    background: linear-gradient(135deg, #1f2937, #111827);
    color: white;
    border-radius: 14px;
    font-weight: 600;
    z-index: 4000;
    animation: slideInRight 0.4s ease;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
@@keyframes slideInRight {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* ===== Responsive ===== */
@@media (max-width: 1024px) {
    .cart-content {
        grid-template-columns: 1fr;
    }
    .cart-sidebar {
        order: -1;
    }
}
@@media (max-width: 768px) {
    .promo-banner-content {
        flex-direction: column;
        text-align: center;
    }
    .promo-left {
        flex-wrap: wrap;
        justify-content: center;
    }
    .checkout-steps {
        padding: 15px 10px;
    }
    .step span { display: none; }
    .step-line { width: 30px; }
    .cart-item {
        grid-template-columns: 70px 1fr;
        gap: 15px;
    }
    .item-quantity,
    .item-total,
    .item-remove {
        grid-column: 2;
    }
    .item-quantity { justify-self: start; }
    .item-total { justify-self: center; }
    .item-remove { justify-self: end; }
    .payment-tabs {
        grid-template-columns: repeat(2, 1fr);
    }
    .upsell-item {
        flex: 0 0 150px;
    }
}
@@media (max-width: 480px) {
    .cart-page { padding: 20px 15px 40px; }
    .page-title { font-size: 1.5rem; }
    .cart-items-wrapper,
    .cart-summary-card,
    .customer-info-card,
    .payment-methods-card {
        padding: 20px;
    }
    .btn-checkout {
        flex-direction: column;
        gap: 10px;
        padding: 16px;
    }
    .checkout-total {
        width: 100%;
        text-align: center;
    }
}
</style>


@section Scripts {
<script>
    const SHIPPING_FEE = 25000;
    const FREE_SHIP_THRESHOLD = 200000;
    let currentDiscount = 0;
    let currentPromoCode = '';

    const promoCodes = {
        'NEWUSER15': { type: 'percent', value: 15, min: 100000, desc: 'Gi·∫£m 15% cho kh√°ch m·ªõi' },
        'SASIN10': { type: 'percent', value: 10, min: 80000, desc: 'Gi·∫£m 10%' },
        'SASIN20': { type: 'percent', value: 20, min: 200000, desc: 'Gi·∫£m 20%' },
        'SASIN30K': { type: 'fixed', value: 30000, min: 150000, desc: 'Gi·∫£m 30.000ƒë' },
        'FREESHIP': { type: 'shipping', value: 25000, min: 100000, desc: 'Mi·ªÖn ph√≠ giao h√†ng' }
    };

    // Upsell products - m√≥n th√™m t·ª´ database th·ª±c t·∫ø
    const upsellProducts = [
        { id: 30, name: 'Tr·ª©ng Ng√¢m T∆∞∆°ng', price: 12000, image: 'MenuItem_M00030.webp' },
        { id: 31, name: 'B√≤ Th√™m', price: 19000, image: 'MenuItem_M00031.webp' },
        { id: 32, name: 'T√¥m Th√™m', price: 15000, image: 'MenuItem_M00032.webp' },
        { id: 33, name: 'C√° Vi√™n Th√™m', price: 15000, image: 'MenuItem_M00033.webp' },
        { id: 36, name: 'X√∫c X√≠ch', price: 15000, image: 'MenuItem_M00036.webp' },
        { id: 70, name: 'Khoai T√¢y Chi√™n', price: 32000, image: 'MenuItem_M00070.webp' },
        { id: 73, name: 'Ph√¥ Mai Vi√™n', price: 29000, image: 'MenuItem_M00073.webp' },
        { id: 102, name: 'Coca Cola Size R', price: 23000, image: 'MenuItem_M00102.webp' }
    ];

    function loadCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const container = document.getElementById('cartItems');
        const emptyCart = document.getElementById('emptyCart');
        const cartContent = document.getElementById('cartContent');

        if (cart.length === 0) {
            cartContent.style.display = 'none';
            emptyCart.style.display = 'block';
            document.getElementById('cartSummary').textContent = 'Gi·ªè h√†ng tr·ªëng';
            document.getElementById('promoBanner').style.display = 'none';
            return;
        }

        cartContent.style.display = 'grid';
        emptyCart.style.display = 'none';
        document.getElementById('promoBanner').style.display = 'block';
        
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartSummary').textContent = `${totalItems} m√≥n trong gi·ªè h√†ng`;

        container.innerHTML = cart.map((item, index) => `
            <div class="cart-item" data-index="${index}">
                <div class="item-image">
                    <img src="/images/products/${item.image || 'MenuItem_' + item.code + '.webp'}" alt="${item.name}" 
                         onerror="this.src='/images/products/MenuItem_M00012.webp'" />
                </div>
                <div class="item-details">
                    <h4 class="item-name">${item.name}</h4>
                    <div class="item-rating">
                        <span>‚≠ê 4.${8 + (index % 2)}</span>
                        <small>(${120 + index * 30} ƒë√°nh gi√°)</small>
                    </div>
                    ${item.broth ? `<span class="item-options">üçú ${item.broth} | üå∂Ô∏è C·∫•p ${item.spicyLevel}</span>` : ''}
                    <span class="item-price">${formatPrice(item.price)}ƒë / ph·∫ßn</span>
                </div>
                <div class="item-quantity">
                    <button class="qty-btn" onclick="updateQuantity(${index}, -1)">‚àí</button>
                    <span class="qty-value">${item.quantity}</span>
                    <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                </div>
                <div class="item-total">
                    ${formatPrice(item.price * item.quantity)}ƒë
                </div>
                <button class="item-remove" onclick="removeItem(${index})" title="X√≥a m√≥n n√†y">üóëÔ∏è</button>
            </div>
        `).join('');

        updateTotals();
        loadUpsellProducts();
    }

    function loadUpsellProducts() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const remaining = FREE_SHIP_THRESHOLD - subtotal;
        
        const upsellSection = document.getElementById('upsellSection');
        const upsellHint = document.getElementById('upsellHint');
        const carousel = document.getElementById('upsellCarousel');
        
        if (remaining <= 0) {
            upsellSection.style.display = 'none';
            return;
        }
        
        upsellSection.style.display = 'block';
        upsellHint.innerHTML = `Th√™m <strong>${formatPrice(remaining)}ƒë</strong> n·ªØa ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ giao h√†ng!`;
        
        // Filter upsell products that can help reach free ship
        const relevantProducts = upsellProducts.filter(p => p.price <= remaining + 50000);
        
        carousel.innerHTML = relevantProducts.map(product => `
            <div class="upsell-item">
                <img src="/images/products/${product.image}" alt="${product.name}" 
                     onerror="this.src='/images/products/MenuItem_M00012.webp'" />
                <h4>${product.name}</h4>
                <div class="upsell-price">${formatPrice(product.price)}ƒë</div>
                <button class="btn-add-upsell" onclick="addUpsellToCart(${product.id}, '${product.name}', ${product.price}, '${product.image}')">
                    + Th√™m v√†o gi·ªè
                </button>
            </div>
        `).join('');
    }

    function addUpsellToCart(id, name, price, image) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        // Check if already in cart
        const existingIndex = cart.findIndex(item => item.name === name);
        if (existingIndex >= 0) {
            cart[existingIndex].quantity += 1;
        } else {
            cart.push({
                productId: id,
                code: 'UP' + id.toString().padStart(5, '0'),
                name: name,
                price: price,
                quantity: 1,
                image: image
            });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartBadge();
        showToast('‚úì ƒê√£ th√™m ' + name + ' v√†o gi·ªè h√†ng!');
    }

    function updateQuantity(index, delta) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart[index]) {
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            updateCartBadge();
        }
    }

    function removeItem(index) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?')) return;
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartBadge();
        showToast('üóëÔ∏è ƒê√£ x√≥a kh·ªèi gi·ªè h√†ng');
    }

    function clearCart() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ m√≥n trong gi·ªè h√†ng?')) return;
        localStorage.removeItem('cart');
        loadCart();
        updateCartBadge();
        showToast('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£');
    }

    function updateTotals() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : SHIPPING_FEE;
        
        // Apply promo
        let discount = 0;
        if (currentPromoCode && promoCodes[currentPromoCode]) {
            const promo = promoCodes[currentPromoCode];
            if (subtotal >= promo.min) {
                if (promo.type === 'percent') {
                    discount = subtotal * promo.value / 100;
                } else if (promo.type === 'fixed') {
                    discount = promo.value;
                } else if (promo.type === 'shipping') {
                    shipping = 0;
                    discount = 0;
                }
            }
        }
        
        currentDiscount = discount;
        const total = Math.max(0, subtotal + shipping - discount);

        // Update summary
        document.getElementById('subtotal').textContent = formatPrice(subtotal) + 'ƒë';
        document.getElementById('shippingFee').textContent = shipping === 0 ? 'Mi·ªÖn ph√≠ üéâ' : formatPrice(shipping) + 'ƒë';
        document.getElementById('total').textContent = formatPrice(total) + 'ƒë';
        document.getElementById('checkoutTotal').textContent = formatPrice(total) + 'ƒë';

        // Update discount row
        if (currentDiscount > 0 || (currentPromoCode && promoCodes[currentPromoCode]?.type === 'shipping')) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('promoCodeApplied').textContent = currentPromoCode;
            document.getElementById('discount').textContent = currentDiscount > 0 ? '-' + formatPrice(currentDiscount) + 'ƒë' : 'Mi·ªÖn ship';
        } else {
            document.getElementById('discountRow').style.display = 'none';
        }

        // Update free ship progress
        updateFreeShipProgress(subtotal);
        
        // Update promo banner progress
        updatePromoBannerProgress(subtotal);
        
        // Show/hide free ship note
        const freeShipNote = document.getElementById('freeShipNote');
        if (shipping === 0 && subtotal > 0) {
            freeShipNote.style.display = 'block';
        } else {
            freeShipNote.style.display = 'none';
        }
    }

    function updateFreeShipProgress(subtotal) {
        const freeShipStatus = document.getElementById('freeShipStatus');
        const freeShipText = document.getElementById('freeShipText');
        const freeShipFill = document.getElementById('freeShipFill');
        
        const progress = Math.min(100, (subtotal / FREE_SHIP_THRESHOLD) * 100);
        freeShipFill.style.width = progress + '%';
        
        if (subtotal >= FREE_SHIP_THRESHOLD) {
            freeShipStatus.classList.add('achieved');
            freeShipText.innerHTML = 'üéâ <strong>Ch√∫c m·ª´ng!</strong> B·∫°n ƒë∆∞·ª£c mi·ªÖn ph√≠ giao h√†ng!';
        } else {
            freeShipStatus.classList.remove('achieved');
            const remaining = FREE_SHIP_THRESHOLD - subtotal;
            freeShipText.innerHTML = `C√≤n <strong>${formatPrice(remaining)}ƒë</strong> ƒë·ªÉ mi·ªÖn ph√≠ ship`;
        }
    }

    function updatePromoBannerProgress(subtotal) {
        const progressFill = document.getElementById('promoProgressFill');
        const progressText = document.getElementById('promoProgressText');
        
        const progress = Math.min(100, (subtotal / FREE_SHIP_THRESHOLD) * 100);
        progressFill.style.width = progress + '%';
        
        if (subtotal >= FREE_SHIP_THRESHOLD) {
            progressText.textContent = 'üéâ Mi·ªÖn ph√≠ ship!';
            progressFill.style.background = '#10b981';
        } else {
            const remaining = FREE_SHIP_THRESHOLD - subtotal;
            progressText.textContent = `C√≤n ${formatPrice(remaining)}ƒë ƒë·ªÉ mi·ªÖn ph√≠ ship!`;
        }
    }

    function formatPrice(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function usePromo(code) {
        document.getElementById('promoInput').value = code;
        applyPromo();
    }

    function applyPromo() {
        const code = document.getElementById('promoInput').value.toUpperCase().trim();
        
        if (!code) {
            showToast('‚ùå Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!');
            return;
        }

        if (!promoCodes[code]) {
            showToast('‚ùå M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá!');
            return;
        }

        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const promo = promoCodes[code];

        if (subtotal < promo.min) {
            showToast(`‚ùå ƒê∆°n h√†ng t·ªëi thi·ªÉu ${formatPrice(promo.min)}ƒë ƒë·ªÉ √°p d·ª•ng m√£ n√†y!`);
            return;
        }

        currentPromoCode = code;
        updateTotals();
        
        // Show applied promo
        document.getElementById('promoApplied').style.display = 'flex';
        document.getElementById('promoAppliedText').textContent = `${code} - ${promo.desc}`;
        document.querySelector('.promo-input-group').style.display = 'none';
        
        showToast(`‚úÖ √Åp d·ª•ng m√£ ${code} th√†nh c√¥ng! ${promo.desc}`);
    }

    function removePromo() {
        currentPromoCode = '';
        currentDiscount = 0;
        document.getElementById('promoInput').value = '';
        document.getElementById('promoApplied').style.display = 'none';
        document.querySelector('.promo-input-group').style.display = 'flex';
        updateTotals();
        showToast('ƒê√£ h·ªßy m√£ gi·∫£m gi√°');
    }

    // Payment tab selection
    function selectPaymentTab(method) {
        // Update tabs
        document.querySelectorAll('.payment-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.payment-tab[data-method="${method}"]`).classList.add('active');
        
        // Update hidden input
        document.getElementById('selectedPaymentMethod').value = method;
        
        // Show/hide payment details
        document.querySelectorAll('.payment-detail').forEach(detail => {
            detail.style.display = 'none';
        });
        
        const detailId = 'paymentDetail' + method.charAt(0).toUpperCase() + method.slice(1);
        const detailElement = document.getElementById(detailId);
        if (detailElement) {
            detailElement.style.display = 'block';
        }
        
        // Update transfer content if bank
        if (method === 'bank') {
            updateTransferContent();
        }
    }

    function updateTransferContent() {
        const name = document.getElementById('customerName').value || 'TEN';
        const phone = document.getElementById('customerPhone').value || 'SDT';
        const transferContent = document.getElementById('transferContent');
        if (transferContent) {
            transferContent.textContent = `${name} ${phone}`;
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('‚úì ƒê√£ sao ch√©p: ' + text);
        });
    }

    function isLoggedIn() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        return user && user.username;
    }

    function checkout() {
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!isLoggedIn()) {
            showLoginRequiredModal();
            return;
        }

        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
            showToast('‚ùå Gi·ªè h√†ng tr·ªëng!');
            return;
        }

        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const address = document.getElementById('customerAddress').value.trim();
        const note = document.getElementById('orderNote').value.trim();
        const paymentMethod = document.getElementById('selectedPaymentMethod').value;

        if (!name) {
            showToast('‚ùå Vui l√≤ng nh·∫≠p h·ªç t√™n!');
            document.getElementById('customerName').focus();
            return;
        }
        
        if (!phone || !/^0\d{9}$/.test(phone)) {
            showToast('‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!');
            document.getElementById('customerPhone').focus();
            return;
        }
        
        if (!address) {
            showToast('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!');
            document.getElementById('customerAddress').focus();
            return;
        }

        // Disable button
        const btnCheckout = document.getElementById('btnCheckout');
        btnCheckout.disabled = true;
        btnCheckout.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

        // Create order via API
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : SHIPPING_FEE;
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const customerId = user.id || null;
        
        const paymentNames = {
            'cod': 'Ti·ªÅn m·∫∑t (COD)',
            'momo': 'V√≠ MoMo',
            'zalopay': 'ZaloPay',
            'bank': 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng'
        };
        
        const orderItems = cart.map(item => ({
            productId: item.productId || parseInt(item.code?.replace(/\D/g, '')) || 1,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            spicyLevel: item.spicyLevel || 0,
            brothType: item.broth || null,
            note: null
        }));
        
        fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customerId: customerId,
                customerName: name,
                phone: phone,
                address: address,
                subtotal: subtotal,
                shippingFee: shipping,
                discount: currentDiscount,
                paymentMethod: paymentNames[paymentMethod] || 'Ti·ªÅn m·∫∑t (COD)',
                note: note,
                items: orderItems
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const orderCode = data.data.orderCode;
                showToast('üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
                
                saveCustomerInfo(name, phone, address);
                
                const totalValue = subtotal + shipping - currentDiscount;
                localStorage.setItem('lastOrder', JSON.stringify({
                    orderCode: orderCode,
                    orderId: data.data.orderId,
                    customerName: name,
                    phone: phone,
                    address: address,
                    paymentMethod: paymentNames[paymentMethod],
                    subtotal: subtotal,
                    shippingFee: shipping,
                    discount: currentDiscount,
                    total: totalValue,
                    items: orderItems,
                    note: note,
                    orderTime: new Date().toISOString()
                }));
                
                localStorage.removeItem('cart');
                updateCartBadge();
                
                setTimeout(() => {
                    window.location.href = '/DatHangThanhCong/' + orderCode;
                }, 1000);
            } else {
                showToast('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra!'));
                btnCheckout.disabled = false;
                btnCheckout.innerHTML = '<span class="checkout-text"><i class="fas fa-shopping-bag"></i> Ho√†n t·∫•t ƒë∆°n h√†ng</span><span class="checkout-total" id="checkoutTotal">' + document.getElementById('total').textContent + '</span>';
            }
        })
        .catch(err => {
            console.error('Order API error:', err);
            const orderCode = 'DH' + Date.now().toString().slice(-8);
            showToast('üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
            
            saveCustomerInfo(name, phone, address);
            
            const totalValue = subtotal + shipping - currentDiscount;
            localStorage.setItem('lastOrder', JSON.stringify({
                orderCode: orderCode,
                customerName: name,
                phone: phone,
                address: address,
                paymentMethod: paymentNames[paymentMethod],
                total: totalValue,
                items: orderItems,
                orderTime: new Date().toISOString()
            }));
            
            localStorage.removeItem('cart');
            updateCartBadge();
            setTimeout(() => {
                window.location.href = '/DatHangThanhCong/' + orderCode;
            }, 1000);
        });
    }

    function updateCartBadge() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        const badge = document.getElementById('cartCount');
        if (badge) badge.textContent = count;
    }

    function showToast(message) {
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.innerHTML = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
    }

    function loadUserInfo() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const customerInfoKey = user.id ? `customerInfo_${user.id}` : 'customerInfo_guest';
        const savedInfo = JSON.parse(localStorage.getItem(customerInfoKey) || '{}');
        let hasSavedInfo = false;
        
        if (savedInfo.name) {
            document.getElementById('customerName').value = savedInfo.name;
            hasSavedInfo = true;
        } else if (user.name) {
            document.getElementById('customerName').value = user.name;
        }
        
        if (savedInfo.phone) {
            document.getElementById('customerPhone').value = savedInfo.phone;
            hasSavedInfo = true;
        } else if (user.phone) {
            document.getElementById('customerPhone').value = user.phone;
        }
        
        if (savedInfo.address) {
            document.getElementById('customerAddress').value = savedInfo.address;
            hasSavedInfo = true;
        } else if (user.address) {
            document.getElementById('customerAddress').value = user.address;
        }
        
        if (hasSavedInfo) {
            document.getElementById('savedInfoNote').style.display = 'flex';
        }
    }
    
    function saveCustomerInfo(name, phone, address) {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const customerInfoKey = user.id ? `customerInfo_${user.id}` : 'customerInfo_guest';
        const customerInfo = { name, phone, address, savedAt: new Date().toISOString() };
        localStorage.setItem(customerInfoKey, JSON.stringify(customerInfo));
    }

    function showLoginRequiredModal() {
        document.getElementById('loginModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLoginModal() {
        document.getElementById('loginModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === this) closeLoginModal();
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeLoginModal();
    });

    // Update transfer content on input change
    document.getElementById('customerName')?.addEventListener('input', updateTransferContent);
    document.getElementById('customerPhone')?.addEventListener('input', updateTransferContent);

    // Initialize
    loadCart();
    loadUserInfo();
</script>
}
