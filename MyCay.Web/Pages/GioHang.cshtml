@page
@model GioHangModel
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<section class="cart-page">
    <div class="container">
        <div class="cart-header">
            <h1 class="page-title">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>
            <p class="page-subtitle" id="cartSummary">ƒêang t·∫£i...</p>
        </div>

        <div class="cart-content" id="cartContent">
            <!-- Cart Items -->
            <div class="cart-items" id="cartItems">
                <!-- Items will be loaded by JavaScript -->
            </div>

            <!-- Cart Sidebar -->
            <div class="cart-sidebar">
                <!-- Order Summary -->
                <div class="cart-summary-card">
                    <h3>üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    
                    <div class="summary-row">
                        <span>T·∫°m t√≠nh</span>
                        <span id="subtotal">0ƒë</span>
                    </div>
                    <div class="summary-row">
                        <span>Ph√≠ giao h√†ng</span>
                        <span id="shippingFee">15.000ƒë</span>
                    </div>
                    <div class="summary-row discount" id="discountRow" style="display:none;">
                        <span>Gi·∫£m gi√° (<span id="promoCodeApplied"></span>)</span>
                        <span id="discount">-0ƒë</span>
                    </div>
                    <hr />
                    <div class="summary-row total">
                        <span>T·ªïng c·ªông</span>
                        <span id="total">0ƒë</span>
                    </div>

                    <div class="promo-code">
                        <input type="text" id="promoInput" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" />
                        <button onclick="applyPromo()">√Åp d·ª•ng</button>
                    </div>
                    
                    <div class="promo-suggestions">
                        <small>M√£ g·ª£i √Ω: </small>
                        <span class="promo-tag" onclick="usePromo('SASIN10')">SASIN10</span>
                        <span class="promo-tag" onclick="usePromo('SASIN20')">SASIN20</span>
                        <span class="promo-tag" onclick="usePromo('FREESHIP')">FREESHIP</span>
                    </div>

                    <p class="free-ship-note">
                        üöö Mi·ªÖn ph√≠ giao h√†ng cho ƒë∆°n t·ª´ <strong>100.000ƒë</strong>
                    </p>
                </div>

                <!-- Customer Info -->
                <div class="customer-info-card">
                    <h3>üìç Th√¥ng tin giao h√†ng</h3>
                    <p class="saved-info-note" id="savedInfoNote" style="display:none;">
                        ‚úì Th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞u t·ª´ l·∫ßn ƒë·∫∑t h√†ng tr∆∞·ªõc
                    </p>
                    <div class="form-group">
                        <label>H·ªç t√™n *</label>
                        <input type="text" id="customerName" placeholder="Nguy·ªÖn VƒÉn A" required />
                    </div>
                    <div class="form-group">
                        <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" id="customerPhone" placeholder="0901234567" required />
                    </div>
                    <div class="form-group">
                        <label>ƒê·ªãa ch·ªâ giao h√†ng *</label>
                        <textarea id="customerAddress" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="orderNote" placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh, kh√¥ng h√†nh..."></textarea>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="payment-methods-card">
                    <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-options">
                        <label class="payment-option selected" data-method="cash">
                            <input type="radio" name="paymentMethod" value="cash" checked />
                            <div class="payment-icon">üíµ</div>
                            <div class="payment-info">
                                <span class="payment-name">Ti·ªÅn m·∫∑t (COD)</span>
                                <span class="payment-desc">Thanh to√°n khi nh·∫≠n h√†ng</span>
                            </div>
                            <span class="payment-check">‚úì</span>
                        </label>
                        
                        <label class="payment-option" data-method="momo">
                            <input type="radio" name="paymentMethod" value="momo" />
                            <div class="payment-icon">
                                <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="MoMo" />
                            </div>
                            <div class="payment-info">
                                <span class="payment-name">V√≠ MoMo</span>
                                <span class="payment-desc">Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ MoMo</span>
                            </div>
                            <span class="payment-check">‚úì</span>
                        </label>
                        
                        <label class="payment-option" data-method="zalopay">
                            <input type="radio" name="paymentMethod" value="zalopay" />
                            <div class="payment-icon">
                                <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-ZaloPay-Square.png" alt="ZaloPay" />
                            </div>
                            <div class="payment-info">
                                <span class="payment-name">ZaloPay</span>
                                <span class="payment-desc">Thanh to√°n qua v√≠ ZaloPay</span>
                            </div>
                            <span class="payment-check">‚úì</span>
                        </label>
                        
                        <label class="payment-option" data-method="vnpay">
                            <input type="radio" name="paymentMethod" value="vnpay" />
                            <div class="payment-icon">
                                <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-VNPAY-QR-1.png" alt="VNPay" />
                            </div>
                            <div class="payment-info">
                                <span class="payment-name">VNPay QR</span>
                                <span class="payment-desc">Qu√©t m√£ QR thanh to√°n</span>
                            </div>
                            <span class="payment-check">‚úì</span>
                        </label>
                        
                        <label class="payment-option" data-method="bank">
                            <input type="radio" name="paymentMethod" value="bank" />
                            <div class="payment-icon">üè¶</div>
                            <div class="payment-info">
                                <span class="payment-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                                <span class="payment-desc">Chuy·ªÉn kho·∫£n tr∆∞·ªõc khi giao</span>
                            </div>
                            <span class="payment-check">‚úì</span>
                        </label>
                    </div>
                    
                    <!-- Bank Info (shown when bank transfer selected) -->
                    <div class="bank-info" id="bankInfo" style="display: none;">
                        <div class="bank-details">
                            <p><strong>Ng√¢n h√†ng:</strong> Vietcombank</p>
                            <p><strong>S·ªë t√†i kho·∫£n:</strong> 1234567890</p>
                            <p><strong>Ch·ªß t√†i kho·∫£n:</strong> CONG TY TNHH MY CAY SASIN</p>
                            <p><strong>N·ªôi dung CK:</strong> <span id="transferContent">T√™n + SƒêT</span></p>
                        </div>
                    </div>
                    
                    <button class="btn-checkout" onclick="checkout()">
                        üõçÔ∏è ƒê·∫∑t h√†ng ngay
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty Cart -->
        <div class="empty-cart" id="emptyCart" style="display:none;">
            <div class="empty-icon">üõí</div>
            <h2>Gi·ªè h√†ng tr·ªëng</h2>
            <p>B·∫°n ch∆∞a c√≥ m√≥n n√†o trong gi·ªè h√†ng</p>
            <a href="/ThucDon" class="btn btn-primary">
                <i class="fas fa-utensils"></i> Xem th·ª±c ƒë∆°n
            </a>
        </div>
    </div>
</section>

<!-- Login Required Modal -->
<div class="login-modal-overlay" id="loginModal">
    <div class="login-modal">
        <button class="modal-close" onclick="closeLoginModal()">√ó</button>
        <div class="login-modal-icon">üîê</div>
        <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng. N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, h√£y ƒëƒÉng k√Ω ngay!</p>
        <div class="login-modal-buttons">
            <a href="/DangNhap?returnUrl=/GioHang" class="btn-login">
                <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
            </a>
            <a href="/DangKy?returnUrl=/GioHang" class="btn-register">
                <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
            </a>
        </div>
    </div>
</div>

<style>
.promo-suggestions {
    margin-top: 10px;
    font-size: 0.85rem;
}
.promo-tag {
    display: inline-block;
    padding: 4px 10px;
    background: #fef3c7;
    color: #d97706;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    margin: 2px;
    transition: all 0.2s;
}
.promo-tag:hover {
    background: #f97316;
    color: white;
}

/* Saved Info Note */
.saved-info-note {
    background: #d1fae5;
    color: #059669;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 0.9rem;
    margin-bottom: 15px;
    border-left: 4px solid #10b981;
}

/* Payment Methods */
.payment-methods-card {
    background: var(--white);
    padding: 25px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
}
.payment-methods-card h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--gray-light);
}
.payment-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}
.payment-option {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid var(--gray-light);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.payment-option:hover {
    border-color: var(--primary);
    background: #fff7ed;
}
.payment-option.selected {
    border-color: var(--primary);
    background: #fff7ed;
}
.payment-option input[type="radio"] {
    display: none;
}
.payment-icon {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    background: var(--light);
    border-radius: 10px;
    flex-shrink: 0;
}
.payment-icon img {
    width: 35px;
    height: 35px;
    object-fit: contain;
}
.payment-info {
    flex: 1;
}
.payment-name {
    display: block;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 3px;
}
.payment-desc {
    display: block;
    font-size: 0.85rem;
    color: var(--gray);
}
.payment-check {
    width: 24px;
    height: 24px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}
.payment-option.selected .payment-check {
    display: flex;
}
.bank-info {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}
.bank-details p {
    margin: 8px 0;
    font-size: 0.95rem;
}
.bank-details strong {
    color: var(--dark);
}

/* Item Options (broth, spicy level) */
.item-options {
    display: block;
    font-size: 0.85rem;
    color: #f97316;
    background: #fff7ed;
    padding: 4px 10px;
    border-radius: 6px;
    margin: 5px 0;
    font-weight: 500;
}

/* Login Required Modal */
.login-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    padding: 20px;
}
.login-modal-overlay.active {
    display: flex;
}
.login-modal {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    max-width: 420px;
    width: 100%;
    position: relative;
    animation: modalPop 0.3s ease;
}
@@keyframes modalPop {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.login-modal .modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
}
.login-modal .modal-close:hover {
    background: #ef4444;
    color: white;
}
.login-modal-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}
.login-modal h2 {
    font-size: 1.5rem;
    color: #1f2937;
    margin-bottom: 15px;
}
.login-modal p {
    color: #6b7280;
    margin-bottom: 25px;
    line-height: 1.6;
}
.login-modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}
.login-modal-buttons a {
    padding: 14px 28px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.btn-login {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}
.btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249,115,22,0.4);
}
.btn-register {
    background: #f3f4f6;
    color: #374151;
}
.btn-register:hover {
    background: #e5e7eb;
}
</style>

@section Scripts {
<script>
    const SHIPPING_FEE = 15000;
    const FREE_SHIP_THRESHOLD = 100000;
    let currentDiscount = 0;
    let currentPromoCode = '';

    const promoCodes = {
        'SASIN10': { type: 'percent', value: 10, min: 100000, desc: 'Gi·∫£m 10%' },
        'SASIN20': { type: 'percent', value: 20, min: 200000, desc: 'Gi·∫£m 20%' },
        'FREESHIP': { type: 'shipping', value: 15000, min: 150000, desc: 'Mi·ªÖn ph√≠ ship' },
        'NEWUSER': { type: 'fixed', value: 30000, min: 100000, desc: 'Gi·∫£m 30k' }
    };

    function loadCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const container = document.getElementById('cartItems');
        const emptyCart = document.getElementById('emptyCart');
        const cartContent = document.getElementById('cartContent');

        if (cart.length === 0) {
            cartContent.style.display = 'none';
            emptyCart.style.display = 'block';
            document.getElementById('cartSummary').textContent = 'Gi·ªè h√†ng tr·ªëng';
            return;
        }

        cartContent.style.display = 'grid';
        emptyCart.style.display = 'none';
        
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartSummary').textContent = `${totalItems} m√≥n trong gi·ªè h√†ng`;

        container.innerHTML = cart.map((item, index) => `
            <div class="cart-item" data-index="${index}">
                <div class="item-image">
                    <img src="/images/products/${item.image || 'MenuItem_' + item.code + '.webp'}" alt="${item.name}" 
                         onerror="this.src='/images/products/MenuItem_M00012.webp'" />
                </div>
                <div class="item-details">
                    <h4 class="item-name">${item.name}</h4>
                    ${item.broth ? `<span class="item-options">üçú ${item.broth} | üå∂Ô∏è C·∫•p ${item.spicyLevel}</span>` : ''}
                    <span class="item-price">${formatPrice(item.price)}ƒë / ph·∫ßn</span>
                </div>
                <div class="item-quantity">
                    <button class="qty-btn" onclick="updateQuantity(${index}, -1)">‚àí</button>
                    <span class="qty-value">${item.quantity}</span>
                    <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                </div>
                <div class="item-total">
                    ${formatPrice(item.price * item.quantity)}ƒë
                </div>
                <button class="item-remove" onclick="removeItem(${index})" title="X√≥a">‚úï</button>
            </div>
        `).join('');

        updateTotals();
    }

    function updateQuantity(index, delta) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart[index]) {
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            updateCartBadge();
        }
    }

    function removeItem(index) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?')) return;
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartBadge();
        showToast('ƒê√£ x√≥a kh·ªèi gi·ªè h√†ng');
    }

    function updateTotals() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : SHIPPING_FEE;
        
        // Apply promo
        let discount = 0;
        if (currentPromoCode && promoCodes[currentPromoCode]) {
            const promo = promoCodes[currentPromoCode];
            if (subtotal >= promo.min) {
                if (promo.type === 'percent') {
                    discount = subtotal * promo.value / 100;
                } else if (promo.type === 'fixed') {
                    discount = promo.value;
                } else if (promo.type === 'shipping') {
                    shipping = 0;
                    discount = 0;
                }
            }
        }
        
        currentDiscount = discount;
        const total = Math.max(0, subtotal + shipping - discount);

        document.getElementById('subtotal').textContent = formatPrice(subtotal) + 'ƒë';
        document.getElementById('shippingFee').textContent = shipping === 0 ? 'Mi·ªÖn ph√≠ üéâ' : formatPrice(shipping) + 'ƒë';
        document.getElementById('total').textContent = formatPrice(total) + 'ƒë';

        if (currentDiscount > 0 || (currentPromoCode && promoCodes[currentPromoCode]?.type === 'shipping')) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('promoCodeApplied').textContent = currentPromoCode;
            document.getElementById('discount').textContent = currentDiscount > 0 ? '-' + formatPrice(currentDiscount) + 'ƒë' : 'Mi·ªÖn ship';
        } else {
            document.getElementById('discountRow').style.display = 'none';
        }
    }

    function formatPrice(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function usePromo(code) {
        document.getElementById('promoInput').value = code;
        applyPromo();
    }

    function applyPromo() {
        const code = document.getElementById('promoInput').value.toUpperCase().trim();
        
        if (!code) {
            showToast('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!');
            return;
        }

        if (!promoCodes[code]) {
            showToast('‚ùå M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá!');
            return;
        }

        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const promo = promoCodes[code];

        if (subtotal < promo.min) {
            showToast(`‚ùå ƒê∆°n h√†ng t·ªëi thi·ªÉu ${formatPrice(promo.min)}ƒë ƒë·ªÉ √°p d·ª•ng m√£ n√†y!`);
            return;
        }

        currentPromoCode = code;
        updateTotals();
        showToast(`‚úì √Åp d·ª•ng m√£ ${code} th√†nh c√¥ng! ${promo.desc}`);
    }

    function isLoggedIn() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        return user && user.username;
    }

    function checkout() {
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        if (!isLoggedIn()) {
            showLoginRequiredModal();
            return;
        }

        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
            showToast('‚ùå Gi·ªè h√†ng tr·ªëng!');
            return;
        }

        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const address = document.getElementById('customerAddress').value.trim();
        const note = document.getElementById('orderNote').value.trim();
        const payment = getSelectedPaymentMethod();

        if (!name) {
            showToast('‚ùå Vui l√≤ng nh·∫≠p h·ªç t√™n!');
            document.getElementById('customerName').focus();
            return;
        }
        
        if (!phone || !/^0\d{9}$/.test(phone)) {
            showToast('‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!');
            document.getElementById('customerPhone').focus();
            return;
        }
        
        if (!address) {
            showToast('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!');
            document.getElementById('customerAddress').focus();
            return;
        }

        // Create order via API
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : SHIPPING_FEE;
        const totalText = document.getElementById('total').textContent;
        
        // Get customer ID if logged in
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const customerId = user.id || null;
        
        // Prepare order items
        const orderItems = cart.map(item => ({
            productId: item.productId || parseInt(item.code?.replace(/\D/g, '')) || 1,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            spicyLevel: item.spicyLevel || 0,
            brothType: item.broth || null,
            note: null
        }));
        
        // Call API to create order
        fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customerId: customerId,
                customerName: name,
                phone: phone,
                address: address,
                subtotal: subtotal,
                shippingFee: shipping,
                discount: currentDiscount,
                paymentMethod: payment.name,
                note: note,
                items: orderItems
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const orderCode = data.data.orderCode;
                showToast('üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
                
                // L∆∞u th√¥ng tin kh√°ch h√†ng ƒë·ªÉ d√πng cho l·∫ßn ƒë·∫∑t h√†ng sau
                saveCustomerInfo(name, phone, address);
                
                // Save order info for success page
                const totalValue = subtotal + shipping - currentDiscount;
                localStorage.setItem('lastOrder', JSON.stringify({
                    orderCode: orderCode,
                    orderId: data.data.orderId,
                    customerName: name,
                    phone: phone,
                    address: address,
                    paymentMethod: payment.name,
                    subtotal: subtotal,
                    shippingFee: shipping,
                    discount: currentDiscount,
                    total: totalValue,
                    items: orderItems,
                    note: note,
                    orderTime: new Date().toISOString()
                }));
                
                // Clear cart
                localStorage.removeItem('cart');
                updateCartBadge();
                
                // Redirect to success page
                setTimeout(() => {
                    window.location.href = '/DatHangThanhCong/' + orderCode;
                }, 1000);
            } else {
                showToast('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra!'));
            }
        })
        .catch(err => {
            console.error('Order API error:', err);
            // Fallback: still show success with local order code
            const orderCode = 'DH' + Date.now().toString().slice(-8);
            showToast('üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
            
            // L∆∞u th√¥ng tin kh√°ch h√†ng ƒë·ªÉ d√πng cho l·∫ßn ƒë·∫∑t h√†ng sau
            saveCustomerInfo(name, phone, address);
            
            const totalValue = subtotal + shipping - currentDiscount;
            localStorage.setItem('lastOrder', JSON.stringify({
                orderCode: orderCode,
                customerName: name,
                phone: phone,
                address: address,
                paymentMethod: payment.name,
                total: totalValue,
                items: orderItems,
                orderTime: new Date().toISOString()
            }));
            
            localStorage.removeItem('cart');
            updateCartBadge();
            setTimeout(() => {
                window.location.href = '/DatHangThanhCong/' + orderCode;
            }, 1000);
        });
    }

    function updateCartBadge() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        const badge = document.getElementById('cartCount');
        if (badge) badge.textContent = count;
    }

    function showToast(message) {
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.innerHTML = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
    }

    // Load user info from localStorage if logged in
    function loadUserInfo() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // L·∫•y customerInfo theo userId ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n gi·ªØa c√°c user
        const customerInfoKey = user.id ? `customerInfo_${user.id}` : 'customerInfo_guest';
        const savedInfo = JSON.parse(localStorage.getItem(customerInfoKey) || '{}');
        let hasSavedInfo = false;
        
        // ∆Øu ti√™n th√¥ng tin ƒë√£ l∆∞u t·ª´ l·∫ßn ƒë·∫∑t h√†ng tr∆∞·ªõc c·ªßa user n√†y
        if (savedInfo.name) {
            document.getElementById('customerName').value = savedInfo.name;
            hasSavedInfo = true;
        } else if (user.name) {
            document.getElementById('customerName').value = user.name;
        }
        
        if (savedInfo.phone) {
            document.getElementById('customerPhone').value = savedInfo.phone;
            hasSavedInfo = true;
        } else if (user.phone) {
            document.getElementById('customerPhone').value = user.phone;
        }
        
        if (savedInfo.address) {
            document.getElementById('customerAddress').value = savedInfo.address;
            hasSavedInfo = true;
        } else if (user.address) {
            document.getElementById('customerAddress').value = user.address;
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu c√≥ th√¥ng tin ƒë√£ l∆∞u
        if (hasSavedInfo) {
            document.getElementById('savedInfoNote').style.display = 'block';
        }
    }
    
    // L∆∞u th√¥ng tin kh√°ch h√†ng theo userId ƒë·ªÉ d√πng cho l·∫ßn sau
    function saveCustomerInfo(name, phone, address) {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const customerInfoKey = user.id ? `customerInfo_${user.id}` : 'customerInfo_guest';
        const customerInfo = { name, phone, address, savedAt: new Date().toISOString() };
        localStorage.setItem(customerInfoKey, JSON.stringify(customerInfo));
    }

    // Payment method selection
    function initPaymentMethods() {
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected from all
                document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                // Add selected to clicked
                this.classList.add('selected');
                // Check the radio
                this.querySelector('input[type="radio"]').checked = true;
                
                // Show/hide bank info
                const method = this.dataset.method;
                const bankInfo = document.getElementById('bankInfo');
                if (method === 'bank') {
                    bankInfo.style.display = 'block';
                    updateTransferContent();
                } else {
                    bankInfo.style.display = 'none';
                }
            });
        });
    }

    function updateTransferContent() {
        const name = document.getElementById('customerName').value || 'TEN';
        const phone = document.getElementById('customerPhone').value || 'SDT';
        document.getElementById('transferContent').textContent = `${name} ${phone}`;
    }

    // Update transfer content when name/phone changes
    document.getElementById('customerName')?.addEventListener('input', updateTransferContent);
    document.getElementById('customerPhone')?.addEventListener('input', updateTransferContent);

    function getSelectedPaymentMethod() {
        const selected = document.querySelector('input[name="paymentMethod"]:checked');
        const methods = {
            'cash': 'Ti·ªÅn m·∫∑t (COD)',
            'momo': 'V√≠ MoMo',
            'zalopay': 'ZaloPay',
            'vnpay': 'VNPay QR',
            'bank': 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng'
        };
        return {
            code: selected?.value || 'cash',
            name: methods[selected?.value] || 'Ti·ªÅn m·∫∑t (COD)'
        };
    }

    // Show login required modal
    function showLoginRequiredModal() {
        document.getElementById('loginModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // Close login modal
    function closeLoginModal() {
        document.getElementById('loginModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close modal on overlay click
    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLoginModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLoginModal();
        }
    });

    loadCart();
    loadUserInfo();
    initPaymentMethods();
</script>
}
