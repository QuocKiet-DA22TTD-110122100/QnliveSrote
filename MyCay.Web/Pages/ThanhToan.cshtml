@page
@model ThanhToanModel
@{
    ViewData["Title"] = "Thanh to√°n";
}

<!-- Checkout Progress Steps -->
<div class="checkout-steps">
    <div class="step completed">
        <div class="step-number"><i class="fas fa-check"></i></div>
        <span>Gi·ªè h√†ng</span>
    </div>
    <div class="step-line active"></div>
    <div class="step active">
        <div class="step-number">2</div>
        <span>Thanh to√°n</span>
    </div>
    <div class="step-line"></div>
    <div class="step">
        <div class="step-number">3</div>
        <span>Ho√†n t·∫•t</span>
    </div>
</div>

<section class="checkout-page">
    <div class="container">
        <div class="checkout-header">
            <h1>üí≥ Thanh to√°n ƒë∆°n h√†ng</h1>
            <p id="orderSummaryText">ƒêang t·∫£i...</p>
        </div>

        <div class="checkout-grid">
            <!-- Left Column - Order Items & Store Selection -->
            <div class="checkout-left">
                <!-- Selected Items Summary -->
                <div class="checkout-card">
                    <div class="card-header">
                        <h3>üõí S·∫£n ph·∫©m ƒë√£ ch·ªçn</h3>
                        <a href="/GioHang" class="btn-edit"><i class="fas fa-edit"></i> S·ª≠a</a>
                    </div>
                    <div class="selected-items" id="selectedItems">
                        <!-- Items loaded by JS -->
                    </div>
                </div>

                <!-- Store Selection with Map -->
                <div class="checkout-card">
                    <div class="card-header">
                        <h3>üè™ Ch·ªçn c·ª≠a h√†ng g·∫ßn nh·∫•t</h3>
                        <button class="btn-locate" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i> ƒê·ªãnh v·ªã
                        </button>
                    </div>
                    
                    <div class="location-status" id="locationStatus" style="display:none;">
                        <i class="fas fa-spinner fa-spin"></i> ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...
                    </div>
                    
                    <div class="store-list" id="storeList">
                        <!-- Stores loaded by JS -->
                    </div>
                    
                    <div class="map-container" id="mapContainer">
                        <div class="map-placeholder" id="mapPlaceholder">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Nh·∫•n "ƒê·ªãnh v·ªã" ƒë·ªÉ xem b·∫£n ƒë·ªì c·ª≠a h√†ng g·∫ßn b·∫°n</p>
                        </div>
                        <div id="storeMap" style="display:none;"></div>
                    </div>
                </div>

                <!-- Delivery Address -->
                <div class="checkout-card">
                    <div class="card-header">
                        <h3>üìç ƒê·ªãa ch·ªâ giao h√†ng</h3>
                        <button class="btn-use-location" onclick="useCurrentLocationForAddress()">
                            <i class="fas fa-location-arrow"></i> D√πng v·ªã tr√≠ hi·ªán t·∫°i
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> H·ªç t√™n ng∆∞·ªùi nh·∫≠n *</label>
                        <input type="text" id="customerName" placeholder="Nguy·ªÖn VƒÉn A" required />
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i *</label>
                        <input type="tel" id="customerPhone" placeholder="0901234567" required />
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ chi ti·∫øt *</label>
                        <textarea id="customerAddress" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, th√†nh ph·ªë" required></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Ghi ch√∫ cho shipper</label>
                        <textarea id="orderNote" placeholder="V√≠ d·ª•: G·ªçi tr∆∞·ªõc khi giao, ƒë·ªÉ ·ªü b·∫£o v·ªá..."></textarea>
                    </div>
                    
                    <div class="delivery-estimate" id="deliveryEstimate" style="display:none;">
                        <i class="fas fa-truck"></i>
                        <span>D·ª± ki·∫øn giao trong <strong id="estimateTime">30 ph√∫t</strong></span>
                    </div>
                </div>
            </div>

            <!-- Right Column - Payment -->
            <div class="checkout-right">
                <!-- Promo Code -->
                <div class="checkout-card promo-card">
                    <h3>üéÅ M√£ gi·∫£m gi√°</h3>
                    <div class="promo-input-wrapper">
                        <input type="text" id="promoInput" placeholder="Nh·∫≠p m√£ ∆∞u ƒë√£i" />
                        <button onclick="applyPromo()" class="btn-apply">√Åp d·ª•ng</button>
                    </div>
                    <div class="promo-applied" id="promoApplied" style="display:none;">
                        <span class="promo-badge"><i class="fas fa-check-circle"></i> <span id="promoAppliedText"></span></span>
                        <button onclick="removePromo()" class="btn-remove">√ó</button>
                    </div>
                    <div class="promo-suggestions">
                        <p>M√£ g·ª£i √Ω:</p>
                        <div class="promo-tags">
                            <span class="promo-tag" onclick="usePromo('NEWUSER15')">NEWUSER15 <small>-15%</small></span>
                            <span class="promo-tag" onclick="usePromo('FREESHIP')">FREESHIP</span>
                            <span class="promo-tag" onclick="usePromo('SASIN30K')">SASIN30K</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="checkout-card">
                    <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-options">
                        <label class="payment-option active" data-method="cod">
                            <input type="radio" name="payment" value="cod" checked />
                            <span class="option-icon">üíµ</span>
                            <span class="option-info">
                                <strong>Ti·ªÅn m·∫∑t (COD)</strong>
                                <small>Thanh to√°n khi nh·∫≠n h√†ng</small>
                            </span>
                            <span class="option-check"><i class="fas fa-check-circle"></i></span>
                        </label>
                        <label class="payment-option" data-method="momo">
                            <input type="radio" name="payment" value="momo" />
                            <span class="option-icon"><img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="MoMo" /></span>
                            <span class="option-info">
                                <strong>V√≠ MoMo</strong>
                                <small>Qu√©t QR thanh to√°n</small>
                            </span>
                            <span class="option-check"><i class="fas fa-check-circle"></i></span>
                        </label>
                        <label class="payment-option" data-method="zalopay">
                            <input type="radio" name="payment" value="zalopay" />
                            <span class="option-icon"><img src="https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-ZaloPay-Square.png" alt="ZaloPay" /></span>
                            <span class="option-info">
                                <strong>ZaloPay</strong>
                                <small>Thanh to√°n qua v√≠</small>
                            </span>
                            <span class="option-check"><i class="fas fa-check-circle"></i></span>
                        </label>
                        <label class="payment-option" data-method="bank">
                            <input type="radio" name="payment" value="bank" />
                            <span class="option-icon">üè¶</span>
                            <span class="option-info">
                                <strong>Chuy·ªÉn kho·∫£n</strong>
                                <small>Ng√¢n h√†ng n·ªôi ƒë·ªãa</small>
                            </span>
                            <span class="option-check"><i class="fas fa-check-circle"></i></span>
                        </label>
                    </div>
                    
                    <div class="bank-details" id="bankDetails" style="display:none;">
                        <div class="bank-info">
                            <div class="bank-row"><span>Ng√¢n h√†ng:</span><strong>Vietcombank</strong></div>
                            <div class="bank-row"><span>S·ªë TK:</span><strong>1234567890</strong> <button onclick="copyText('1234567890')" class="btn-copy"><i class="fas fa-copy"></i></button></div>
                            <div class="bank-row"><span>Ch·ªß TK:</span><strong>CTY TNHH MY CAY SASIN</strong></div>
                            <div class="bank-row"><span>N·ªôi dung:</span><strong id="transferContent">T√™n SƒêT</strong></div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="checkout-card summary-card">
                    <h3>üìã T·ªïng ƒë∆°n h√†ng</h3>
                    <div class="summary-rows">
                        <div class="summary-row">
                            <span>T·∫°m t√≠nh (<span id="itemCount">0</span> m√≥n)</span>
                            <span id="subtotal">0ƒë</span>
                        </div>
                        <div class="summary-row">
                            <span>Ph√≠ giao h√†ng</span>
                            <span id="shippingFee">25.000ƒë</span>
                        </div>
                        <div class="summary-row discount" id="discountRow" style="display:none;">
                            <span>Gi·∫£m gi√°</span>
                            <span id="discountAmount">-0ƒë</span>
                        </div>
                    </div>
                    <div class="summary-total">
                        <span>T·ªïng thanh to√°n</span>
                        <span id="totalAmount">0ƒë</span>
                    </div>
                    
                    <button class="btn-place-order" onclick="placeOrder()" id="btnPlaceOrder">
                        <i class="fas fa-check-circle"></i>
                        <span>ƒê·∫∑t h√†ng</span>
                        <span class="order-total" id="btnTotal">0ƒë</span>
                    </button>
                    
                    <p class="order-note">
                        <i class="fas fa-shield-alt"></i> ƒê∆°n h√†ng ƒë∆∞·ª£c b·∫£o m·∫≠t 100%
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Toast -->
<div id="toast" class="toast"></div>

<style>
/* Checkout Steps */
.checkout-steps {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}
.step {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #9ca3af;
    font-weight: 500;
    font-size: 0.9rem;
}
.step.active { color: #f97316; }
.step.completed { color: #10b981; }
.step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}
.step.active .step-number {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}
.step.completed .step-number {
    background: #10b981;
    color: white;
}
.step-line {
    width: 60px;
    height: 3px;
    background: #e5e7eb;
    margin: 0 15px;
}
.step-line.active {
    background: linear-gradient(90deg, #10b981, #f97316);
}

/* Checkout Page */
.checkout-page {
    background: #f8fafc;
    min-height: calc(100vh - 150px);
    padding: 25px 15px 50px;
}
.checkout-header {
    text-align: center;
    margin-bottom: 25px;
}
.checkout-header h1 {
    font-size: 1.6rem;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 5px;
}
.checkout-header p {
    color: #6b7280;
}

/* Grid Layout */
.checkout-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 25px;
    max-width: 1100px;
    margin: 0 auto;
}

/* Cards */
.checkout-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.checkout-card h3 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 15px;
}
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.card-header h3 { margin-bottom: 0; }
.btn-edit, .btn-locate, .btn-use-location {
    background: #fff7ed;
    color: #f97316;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}
.btn-edit:hover, .btn-locate:hover, .btn-use-location:hover {
    background: #f97316;
    color: white;
}

/* Selected Items */
.selected-items {
    max-height: 250px;
    overflow-y: auto;
}
.selected-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #f3f4f6;
}
.selected-item:last-child { border-bottom: none; }
.selected-item img {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
}
.item-info { flex: 1; }
.item-info h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 3px;
}
.item-info small {
    color: #6b7280;
    font-size: 0.8rem;
}
.item-price {
    font-weight: 700;
    color: #f97316;
}

/* Store List */
.store-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}
.store-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}
.store-item:hover { border-color: #f97316; background: #fff7ed; }
.store-item.selected {
    border-color: #f97316;
    background: #fff7ed;
}
.store-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}
.store-info { flex: 1; }
.store-info h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 2px;
}
.store-info p {
    font-size: 0.8rem;
    color: #6b7280;
    margin: 0;
}
.store-distance {
    font-size: 0.85rem;
    font-weight: 600;
    color: #10b981;
}
.store-check {
    color: #f97316;
    font-size: 1.2rem;
    display: none;
}
.store-item.selected .store-check { display: block; }

/* Map */
.map-container {
    height: 200px;
    border-radius: 12px;
    overflow: hidden;
    background: #f3f4f6;
}
.map-placeholder {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
}
.map-placeholder i { font-size: 2.5rem; margin-bottom: 10px; }
.map-placeholder p { font-size: 0.85rem; }
#storeMap { height: 100%; width: 100%; }

/* Location Status */
.location-status {
    padding: 12px;
    background: #fef3c7;
    border-radius: 8px;
    color: #92400e;
    font-size: 0.9rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Form Groups */
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    font-size: 0.9rem;
}
.form-group label i { margin-right: 6px; color: #f97316; }
.form-group input, .form-group textarea {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 0.95rem;
    transition: all 0.2s;
}
.form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
}
.form-group textarea { min-height: 70px; resize: vertical; }

/* Delivery Estimate */
.delivery-estimate {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: #ecfdf5;
    border-radius: 10px;
    color: #059669;
    font-size: 0.9rem;
}

/* Promo Card */
.promo-input-wrapper {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}
.promo-input-wrapper input {
    flex: 1;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 0.95rem;
}
.promo-input-wrapper input:focus {
    outline: none;
    border-color: #f97316;
}
.btn-apply {
    padding: 12px 20px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-apply:hover { transform: scale(1.05); }
.promo-applied {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    background: #d1fae5;
    border-radius: 10px;
    margin-bottom: 12px;
}
.promo-badge {
    color: #059669;
    font-weight: 600;
    font-size: 0.9rem;
}
.btn-remove {
    width: 24px;
    height: 24px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
}
.promo-suggestions p {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 8px;
}
.promo-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.promo-tag {
    padding: 6px 12px;
    background: #fef3c7;
    color: #b45309;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.promo-tag:hover { background: #f97316; color: white; }

/* Payment Options */
.payment-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.payment-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}
.payment-option:hover { border-color: #f97316; }
.payment-option.active {
    border-color: #f97316;
    background: #fff7ed;
}
.payment-option input { display: none; }
.option-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}
.option-icon img { width: 32px; height: 32px; object-fit: contain; }
.option-info { flex: 1; }
.option-info strong { display: block; font-size: 0.95rem; color: #1f2937; }
.option-info small { color: #6b7280; font-size: 0.8rem; }
.option-check {
    color: #f97316;
    font-size: 1.2rem;
    opacity: 0;
    transition: opacity 0.2s;
}
.payment-option.active .option-check { opacity: 1; }

/* Bank Details */
.bank-details {
    margin-top: 15px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 10px;
}
.bank-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed #e5e7eb;
    font-size: 0.9rem;
}
.bank-row:last-child { border-bottom: none; }
.bank-row span { color: #6b7280; }
.bank-row strong { color: #1f2937; }
.btn-copy {
    width: 28px;
    height: 28px;
    background: #e5e7eb;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 8px;
}
.btn-copy:hover { background: #f97316; color: white; }

/* Summary Card */
.summary-card { position: sticky; top: 100px; }
.summary-rows { margin-bottom: 15px; }
.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    font-size: 0.95rem;
    color: #4b5563;
    border-bottom: 1px dashed #e5e7eb;
}
.summary-row.discount { color: #10b981; }
.summary-total {
    display: flex;
    justify-content: space-between;
    padding: 15px 0;
    font-size: 1.1rem;
    font-weight: 700;
    border-top: 2px solid #1f2937;
}
.summary-total span:last-child { color: #f97316; font-size: 1.3rem; }

/* Place Order Button */
.btn-place-order {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
    box-shadow: 0 6px 20px rgba(249,115,22,0.4);
}
.btn-place-order:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(249,115,22,0.5);
}
.btn-place-order:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    box-shadow: none;
}
.order-total {
    background: rgba(255,255,255,0.2);
    padding: 6px 14px;
    border-radius: 8px;
}
.order-note {
    text-align: center;
    margin-top: 15px;
    font-size: 0.85rem;
    color: #10b981;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 14px 24px;
    background: #1f2937;
    color: white;
    border-radius: 12px;
    font-weight: 600;
    z-index: 9999;
    transform: translateX(150%);
    transition: transform 0.3s ease;
}
.toast.show { transform: translateX(0); }
.toast.success { background: linear-gradient(135deg, #10b981, #059669); }
.toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }

/* Responsive */
@@media (max-width: 900px) {
    .checkout-grid {
        grid-template-columns: 1fr;
    }
    .summary-card { position: static; }
    .step span { display: none; }
}
@@media (max-width: 480px) {
    .checkout-page { padding: 15px 10px 40px; }
    .checkout-card { padding: 15px; }
    .store-item { padding: 10px; }
}
</style>


@section Scripts {
<script>
    const SHIPPING_FEE = 25000;
    const FREE_SHIP_THRESHOLD = 200000;
    let currentDiscount = 0;
    let currentPromoCode = '';
    let selectedStore = null;
    let userLocation = null;

    // Promo codes
    const promoCodes = {
        'NEWUSER15': { type: 'percent', value: 15, min: 100000, desc: 'Gi·∫£m 15%' },
        'SASIN10': { type: 'percent', value: 10, min: 80000, desc: 'Gi·∫£m 10%' },
        'SASIN30K': { type: 'fixed', value: 30000, min: 150000, desc: 'Gi·∫£m 30.000ƒë' },
        'FREESHIP': { type: 'shipping', value: 25000, min: 100000, desc: 'Mi·ªÖn ph√≠ ship' }
    };

    // Store locations
    const stores = [
        { id: 1, name: 'M·ª≥ Cay Sasin - Qu·∫≠n 1', address: '123 Nguy·ªÖn Hu·ªá, Q.1, TP.HCM', lat: 10.7769, lng: 106.7009, phone: '028 1234 5678' },
        { id: 2, name: 'M·ª≥ Cay Sasin - Qu·∫≠n 3', address: '456 V√µ VƒÉn T·∫ßn, Q.3, TP.HCM', lat: 10.7731, lng: 106.6880, phone: '028 2345 6789' },
        { id: 3, name: 'M·ª≥ Cay Sasin - Qu·∫≠n 7', address: '789 Nguy·ªÖn Th·ªã Th·∫≠p, Q.7, TP.HCM', lat: 10.7380, lng: 106.7218, phone: '028 3456 7890' },
        { id: 4, name: 'M·ª≥ Cay Sasin - B√¨nh Th·∫°nh', address: '321 ƒêi·ªán Bi√™n Ph·ªß, B√¨nh Th·∫°nh, TP.HCM', lat: 10.8012, lng: 106.7109, phone: '028 4567 8901' },
        { id: 5, name: 'M·ª≥ Cay Sasin - T√¢n B√¨nh', address: '654 C·ªông H√≤a, T√¢n B√¨nh, TP.HCM', lat: 10.8012, lng: 106.6520, phone: '028 5678 9012' }
    ];

    // Load checkout items
    function loadCheckoutItems() {
        const checkoutItems = JSON.parse(localStorage.getItem('checkoutItems') || '[]');
        
        if (checkoutItems.length === 0) {
            window.location.href = '/GioHang';
            return;
        }

        const container = document.getElementById('selectedItems');
        const totalItems = checkoutItems.reduce((sum, item) => sum + item.quantity, 0);
        
        document.getElementById('orderSummaryText').textContent = `${totalItems} m√≥n ƒë√£ ch·ªçn`;
        document.getElementById('itemCount').textContent = totalItems;

        container.innerHTML = checkoutItems.map(item => `
            <div class="selected-item">
                <img src="/images/products/${item.image || 'MenuItem_MI0001.webp'}" alt="${item.name}" 
                     onerror="this.src='/images/products/MenuItem_MI0001.webp'" />
                <div class="item-info">
                    <h4>${item.name}</h4>
                    <small>${item.broth ? `${item.broth}, C·∫•p ${item.spicyLevel} ‚Ä¢ ` : ''}x${item.quantity}</small>
                </div>
                <span class="item-price">${formatPrice(item.price * item.quantity)}ƒë</span>
            </div>
        `).join('');

        updateTotals();
        loadStores();
        loadUserInfo();
    }

    // Load stores
    function loadStores() {
        const container = document.getElementById('storeList');
        container.innerHTML = stores.map((store, index) => `
            <div class="store-item ${index === 0 ? 'selected' : ''}" onclick="selectStore(${store.id})" data-store-id="${store.id}">
                <div class="store-icon">üè™</div>
                <div class="store-info">
                    <h4>${store.name}</h4>
                    <p>${store.address}</p>
                </div>
                <span class="store-distance" id="distance-${store.id}">--</span>
                <span class="store-check"><i class="fas fa-check-circle"></i></span>
            </div>
        `).join('');
        
        selectedStore = stores[0];
    }

    // Select store
    function selectStore(storeId) {
        document.querySelectorAll('.store-item').forEach(item => item.classList.remove('selected'));
        document.querySelector(`.store-item[data-store-id="${storeId}"]`).classList.add('selected');
        selectedStore = stores.find(s => s.id === storeId);
        updateDeliveryEstimate();
    }

    // Get current location
    function getCurrentLocation() {
        const statusEl = document.getElementById('locationStatus');
        statusEl.style.display = 'flex';
        statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...';

        if (!navigator.geolocation) {
            statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã';
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ƒê√£ x√°c ƒë·ªãnh v·ªã tr√≠ c·ªßa b·∫°n!';
                statusEl.style.background = '#d1fae5';
                statusEl.style.color = '#059669';
                
                calculateDistances();
                showMap();
                updateDeliveryEstimate();
                
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
            },
            (error) => {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.';
                statusEl.style.background = '#fef2f2';
                statusEl.style.color = '#dc2626';
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // Calculate distances to stores
    function calculateDistances() {
        if (!userLocation) return;

        stores.forEach(store => {
            const distance = getDistance(userLocation.lat, userLocation.lng, store.lat, store.lng);
            store.distance = distance;
            document.getElementById(`distance-${store.id}`).textContent = distance < 1 
                ? `${Math.round(distance * 1000)}m` 
                : `${distance.toFixed(1)}km`;
        });

        // Sort by distance and re-render
        stores.sort((a, b) => (a.distance || 999) - (b.distance || 999));
        loadStores();
        
        // Auto-select nearest store
        if (stores[0]) {
            selectStore(stores[0].id);
        }
    }

    // Haversine formula for distance
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Show map (placeholder - can integrate Google Maps/Leaflet)
    function showMap() {
        document.getElementById('mapPlaceholder').style.display = 'none';
        const mapEl = document.getElementById('storeMap');
        mapEl.style.display = 'block';
        mapEl.innerHTML = `
            <div style="height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#e0f2fe,#dbeafe);color:#1e40af;">
                <i class="fas fa-map-marked-alt" style="font-size:3rem;margin-bottom:10px;"></i>
                <p style="font-weight:600;">V·ªã tr√≠ c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh</p>
                <small>Lat: ${userLocation.lat.toFixed(4)}, Lng: ${userLocation.lng.toFixed(4)}</small>
            </div>
        `;
    }

    // Use current location for address
    function useCurrentLocationForAddress() {
        if (!userLocation) {
            getCurrentLocation();
            showToast('ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...', 'info');
            return;
        }
        
        // Reverse geocoding (simplified - in production use Google Maps API)
        document.getElementById('customerAddress').value = `V·ªã tr√≠ hi·ªán t·∫°i (${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)})`;
        showToast('ƒê√£ s·ª≠ d·ª•ng v·ªã tr√≠ hi·ªán t·∫°i', 'success');
    }

    // Update delivery estimate
    function updateDeliveryEstimate() {
        const estimateEl = document.getElementById('deliveryEstimate');
        const timeEl = document.getElementById('estimateTime');
        
        if (selectedStore && selectedStore.distance) {
            const minutes = Math.round(15 + selectedStore.distance * 5);
            timeEl.textContent = `${minutes}-${minutes + 10} ph√∫t`;
            estimateEl.style.display = 'flex';
        }
    }

    // Update totals
    function updateTotals() {
        const checkoutItems = JSON.parse(localStorage.getItem('checkoutItems') || '[]');
        const subtotal = checkoutItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : SHIPPING_FEE;
        
        let discount = 0;
        if (currentPromoCode && promoCodes[currentPromoCode]) {
            const promo = promoCodes[currentPromoCode];
            if (subtotal >= promo.min) {
                if (promo.type === 'percent') discount = subtotal * promo.value / 100;
                else if (promo.type === 'fixed') discount = promo.value;
                else if (promo.type === 'shipping') { shipping = 0; }
            }
        }
        
        currentDiscount = discount;
        const total = Math.max(0, subtotal + shipping - discount);

        document.getElementById('subtotal').textContent = formatPrice(subtotal) + 'ƒë';
        document.getElementById('shippingFee').textContent = shipping === 0 ? 'Mi·ªÖn ph√≠ üéâ' : formatPrice(shipping) + 'ƒë';
        document.getElementById('totalAmount').textContent = formatPrice(total) + 'ƒë';
        document.getElementById('btnTotal').textContent = formatPrice(total) + 'ƒë';

        if (currentDiscount > 0 || (currentPromoCode && promoCodes[currentPromoCode]?.type === 'shipping')) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('discountAmount').textContent = discount > 0 ? '-' + formatPrice(discount) + 'ƒë' : 'Mi·ªÖn ship';
        } else {
            document.getElementById('discountRow').style.display = 'none';
        }
    }

    function formatPrice(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Promo functions
    function usePromo(code) {
        document.getElementById('promoInput').value = code;
        applyPromo();
    }

    function applyPromo() {
        const code = document.getElementById('promoInput').value.toUpperCase().trim();
        if (!code) { showToast('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°', 'error'); return; }
        if (!promoCodes[code]) { showToast('M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá', 'error'); return; }

        const checkoutItems = JSON.parse(localStorage.getItem('checkoutItems') || '[]');
        const subtotal = checkoutItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const promo = promoCodes[code];

        if (subtotal < promo.min) {
            showToast(`ƒê∆°n t·ªëi thi·ªÉu ${formatPrice(promo.min)}ƒë`, 'error');
            return;
        }

        currentPromoCode = code;
        updateTotals();
        
        document.getElementById('promoApplied').style.display = 'flex';
        document.getElementById('promoAppliedText').textContent = `${code} - ${promo.desc}`;
        document.querySelector('.promo-input-wrapper').style.display = 'none';
        
        showToast(`√Åp d·ª•ng m√£ ${code} th√†nh c√¥ng!`, 'success');
    }

    function removePromo() {
        currentPromoCode = '';
        currentDiscount = 0;
        document.getElementById('promoInput').value = '';
        document.getElementById('promoApplied').style.display = 'none';
        document.querySelector('.promo-input-wrapper').style.display = 'flex';
        updateTotals();
    }

    // Payment selection
    document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            this.querySelector('input').checked = true;
            
            const method = this.dataset.method;
            document.getElementById('bankDetails').style.display = method === 'bank' ? 'block' : 'none';
            
            if (method === 'bank') updateTransferContent();
        });
    });

    function updateTransferContent() {
        const name = document.getElementById('customerName').value || 'TEN';
        const phone = document.getElementById('customerPhone').value || 'SDT';
        document.getElementById('transferContent').textContent = `${name} ${phone}`;
    }

    function copyText(text) {
        navigator.clipboard.writeText(text);
        showToast('ƒê√£ sao ch√©p: ' + text, 'success');
    }

    // Load user info
    function loadUserInfo() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.name) document.getElementById('customerName').value = user.name;
        if (user.phone) document.getElementById('customerPhone').value = user.phone;
        if (user.address) document.getElementById('customerAddress').value = user.address;
    }

    // Place order
    function placeOrder() {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        const address = document.getElementById('customerAddress').value.trim();
        const note = document.getElementById('orderNote').value.trim();
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        if (!name) { showToast('Vui l√≤ng nh·∫≠p h·ªç t√™n', 'error'); return; }
        if (!phone || !/^0\d{9}$/.test(phone)) { showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá', 'error'); return; }
        if (!address) { showToast('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ', 'error'); return; }

        const btn = document.getElementById('btnPlaceOrder');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

        const checkoutItems = JSON.parse(localStorage.getItem('checkoutItems') || '[]');
        const subtotal = checkoutItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const shipping = subtotal >= FREE_SHIP_THRESHOLD ? 0 : SHIPPING_FEE;
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        const paymentNames = { 'cod': 'Ti·ªÅn m·∫∑t (COD)', 'momo': 'V√≠ MoMo', 'zalopay': 'ZaloPay', 'bank': 'Chuy·ªÉn kho·∫£n' };

        fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customerId: user.id || null,
                customerName: name,
                phone: phone,
                address: address,
                subtotal: subtotal,
                shippingFee: shipping,
                discount: currentDiscount,
                paymentMethod: paymentNames[paymentMethod],
                note: note,
                storeId: selectedStore?.id,
                items: checkoutItems.map(item => ({
                    productId: item.productId || 1,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    spicyLevel: item.spicyLevel || 0,
                    brothType: item.broth || null
                }))
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Remove checked items from cart
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const checkoutCodes = checkoutItems.map(i => i.code);
                cart = cart.filter(item => !checkoutCodes.includes(item.code));
                localStorage.setItem('cart', JSON.stringify(cart));
                localStorage.removeItem('checkoutItems');
                
                localStorage.setItem('lastOrder', JSON.stringify({
                    orderCode: data.data.orderCode,
                    total: subtotal + shipping - currentDiscount,
                    items: checkoutItems
                }));
                
                showToast('ƒê·∫∑t h√†ng th√†nh c√¥ng!', 'success');
                setTimeout(() => { window.location.href = '/DatHangThanhCong/' + data.data.orderCode; }, 1000);
            } else {
                showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i><span>ƒê·∫∑t h√†ng</span><span class="order-total" id="btnTotal">' + document.getElementById('totalAmount').textContent + '</span>';
            }
        })
        .catch(err => {
            const orderCode = 'DH' + Date.now().toString().slice(-8);
            localStorage.removeItem('checkoutItems');
            showToast('ƒê·∫∑t h√†ng th√†nh c√¥ng!', 'success');
            setTimeout(() => { window.location.href = '/DatHangThanhCong/' + orderCode; }, 1000);
        });
    }

    // Toast
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type + ' show';
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Init
    loadCheckoutItems();
    document.getElementById('customerName')?.addEventListener('input', updateTransferContent);
    document.getElementById('customerPhone')?.addEventListener('input', updateTransferContent);
</script>
}
