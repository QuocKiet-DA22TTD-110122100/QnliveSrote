@page
@model ThucDonModel
@{
    ViewData["Title"] = "Th·ª±c ƒë∆°n";
}

<section class="menu-page">
    <div class="container">
        <!-- Header -->
        <div class="menu-header">
            <h1 class="page-title">üçú Th·ª±c ƒë∆°n</h1>
            <p class="page-subtitle">Kh√°m ph√° h∆°n 100 m√≥n ƒÉn ƒëa d·∫°ng t·∫°i M·ª≥ Cay Sasin</p>
        </div>

        <!-- Filter & Search -->
        <div class="menu-filters">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." />
            </div>
            <div class="category-tabs">
                <button class="tab-btn active" data-category="all">T·∫•t c·∫£</button>
                <button class="tab-btn" data-category="mi-cay">üå∂Ô∏è M√¨ Cay</button>
                <button class="tab-btn" data-category="mi-tuong-den">ü•¢ M√¨ T∆∞∆°ng ƒêen</button>
                <button class="tab-btn" data-category="mi-xao">üçù M√¨ X√†o</button>
                <button class="tab-btn" data-category="mon-khac">üçö M√≥n Kh√°c</button>
                <button class="tab-btn" data-category="mon-them">ü•¢ M√≥n Th√™m M√¨</button>
                <button class="tab-btn" data-category="lau">üç≤ L·∫©u</button>
                <button class="tab-btn" data-category="mon-them-lau">ü•ò M√≥n Th√™m L·∫©u</button>
                <button class="tab-btn" data-category="khai-vi">üçü Khai V·ªã</button>
                <button class="tab-btn" data-category="combo">üéÅ Combo</button>
                <button class="tab-btn" data-category="giai-khat">ü•§ Gi·∫£i Kh√°t</button>
            </div>
        </div>

        <!-- Products Count -->
        <div class="products-count" style="margin-bottom: 20px; color: var(--gray);">
            Hi·ªÉn th·ªã <strong id="visibleCount">@Model.Products.Count</strong> / <strong>@Model.Products.Count</strong> s·∫£n ph·∫©m
        </div>

        <!-- Products Grid -->
        <div class="products-grid" id="productsGrid">
            @foreach (var product in Model.Products)
            {
                <div class="product-card" data-category="@product.CategorySlug" data-name="@product.Name.ToLower()" data-desc="@(product.Description?.ToLower() ?? "")">
                    <div class="product-image">
                        <img src="~/images/products/@product.Image" alt="@product.Name" loading="lazy" 
                             onerror="this.onerror=null; this.src='https://placehold.co/300x300/fff5f0/f97316?text=üçú'; this.style.objectFit='contain';" />
                        @if (product.IsBestSeller)
                        {
                            <span class="product-badge">Best Seller</span>
                        }
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">@product.Name</h3>
                        <p class="product-desc">@product.Description</p>
                        <div class="product-footer">
                            <span class="product-price">@product.Price</span>
                            <button class="btn-add" data-code="@product.Code" data-name="@product.Name" data-price="@product.PriceNumber" data-image="@product.Image" data-id="@product.Id" onclick="if(!checkLoginFirst()){return false;}addToCartFromBtn(this)">
                                <span>+</span> Th√™m
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Load More (optional) -->
        <div class="load-more" style="text-align: center; margin-top: 40px; display: none;" id="loadMore">
            <button class="btn btn-outline" onclick="loadMoreProducts()">
                Xem th√™m s·∫£n ph·∫©m <i class="fas fa-chevron-down"></i>
            </button>
        </div>
    </div>
</section>

<!-- Product Options Modal -->
<div class="product-modal-overlay" id="productModal">
    <div class="product-modal">
        <button class="modal-close-btn" onclick="closeProductModal()">√ó</button>
        
        <div class="modal-product-info">
            <img id="modalProductImage" src="" alt="" />
            <div class="modal-product-details">
                <h2 id="modalProductName"></h2>
                <p id="modalProductDesc"></p>
                <div class="modal-product-price">
                    <span id="modalProductPrice"></span>
                </div>
            </div>
        </div>

        <!-- Lo·∫°i n∆∞·ªõc d√πng (ch·ªâ cho m√¨ cay) -->
        <div class="modal-option-group" id="brothTypeGroup">
            <h4>üçú Ch·ªçn lo·∫°i n∆∞·ªõc d√πng</h4>
            <div class="option-buttons">
                <button class="option-btn active" data-value="kimchi" onclick="selectOption(this, 'broth')">
                    <span class="option-icon">ü•¨</span>
                    <span>Kim Chi</span>
                </button>
                <button class="option-btn" data-value="soyum" onclick="selectOption(this, 'broth')">
                    <span class="option-icon">üç≤</span>
                    <span>Soyum</span>
                </button>
                <button class="option-btn" data-value="sincay" onclick="selectOption(this, 'broth')">
                    <span class="option-icon">üî•</span>
                    <span>Sincay</span>
                </button>
            </div>
        </div>

        <!-- C·∫•p ƒë·ªô cay (ch·ªâ cho m√¨ cay) -->
        <div class="modal-option-group" id="spicyLevelGroup">
            <h4>üå∂Ô∏è Ch·ªçn c·∫•p ƒë·ªô cay (1-10)</h4>
            <div class="spicy-slider">
                <input type="range" id="spicyLevel" min="1" max="10" value="3" oninput="updateSpicyDisplay(this.value)" />
                <div class="spicy-display">
                    <span class="spicy-number" id="spicyNumber">3</span>
                    <span class="spicy-text" id="spicyText">Cay v·ª´a</span>
                    <span class="spicy-peppers" id="spicyPeppers">üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è</span>
                </div>
            </div>
            <div class="spicy-labels">
                <span>1 - Kh√¥ng cay</span>
                <span>10 - Si√™u cay</span>
            </div>
        </div>

        <!-- S·ªë l∆∞·ª£ng -->
        <div class="modal-option-group">
            <h4>üì¶ S·ªë l∆∞·ª£ng</h4>
            <div class="quantity-selector">
                <button class="qty-btn" onclick="changeQuantity(-1)">‚àí</button>
                <input type="number" id="modalQuantity" value="1" min="1" max="99" readonly />
                <button class="qty-btn" onclick="changeQuantity(1)">+</button>
            </div>
        </div>

        <!-- T·ªïng ti·ªÅn v√† n√∫t th√™m -->
        <div class="modal-footer">
            <div class="modal-total">
                <span>T·ªïng ti·ªÅn:</span>
                <span class="total-price" id="modalTotalPrice">0ƒë</span>
            </div>
            <button class="btn-add-to-cart" onclick="confirmAddToCart()">
                <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè h√†ng
            </button>
        </div>
    </div>
</div>

<!-- Login Required Modal -->
<div class="login-modal-overlay" id="loginRequiredModal">
    <div class="login-modal">
        <button class="modal-close" onclick="closeLoginRequired()">√ó</button>
        <div class="login-modal-icon">üîê</div>
        <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng v√† ƒë·∫∑t m√≥n.</p>
        <div class="login-modal-buttons">
            <a href="/DangNhap?returnUrl=/ThucDon" class="btn-login">
                <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
            </a>
            <a href="/DangKy?returnUrl=/ThucDon" class="btn-register">
                <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
            </a>
        </div>
    </div>
</div>

<style>
/* Product Modal */
.product-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
}
.product-modal-overlay.active {
    display: flex;
}
.product-modal {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalSlideIn 0.3s ease;
}
@@keyframes modalSlideIn {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.modal-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 10;
}
.modal-close-btn:hover {
    background: #ef4444;
    color: white;
}
.modal-product-info {
    display: flex;
    gap: 20px;
    padding: 25px;
    border-bottom: 1px solid #e5e7eb;
}
.modal-product-info img {
    width: 120px;
    height: 120px;
    object-fit: contain;
    border-radius: 12px;
    background: #f8f8f8;
}
.modal-product-details {
    flex: 1;
}
.modal-product-details h2 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: #1f2937;
}
.modal-product-details p {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 10px;
    line-height: 1.5;
}
.modal-product-price {
    font-size: 1.4rem;
    font-weight: 800;
    color: #f97316;
}
.modal-option-group {
    padding: 20px 25px;
    border-bottom: 1px solid #e5e7eb;
}
.modal-option-group h4 {
    font-size: 1rem;
    margin-bottom: 15px;
    color: #1f2937;
}
.option-buttons {
    display: flex;
    gap: 10px;
}
.option-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid #e5e7eb;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.option-btn:hover {
    border-color: #f97316;
}
.option-btn.active {
    border-color: #f97316;
    background: #fff7ed;
}
.option-icon {
    font-size: 1.5rem;
}
.option-btn span:last-child {
    font-size: 0.85rem;
    font-weight: 600;
}
/* Spicy Slider */
.spicy-slider {
    margin-bottom: 10px;
}
.spicy-slider input[type="range"] {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(to right, #fef3c7, #f97316, #dc2626);
    outline: none;
    -webkit-appearance: none;
}
.spicy-slider input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    background: white;
    border: 3px solid #f97316;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.spicy-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
    padding: 15px;
    background: #fef3c7;
    border-radius: 12px;
}
.spicy-number {
    font-size: 2rem;
    font-weight: 800;
    color: #f97316;
}
.spicy-text {
    font-weight: 600;
    color: #92400e;
}
.spicy-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 8px;
}
/* Quantity Selector */
.quantity-selector {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}
.quantity-selector .qty-btn {
    width: 45px;
    height: 45px;
    border: 2px solid #e5e7eb;
    background: white;
    border-radius: 12px;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
}
.quantity-selector .qty-btn:hover {
    border-color: #f97316;
    background: #fff7ed;
}
.quantity-selector input {
    width: 80px;
    height: 45px;
    text-align: center;
    font-size: 1.3rem;
    font-weight: 700;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
}
/* Modal Footer */
.modal-footer {
    padding: 20px 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    background: #f9fafb;
    border-radius: 0 0 20px 20px;
}
.modal-total {
    display: flex;
    flex-direction: column;
}
.modal-total span:first-child {
    font-size: 0.85rem;
    color: #6b7280;
}
.total-price {
    font-size: 1.5rem;
    font-weight: 800;
    color: #f97316;
}
.btn-add-to-cart {
    padding: 15px 30px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}
.btn-add-to-cart:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249,115,22,0.4);
}

/* Toast Notification */
.toast-message {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 16px 30px;
    border-radius: 12px;
    font-weight: 600;
    z-index: 9999;
    animation: toastSlide 0.3s ease;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
}
@@keyframes toastSlide {
    from { transform: translateX(-50%) translateY(20px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* Login Required Modal */
.login-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    padding: 20px;
}
.login-modal-overlay.active {
    display: flex;
}
.login-modal {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    max-width: 420px;
    width: 100%;
    position: relative;
    animation: modalSlideIn 0.3s ease;
}
.login-modal .modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
}
.login-modal .modal-close:hover {
    background: #ef4444;
    color: white;
}
.login-modal-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}
.login-modal h2 {
    font-size: 1.5rem;
    color: #1f2937;
    margin-bottom: 15px;
}
.login-modal p {
    color: #6b7280;
    margin-bottom: 25px;
    line-height: 1.6;
}
.login-modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}
.login-modal-buttons a {
    padding: 14px 28px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.btn-login {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}
.btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249,115,22,0.4);
}
.btn-register {
    background: #f3f4f6;
    color: #374151;
}
.btn-register:hover {
    background: #e5e7eb;
}
</style>

@section Scripts {
<script>
    // KI·ªÇM TRA ƒêƒÇNG NH·∫¨P - H√ÄM N√ÄY CH·∫†Y ƒê·∫¶U TI√äN
    function checkLoginFirst() {
        const userStr = localStorage.getItem('user');
        if (!userStr || userStr === 'null' || userStr === '{}') {
            showLoginModal();
            return false;
        }
        try {
            const user = JSON.parse(userStr);
            if (!user || !user.username) {
                showLoginModal();
                return false;
            }
            return true;
        } catch(e) {
            showLoginModal();
            return false;
        }
    }
    
    // Hi·ªán modal y√™u c·∫ßu ƒëƒÉng nh·∫≠p
    function showLoginModal() {
        const modal = document.getElementById('loginRequiredModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    let allCards = document.querySelectorAll('.product-card');
    
    // Current product for modal
    let currentProduct = {
        code: '',
        name: '',
        price: 0,
        image: '',
        category: '',
        broth: 'kimchi',
        spicyLevel: 3,
        quantity: 1
    };
    
    // Filter by category
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const category = this.dataset.category;
            filterProducts();
        });
    });

    // Search with debounce
    let menuSearchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(menuSearchTimeout);
        menuSearchTimeout = setTimeout(() => filterProducts(), 300);
    });

    function filterProducts() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const activeTab = document.querySelector('.tab-btn.active');
        const category = activeTab ? activeTab.dataset.category : 'all';
        
        let visibleCount = 0;
        
        allCards.forEach(card => {
            const name = card.dataset.name;
            const desc = card.dataset.desc;
            const cardCategory = card.dataset.category;
            
            const matchSearch = !search || name.includes(search) || desc.includes(search);
            const matchCategory = category === 'all' || cardCategory === category;
            
            if (matchSearch && matchCategory) {
                card.style.display = 'flex';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        document.getElementById('visibleCount').textContent = visibleCount;
    }

    // Check if product is M√¨ Cay
    function isMiCay(code, name) {
        const nameLower = name.toLowerCase();
        return nameLower.includes('m√¨') || nameLower.includes('mi ') || 
               nameLower.includes('m·ª≥') || nameLower.includes('my ');
    }

    // Add to cart from button (using data attributes)
    function addToCartFromBtn(btn) {
        console.log('Button clicked - addToCartFromBtn');
        
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p ngay t·∫°i ƒë√¢y
        if (!isLoggedIn()) {
            console.log('Not logged in - blocking add to cart');
            showLoginRequired();
            return; // STOP - kh√¥ng cho th√™m
        }
        
        const code = btn.dataset.code;
        const name = btn.dataset.name;
        const price = btn.dataset.price;
        const image = btn.dataset.image;
        const productId = btn.dataset.id || 0;
        addToCart(code, name, price, image, productId);
    }

    // Check if user is logged in - ki·ªÉm tra ch·∫∑t ch·∫Ω
    function isLoggedIn() {
        try {
            const userStr = localStorage.getItem('user');
            if (!userStr || userStr === 'null' || userStr === '{}') {
                console.log('User not logged in: no user data');
                return false;
            }
            const user = JSON.parse(userStr);
            const loggedIn = user && user.username && user.username.length > 0;
            console.log('Login check:', loggedIn ? 'Logged in as ' + user.username : 'Not logged in');
            return loggedIn;
        } catch (e) {
            console.log('Login check error:', e);
            return false;
        }
    }

    // Show login required modal
    function showLoginRequired() {
        console.log('Showing login required modal');
        document.getElementById('loginRequiredModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // Close login required modal
    function closeLoginRequired() {
        document.getElementById('loginRequiredModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Add to cart - check if M√¨ Cay to show modal
    function addToCart(code, name, price, image, productId) {
        console.log('addToCart called - checking login...');
        
        // Check login first - QUAN TR·ªåNG
        if (!isLoggedIn()) {
            console.log('User not logged in - showing modal');
            showLoginRequired();
            return; // STOP HERE - kh√¥ng th√™m v√†o gi·ªè
        }
        
        console.log('User is logged in - proceeding to add');
        
        console.log('Adding to cart:', code, name, price, image, productId);
        
        // Get category from card by code
        const cards = document.querySelectorAll('.product-card');
        let category = '';
        cards.forEach(card => {
            const btn = card.querySelector('.btn-add');
            if (btn && btn.dataset.code === code) {
                category = card.dataset.category;
            }
        });
        
        // If it's M√¨ Cay, show modal for options
        if (isMiCay(code, name) || category === 'mi-cay') {
            openProductModal(code, name, price, image, category, productId);
        } else {
            // Direct add to cart for non-M√¨ Cay items
            addToCartDirect(code, name, price, image, null, null, 1, productId);
        }
    }

    // Open product modal
    function openProductModal(code, name, price, image, category, productId) {
        currentProduct = {
            code: code,
            name: name,
            price: parseFloat(price),
            image: image,
            category: category,
            productId: parseInt(productId) || 0,
            broth: 'kimchi',
            spicyLevel: 3,
            quantity: 1
        };
        
        // Update modal content
        document.getElementById('modalProductImage').src = '/images/products/' + image;
        document.getElementById('modalProductName').textContent = name;
        document.getElementById('modalProductDesc').textContent = 'M√≥n ƒÉn ƒë·∫∑c tr∆∞ng c·ªßa M·ª≥ Cay Sasin';
        document.getElementById('modalProductPrice').textContent = formatPrice(currentProduct.price);
        
        // Reset options
        document.getElementById('spicyLevel').value = 3;
        document.getElementById('modalQuantity').value = 1;
        updateSpicyDisplay(3);
        
        // Reset broth selection
        document.querySelectorAll('#brothTypeGroup .option-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.value === 'kimchi') btn.classList.add('active');
        });
        
        // Show/hide options based on category
        const isMiCayProduct = isMiCay(code, name) || category === 'mi-cay';
        document.getElementById('brothTypeGroup').style.display = isMiCayProduct ? 'block' : 'none';
        document.getElementById('spicyLevelGroup').style.display = isMiCayProduct ? 'block' : 'none';
        
        // Update total price
        updateTotalPrice();
        
        // Show modal
        document.getElementById('productModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // Close product modal
    function closeProductModal() {
        document.getElementById('productModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Select option (broth type)
    function selectOption(btn, type) {
        const group = btn.closest('.option-buttons');
        group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (type === 'broth') {
            currentProduct.broth = btn.dataset.value;
        }
    }

    // Update spicy level display
    function updateSpicyDisplay(value) {
        const level = parseInt(value);
        currentProduct.spicyLevel = level;
        
        document.getElementById('spicyNumber').textContent = level;
        
        // Update text description
        let text = '';
        if (level <= 2) text = 'Kh√¥ng cay';
        else if (level <= 4) text = 'Cay nh·∫π';
        else if (level <= 6) text = 'Cay v·ª´a';
        else if (level <= 8) text = 'Cay nhi·ªÅu';
        else text = 'Si√™u cay';
        document.getElementById('spicyText').textContent = text;
        
        // Update pepper icons
        let peppers = '';
        for (let i = 0; i < level; i++) {
            peppers += 'üå∂Ô∏è';
        }
        document.getElementById('spicyPeppers').textContent = peppers;
        
        // Update slider background color
        const slider = document.getElementById('spicyLevel');
        const percent = ((level - 1) / 9) * 100;
        slider.style.background = `linear-gradient(to right, #fef3c7 0%, #f97316 ${percent}%, #dc2626 100%)`;
    }

    // Change quantity
    function changeQuantity(delta) {
        let qty = parseInt(document.getElementById('modalQuantity').value) + delta;
        if (qty < 1) qty = 1;
        if (qty > 99) qty = 99;
        
        document.getElementById('modalQuantity').value = qty;
        currentProduct.quantity = qty;
        updateTotalPrice();
    }

    // Update total price
    function updateTotalPrice() {
        const total = currentProduct.price * currentProduct.quantity;
        document.getElementById('modalTotalPrice').textContent = formatPrice(total);
    }

    // Format price
    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price) + 'ƒë';
    }

    // Confirm add to cart from modal
    function confirmAddToCart() {
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p l·∫ßn n·ªØa ƒë·ªÉ ch·∫Øc ch·∫Øn
        if (!isLoggedIn()) {
            closeProductModal();
            showLoginRequired();
            return;
        }
        
        const broth = currentProduct.broth;
        const spicy = currentProduct.spicyLevel;
        const qty = currentProduct.quantity;
        
        // Get broth name
        const brothNames = { kimchi: 'Kim Chi', soyum: 'Soyum', sincay: 'Sincay' };
        const brothName = brothNames[broth] || broth;
        
        addToCartDirect(
            currentProduct.code, 
            currentProduct.name, 
            currentProduct.price, 
            currentProduct.image,
            brothName,
            spicy,
            qty,
            currentProduct.productId
        );
        
        closeProductModal();
    }

    // Get or create session ID for guest users
    function getSessionId() {
        let sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('sessionId', sessionId);
        }
        return sessionId;
    }

    // Get customer ID if logged in
    function getCustomerId() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        return user.id || null;
    }

    // Direct add to cart - save to both localStorage and API
    function addToCartDirect(code, name, price, image, broth, spicyLevel, quantity, productId) {
        // Save to localStorage for immediate UI update
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        const existing = cart.find(item => {
            if (broth) {
                return item.code === code && item.broth === broth && item.spicyLevel === spicyLevel;
            }
            return item.code === code && !item.broth;
        });
        
        if (existing) {
            existing.quantity += quantity;
        } else {
            const cartItem = { 
                code, 
                name, 
                price: parseFloat(price), 
                image: image,
                quantity: quantity,
                productId: parseInt(productId) || 0
            };
            
            if (broth) {
                cartItem.broth = broth;
                cartItem.spicyLevel = spicyLevel;
                cartItem.displayName = `${name} (${broth}, C·∫•p ${spicyLevel})`;
            }
            
            cart.push(cartItem);
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        
        // Also save to API backend
        const customerId = getCustomerId();
        const sessionId = getSessionId();
        
        // Use actual productId from database
        const actualProductId = parseInt(productId) || 1;
        
        fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customerId: customerId,
                sessionId: sessionId,
                productId: actualProductId,
                quantity: quantity,
                spicyLevel: spicyLevel || 0,
                brothType: broth || null,
                note: null
            })
        }).then(res => res.json())
          .then(data => console.log('Cart API:', data))
          .catch(err => console.log('Cart API error (using localStorage):', err));
        
        let message = '‚úì ƒê√£ th√™m "' + name + '"';
        if (broth) {
            message += ` (${broth}, C·∫•p ${spicyLevel})`;
        }
        message += ' v√†o gi·ªè h√†ng!';
        showToast(message);
        
        // Animate cart badge
        const badge = document.getElementById('cartCount');
        if (badge) {
            badge.style.transform = 'scale(1.3)';
            setTimeout(() => badge.style.transform = 'scale(1)', 200);
        }
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        const badge = document.getElementById('cartCount');
        if (badge) badge.textContent = count;
    }

    function showToast(message) {
        // Remove existing toast
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.innerHTML = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Close modal on overlay click
    document.getElementById('productModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeProductModal();
        }
    });

    // Close login modal on overlay click
    document.getElementById('loginRequiredModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLoginRequired();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeProductModal();
            closeLoginRequired();
        }
    });

    updateCartCount();
</script>
}
